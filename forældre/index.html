<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Flango For√¶ldre-portal</title>

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@700&family=Nunito:wght@400;600;700&display=swap"
    rel="stylesheet"
  />

  <style>
    :root {
      --primary-color: #ff7a3c;
      --primary-color-soft: rgba(255, 122, 60, 0.12);
      --secondary-color: #3c7dff;
      --secondary-soft: rgba(60, 125, 255, 0.12);
      --accent-color: #ffc857;
      --background-gradient: radial-gradient(circle at top left, #ffe1c7 0, #f5f7ff 40%, #dfe8ff 100%);
      --card-bg: rgba(255, 255, 255, 0.88);
      --border-soft: rgba(255, 255, 255, 0.6);
      --shadow-soft: 0 18px 45px rgba(15, 23, 42, 0.18);
      --success-color: #28a745;
      --danger-color: #dc3545;
      --warning-color: #ffb100;
      --font-body: "Nunito", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      --font-heading: "Baloo 2", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: var(--font-body);
      background: var(--background-gradient);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 18px;
      color: #111827;
    }

    .page-wrapper {
      max-width: 960px;
      width: 100%;
    }

    .logo-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 18px;
    }

    .logo {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-family: var(--font-heading);
      font-size: 24px;
      font-weight: 700;
      color: #111827;
    }

    .logo-badge {
      width: 34px;
      height: 34px;
      border-radius: 14px;
      background: linear-gradient(135deg, #ff9d5a, #ff7a3c);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-size: 18px;
      box-shadow: 0 12px 25px rgba(249, 115, 22, 0.35);
    }

    .logo-text-main {
      display: flex;
      flex-direction: column;
      line-height: 1;
    }

    .logo-name {
      font-size: 20px;
      letter-spacing: 0.02em;
    }

    .logo-tagline {
      font-size: 11px;
      color: #6b7280;
      margin-top: 3px;
    }

    .top-tag {
      font-size: 12px;
      color: #6b7280;
      background: rgba(255, 255, 255, 0.5);
      padding: 6px 10px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border: 1px solid rgba(255, 255, 255, 0.7);
      box-shadow: 0 10px 25px rgba(148, 163, 184, 0.18);
    }

    .top-tag .dot {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: #22c55e;
      box-shadow: 0 0 0 5px rgba(34, 197, 94, 0.22);
    }

    .container {
      background: var(--card-bg);
      border-radius: 26px;
      padding: 28px 22px 24px;
      box-shadow: var(--shadow-soft);
      border: 1px solid var(--border-soft);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      position: relative;
      overflow: hidden;
    }

    .container::before,
    .container::after {
      content: "";
      position: absolute;
      border-radius: 999px;
      filter: blur(0);
      opacity: 0.7;
      pointer-events: none;
    }

    .container::before {
      width: 220px;
      height: 220px;
      background: radial-gradient(circle, rgba(60, 125, 255, 0.16), transparent 60%);
      top: -90px;
      right: -100px;
    }

    .container::after {
      width: 180px;
      height: 180px;
      background: radial-gradient(circle, rgba(255, 122, 60, 0.16), transparent 60%);
      bottom: -70px;
      left: -80px;
    }

    .container-inner {
      position: relative;
      z-index: 1;
      display: grid;
      grid-template-columns: minmax(0, 1.25fr) minmax(0, 1.1fr);
      gap: 24px;
      align-items: stretch;
    }

    .intro-section {
      padding-right: 4px;
    }

    .title-row {
      display: flex;
      flex-wrap: wrap;
      align-items: flex-start;
      gap: 8px 10px;
      margin-bottom: 6px;
    }

    h1 {
      font-family: var(--font-heading);
      font-size: clamp(24px, 3vw, 28px);
      font-weight: 700;
      letter-spacing: 0.02em;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    h1 span.highlight {
      background: linear-gradient(120deg, #ff7a3c, #ffb100);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }

    .subtitle {
      font-size: 14px;
      color: #4b5563;
      margin-bottom: 18px;
      max-width: 400px;
    }

    .pill-tag {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: rgba(255, 255, 255, 0.9);
      padding: 6px 11px;
      border-radius: 999px;
      border: 1px solid rgba(226, 232, 240, 0.9);
      font-size: 12px;
      color: #4b5563;
      box-shadow: 0 10px 25px rgba(148, 163, 184, 0.22);
    }

    .pill-dot {
      width: 9px;
      height: 9px;
      border-radius: 999px;
      background: linear-gradient(135deg, #3c7dff, #22c55e);
      box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.22);
    }

    .info-cards {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
      margin-bottom: 18px;
    }

    .info-card {
      background: linear-gradient(135deg, rgba(60, 125, 255, 0.08), rgba(255, 255, 255, 0.95));
      border-radius: 16px;
      padding: 11px 12px 10px;
      border: 1px solid rgba(226, 232, 240, 0.9);
      box-shadow: 0 12px 25px rgba(148, 163, 184, 0.22);
      display: grid;
      grid-template-columns: auto 1fr;
      gap: 8px;
      align-items: flex-start;
    }

    .info-icon {
      width: 34px;
      height: 34px;
      border-radius: 999px;
      background: rgba(59, 130, 246, 0.08);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }

    .info-content {
      font-size: 12px;
      color: #374151;
    }

    .info-content strong {
      display: block;
      font-size: 13px;
      margin-bottom: 2px;
      color: #111827;
    }

    .help-text {
      font-size: 12px;
      color: #6b7280;
      margin-bottom: 6px;
    }

    .help-text strong {
      color: #111827;
    }

    .login-section {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 20px;
      padding: 18px 18px 16px;
      border: 1px solid rgba(226, 232, 240, 0.9);
      box-shadow: 0 16px 30px rgba(15, 23, 42, 0.12);
      position: relative;
      overflow: hidden;
    }

    .login-section::before {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at top right, rgba(60, 125, 255, 0.08), transparent 55%);
      pointer-events: none;
    }

    .login-inner {
      position: relative;
      z-index: 1;
    }

    .section-title {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 15px;
      font-weight: 700;
      margin-bottom: 4px;
      color: #111827;
    }

    .section-title .icon {
      width: 30px;
      height: 30px;
      border-radius: 999px;
      background: rgba(255, 122, 60, 0.12);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }

    .section-subtitle {
      font-size: 13px;
      color: #6b7280;
      margin-bottom: 10px;
    }

    .login-form {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .login-form label.section-subtitle {
      margin-bottom: 4px;
    }

    .login-form input,
    .login-form select {
      border-radius: 999px;
      border: 1px solid #d1d5db;
      padding: 9px 14px;
      font-size: 14px;
      outline: none;
      transition: border-color 0.15s ease, box-shadow 0.15s ease, background-color 0.15s ease;
      background: rgba(249, 250, 251, 0.95);
      width: 100%;
    }

    .login-form input:focus,
    .login-form select:focus {
      border-color: #3b82f6;
      box-shadow: 0 0 0 1px rgba(59, 130, 246, 0.25);
      background: #ffffff;
    }

    .login-form input::placeholder {
      color: #9ca3af;
      font-size: 13px;
    }

    .login-form select {
      font-size: 13px;
    }

    .login-form button {
      margin-top: 4px;
      border-radius: 999px;
      border: none;
      padding: 10px 16px;
      font-size: 14px;
      font-weight: 600;
      background: linear-gradient(135deg, #ff7a3c, #ffb100);
      color: white;
      cursor: pointer;
      transition: transform 0.12s ease, box-shadow 0.12s ease, filter 0.12s ease;
      box-shadow: 0 14px 25px rgba(248, 113, 22, 0.4);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .login-form button:hover {
      transform: translateY(-1px);
      box-shadow: 0 18px 32px rgba(248, 113, 22, 0.5);
      filter: brightness(1.03);
    }

    .login-form button:active {
      transform: translateY(0);
      box-shadow: 0 10px 20px rgba(248, 113, 22, 0.35);
      filter: brightness(0.98);
    }

    .login-form button:disabled {
      opacity: 0.7;
      cursor: default;
      box-shadow: none;
      transform: none;
    }

    .error-message {
      color: var(--danger-color);
      font-size: 12px;
      margin-top: 4px;
    }

    .login-help {
      margin-top: 10px;
      font-size: 12px;
      color: #6b7280;
      line-height: 1.45;
    }

    .login-help strong {
      color: #111827;
    }

    .results-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
      gap: 10px;
    }

    .child-info {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .child-name {
      font-size: 16px;
      font-weight: 700;
    }

    .balance-chip {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      border-radius: 999px;
      padding: 7px 14px;
      background: rgba(249, 250, 251, 0.96);
      border: 1px solid rgba(226, 232, 240, 0.85);
      font-size: 13px;
      color: #111827;
    }

    .balance-dot {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.22);
    }

    .balance-dot.low {
      background: var(--warning-color);
      box-shadow: 0 0 0 4px rgba(251, 191, 36, 0.25);
    }

    .balance-dot.negative {
      background: var(--danger-color);
      box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.25);
    }

    .balance-label {
      font-size: 12px;
      color: #4b5563;
    }

    .balance-amount {
      font-weight: 700;
      font-size: 14px;
    }

    .logout-button {
      border-radius: 999px;
      padding: 6px 11px;
      border: 1px solid rgba(226, 232, 240, 0.9);
      background: rgba(248, 250, 252, 0.96);
      font-size: 12px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      color: #4b5563;
      transition: background 0.12s ease, box-shadow 0.12s ease, transform 0.12s ease;
      box-shadow: 0 10px 20px rgba(148, 163, 184, 0.18);
    }

    .logout-button:hover {
      background: #ffffff;
      transform: translateY(-1px);
      box-shadow: 0 14px 28px rgba(148, 163, 184, 0.24);
    }

    .logout-button span {
      font-size: 14px;
    }

    .history-card {
      margin-top: 4px;
      background: rgba(249, 250, 251, 0.98);
      border-radius: 16px;
      padding: 10px 12px;
      border: 1px solid rgba(226, 232, 240, 0.9);
      box-shadow: 0 12px 24px rgba(148, 163, 184, 0.18);
      max-height: 260px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .history-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }

    .history-title {
      font-size: 13px;
      font-weight: 600;
      color: #111827;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .history-title .badge {
      font-size: 10px;
      padding: 3px 7px;
      border-radius: 999px;
      background: rgba(59, 130, 246, 0.08);
      color: #2563eb;
      border: 1px solid rgba(191, 219, 254, 0.9);
    }

    .history-summary {
      font-size: 11px;
      color: #6b7280;
    }

    .history-list {
      list-style: none;
      margin: 0;
      padding: 0;
      overflow-y: auto;
      max-height: 200px;
      scrollbar-width: thin;
      scrollbar-color: rgba(148, 163, 184, 0.7) transparent;
    }

    .history-list::-webkit-scrollbar {
      width: 6px;
    }

    .history-list::-webkit-scrollbar-track {
      background: transparent;
    }

    .history-list::-webkit-scrollbar-thumb {
      background-color: rgba(148, 163, 184, 0.85);
      border-radius: 999px;
    }

    .history-item {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      padding: 6px 4px;
      border-bottom: 1px dashed rgba(209, 213, 219, 0.9);
      font-size: 12px;
      gap: 6px;
    }

    .history-item:last-child {
      border-bottom: none;
    }

    .history-main {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .history-row {
      display: flex;
      justify-content: space-between;
      gap: 6px;
    }

    .history-date {
      font-size: 11px;
      color: #6b7280;
    }

    .history-type {
      font-size: 11px;
      padding: 2px 7px;
      border-radius: 999px;
      border: 1px solid rgba(209, 213, 219, 0.9);
      background: rgba(249, 250, 251, 0.95);
      color: #4b5563;
    }

    .history-desc {
      font-size: 12px;
      color: #111827;
    }

    .history-meta {
      font-size: 11px;
      color: #6b7280;
    }

    .history-amount {
      font-weight: 700;
      font-size: 13px;
      text-align: right;
      min-width: 68px;
    }

    .history-amount.sale {
      color: #dc2626;
    }

    .history-amount.deposit {
      color: #15803d;
    }

    .payment-card {
      margin-top: 12px;
      background: rgba(255, 255, 255, 0.96);
      border-radius: 16px;
      padding: 10px 12px 11px;
      border: 1px solid rgba(226, 232, 240, 0.9);
      box-shadow: 0 12px 24px rgba(148, 163, 184, 0.18);
    }

    .payment-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 6px;
    }

    .payment-title {
      font-size: 13px;
      font-weight: 600;
      color: #0f172a;
      display: flex;
      align-items: center;
      gap: 7px;
    }

    .payment-title .icon {
      width: 24px;
      height: 24px;
      border-radius: 999px;
      background: rgba(255, 122, 60, 0.12);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }

    .payment-subtitle {
      font-size: 11px;
      color: #6b7280;
      margin-bottom: 8px;
    }

    .payment-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
    }

    .payment-option {
      border-radius: 14px;
      padding: 10px 10px 9px;
      border: 1px solid rgba(226, 232, 240, 0.95);
      background: rgba(255, 255, 255, 0.98);
      display: flex;
      flex-direction: column;
      gap: 6px;
      box-shadow: 0 10px 20px rgba(148, 163, 184, 0.14);
    }

    .payment-option.recommended {
      border-color: rgba(34, 197, 94, 0.35);
      background: linear-gradient(135deg, rgba(34, 197, 94, 0.08), rgba(255, 255, 255, 0.98));
    }

    .payment-option.secondary {
      border-color: rgba(245, 158, 11, 0.35);
      background: linear-gradient(135deg, rgba(245, 158, 11, 0.10), rgba(255, 255, 255, 0.98));
    }

    .payment-option-title {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      font-size: 12px;
      font-weight: 700;
      color: #111827;
    }

    .payment-option-title .left {
      display: inline-flex;
      align-items: center;
      gap: 7px;
      min-width: 0;
    }

    .payment-option-title .emoji {
      font-size: 16px;
    }

    .payment-badge {
      font-size: 10px;
      padding: 3px 7px;
      border-radius: 999px;
      border: 1px solid rgba(226, 232, 240, 0.95);
      background: rgba(249, 250, 251, 0.95);
      color: #4b5563;
      white-space: nowrap;
    }

    .payment-badge.good {
      border-color: rgba(187, 247, 208, 0.9);
      background: rgba(22, 163, 74, 0.10);
      color: #15803d;
    }

    .payment-badge.warn {
      border-color: rgba(252, 211, 77, 0.9);
      background: rgba(245, 158, 11, 0.12);
      color: #92400e;
    }

    .payment-body {
      font-size: 11px;
      color: #6b7280;
      line-height: 1.35;
    }

    .payment-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 2px;
      align-items: center;
    }

    .payment-amount {
      border-radius: 999px;
      border: 1px solid rgba(226, 232, 240, 0.95);
      background: rgba(255, 255, 255, 0.96);
      padding: 4px 10px;
      font-size: 11px;
      cursor: pointer;
      box-shadow: 0 8px 18px rgba(148, 163, 184, 0.16);
      transition: transform 0.12s ease, box-shadow 0.12s ease, background 0.12s ease;
    }

    .payment-amount:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 22px rgba(148, 163, 184, 0.2);
      background: #ffffff;
    }

    .payment-amount.is-active {
      background: rgba(34, 197, 94, 0.12);
      border-color: rgba(34, 197, 94, 0.45);
      color: #15803d;
      font-weight: 700;
    }

    .payment-row {
      display: flex;
      gap: 6px;
      align-items: center;
      margin-top: 2px;
    }

    .payment-row input[type="number"] {
      flex: 1;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      padding: 7px 12px;
      font-size: 12px;
      background: rgba(249, 250, 251, 0.98);
      outline: none;
    }

    .payment-row button {
      border-radius: 999px;
      border: none;
      padding: 7px 12px;
      font-size: 11px;
      font-weight: 700;
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: #fff;
      cursor: pointer;
      box-shadow: 0 10px 22px rgba(22, 163, 74, 0.35);
      white-space: nowrap;
    }

    .payment-row button:disabled {
      opacity: 0.7;
      cursor: default;
      box-shadow: none;
    }

    .payment-feedback {
      min-height: 14px;
      font-size: 11px;
      margin-top: 6px;
      color: #16a34a;
    }

    .payment-qr {
      width: 100%;
      max-width: 220px;
      border-radius: 14px;
      border: 1px solid rgba(226, 232, 240, 0.95);
      background: rgba(249, 250, 251, 0.98);
      box-shadow: 0 12px 24px rgba(148, 163, 184, 0.16);
      padding: 10px;
      display: none;
    }

    .payment-qr img {
      width: 100%;
      height: auto;
      display: block;
      border-radius: 10px;
    }

    .payment-qr-note {
      font-size: 10px;
      color: #6b7280;
      margin-top: 6px;
      line-height: 1.35;
    }

    @media (max-width: 780px) {
      .payment-grid {
        grid-template-columns: 1fr;
      }
    }

    .notify-card {
      margin-top: 12px;
      background: linear-gradient(135deg, rgba(56, 189, 248, 0.06), rgba(255, 255, 255, 0.98));
      border-radius: 16px;
      padding: 10px 12px 11px;
      border: 1px solid rgba(191, 219, 254, 0.95);
      box-shadow: 0 12px 24px rgba(148, 163, 184, 0.2);
    }

    .notify-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 6px;
      gap: 8px;
    }

    .notify-title {
      font-size: 13px;
      font-weight: 600;
      color: #0f172a;
      display: flex;
      align-items: center;
      gap: 7px;
    }

    .notify-title .icon {
      width: 24px;
      height: 24px;
      border-radius: 999px;
      background: rgba(34, 197, 94, 0.12);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }

    .notify-badge {
      font-size: 10px;
      padding: 3px 7px;
      border-radius: 999px;
      background: rgba(22, 163, 74, 0.1);
      color: #15803d;
      border: 1px solid rgba(187, 247, 208, 0.9);
    }

    .notify-body {
      display: grid;
      grid-template-columns: minmax(0, 1.2fr) minmax(0, 1.1fr);
      gap: 6px;
      align-items: flex-end;
    }

    .notify-body .field {
      display: flex;
      flex-direction: column;
      gap: 3px;
      font-size: 11px;
      color: #4b5563;
    }

    .notify-body label {
      font-size: 11px;
      color: #4b5563;
    }

    .notify-body input[type="email"] {
      border-radius: 999px;
      border: 1px solid #d1d5db;
      padding: 7px 12px;
      font-size: 12px;
      outline: none;
      background: rgba(249, 250, 251, 0.98);
      transition: border-color 0.15s ease, box-shadow 0.15s ease;
    }

    .notify-body input[type="email"]:focus {
      border-color: #22c55e;
      box-shadow: 0 0 0 1px rgba(34, 197, 94, 0.28);
      background: #ffffff;
    }

    .notify-options {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 4px;
      margin-bottom: 4px;
      font-size: 11px;
      color: #4b5563;
    }

    .notify-option {
      display: flex;
      align-items: center;
      gap: 5px;
      padding: 4px 6px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid rgba(226, 232, 240, 0.95);
    }

    .notify-option input[type="checkbox"] {
      accent-color: #22c55e;
      width: 13px;
      height: 13px;
    }

    .notify-save-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      font-size: 11px;
      margin-top: 4px;
    }

    .notify-save-row button {
      border-radius: 999px;
      padding: 6px 11px;
      border: none;
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: white;
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      box-shadow: 0 10px 22px rgba(22, 163, 74, 0.4);
      transition: transform 0.1s ease, box-shadow 0.1s ease, filter 0.1s ease;
    }

    .notify-save-row button:hover {
      transform: translateY(-1px);
      box-shadow: 0 14px 26px rgba(22, 163, 74, 0.48);
      filter: brightness(1.03);
    }

    .notify-save-row button:active {
      transform: translateY(0);
      box-shadow: 0 8px 16px rgba(22, 163, 74, 0.35);
      filter: brightness(0.97);
    }

    .notify-save-row button:disabled {
      opacity: 0.7;
      box-shadow: none;
      cursor: default;
    }

    .notify-feedback {
      font-size: 11px;
      color: #16a34a;
    }

    .footer-note {
      margin-top: 12px;
      font-size: 11px;
      color: #9ca3af;
      text-align: center;
    }

    .footer-note a {
      color: #3b82f6;
      text-decoration: none;
      font-weight: 500;
    }

    .footer-note a:hover {
      text-decoration: underline;
    }

    .allergy-card {
      margin-top: 12px;
      background: linear-gradient(135deg, rgba(252, 211, 77, 0.06), rgba(255, 255, 255, 0.98));
      border-radius: 16px;
      padding: 10px 12px 11px;
      border: 1px solid rgba(253, 230, 138, 0.9);
      box-shadow: 0 12px 24px rgba(148, 163, 184, 0.2);
    }

    .allergy-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 6px;
    }

    .allergy-title {
      display: flex;
      align-items: center;
      gap: 7px;
      font-size: 13px;
      font-weight: 600;
      color: #0f172a;
    }

    .allergy-title .icon {
      width: 24px;
      height: 24px;
      border-radius: 999px;
      background: rgba(250, 204, 21, 0.16);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }

    .allergy-badge {
      font-size: 10px;
      padding: 3px 7px;
      border-radius: 999px;
      background: rgba(251, 191, 36, 0.1);
      color: #92400e;
      border: 1px solid rgba(252, 211, 77, 0.9);
      white-space: nowrap;
    }

    .allergy-description {
      font-size: 11px;
      color: #6b7280;
      margin-bottom: 8px;
    }

    .allergy-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 6px 10px;
    }

    .allergy-item {
      display: flex;
      flex-direction: column;
      gap: 5px;
      font-size: 11px;
      color: #4b5563;
      background: rgba(255, 255, 255, 0.98);
      border-radius: 12px;
      padding: 6px 8px;
      border: 1px solid rgba(229, 231, 235, 0.9);
    }

    .allergy-label {
      display: flex;
      align-items: center;
      gap: 6px;
      font-weight: 600;
      color: #111827;
      font-size: 11px;
    }

    .allergy-label span.emoji {
      font-size: 14px;
    }

    .allergy-toggle-group {
      display: inline-flex;
      align-items: center;
      border-radius: 999px;
      background: rgba(248, 250, 252, 0.96);
      border: 1px solid rgba(226, 232, 240, 0.9);
      overflow: hidden;
    }

    .allergy-toggle-button {
      border: none;
      background: transparent;
      padding: 5px 10px;
      font-size: 10px;
      cursor: pointer;
      color: #6b7280;
      min-width: 0;
      flex: 1;
      white-space: nowrap;
      position: relative;
      transition:
        background 0.12s ease,
        color 0.12s ease,
        box-shadow 0.12s ease,
        transform 0.12s ease;
    }

    .allergy-toggle-button:first-child {
      border-top-left-radius: 999px;
      border-bottom-left-radius: 999px;
    }

    .allergy-toggle-button:last-child {
      border-top-right-radius: 999px;
      border-bottom-right-radius: 999px;
    }

    .allergy-toggle-button + .allergy-toggle-button {
      border-left: 1px solid rgba(226, 232, 240, 0.9);
    }

    .allergy-toggle-button.is-active-allow {
      background: rgba(34, 197, 94, 0.14);
      color: #15803d;
      font-weight: 700;
      box-shadow: 0 0 0 1px rgba(34, 197, 94, 0.7) inset;
      transform: translateY(-0.5px);
    }

    .allergy-toggle-button.is-active-warn {
      background: rgba(245, 158, 11, 0.18);
      color: #92400e;
      font-weight: 700;
      box-shadow: 0 0 0 1px rgba(245, 158, 11, 0.75) inset;
      transform: translateY(-0.5px);
    }

    .allergy-toggle-button.is-active-block {
      background: rgba(239, 68, 68, 0.2);
      color: #b91c1c;
      font-weight: 700;
      box-shadow: 0 0 0 1px rgba(239, 68, 68, 0.85) inset;
      transform: translateY(-0.5px);
    }

    .allergy-save-row {
      margin-top: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
      justify-content: flex-start;
      font-size: 11px;
    }

    .allergy-save-row button {
      border-radius: 999px;
      padding: 6px 11px;
      border: none;
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: white;
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      box-shadow: 0 10px 22px rgba(22, 163, 74, 0.4);
      transition: transform 0.1s ease, box-shadow 0.1s ease, filter 0.1s ease;
    }

    .allergy-save-row button:hover {
      transform: translateY(-1px);
      box-shadow: 0 14px 26px rgba(22, 163, 74, 0.48);
      filter: brightness(1.03);
    }

    .allergy-save-row button:active {
      transform: translateY(0);
      box-shadow: 0 8px 16px rgba(22, 163, 74, 0.35);
      filter: brightness(0.97);
    }

    .allergy-save-row button:disabled {
      opacity: 0.7;
      box-shadow: none;
      cursor: default;
    }

    .allergy-feedback {
      min-height: 14px;
      font-size: 11px;
      color: #16a34a;
    }

    /* Product Limit Section Styles */
    .product-limit-card {
      margin-top: 12px;
      background: linear-gradient(135deg, rgba(139, 92, 246, 0.06), rgba(255, 255, 255, 0.98));
      border-radius: 16px;
      padding: 10px 12px 11px;
      border: 1px solid rgba(196, 181, 253, 0.9);
      box-shadow: 0 12px 24px rgba(148, 163, 184, 0.2);
    }

    .product-limit-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 6px;
    }

    .product-limit-title {
      display: flex;
      align-items: center;
      gap: 7px;
      font-size: 13px;
      font-weight: 600;
      color: #0f172a;
    }

    .product-limit-title .icon {
      width: 24px;
      height: 24px;
      border-radius: 999px;
      background: rgba(139, 92, 246, 0.16);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }

    .product-limit-badge {
      font-size: 10px;
      padding: 3px 7px;
      border-radius: 999px;
      background: rgba(139, 92, 246, 0.1);
      color: #6d28d9;
      border: 1px solid rgba(196, 181, 253, 0.9);
    }

    .product-limit-description {
      font-size: 11px;
      color: #6b7280;
      margin-bottom: 8px;
    }

    .product-limit-info {
      font-size: 10px;
      color: #7c3aed;
      background: rgba(139, 92, 246, 0.08);
      padding: 6px 10px;
      border-radius: 8px;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .product-limit-controls {
      display: flex;
      gap: 8px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }

    .product-limit-search {
      flex: 1;
      min-width: 150px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(226, 232, 240, 0.95);
      font-size: 11px;
      outline: none;
      transition: border-color 0.15s ease, box-shadow 0.15s ease;
    }

    .product-limit-search:focus {
      border-color: #8b5cf6;
      box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.2);
    }

    .product-limit-filter-toggle {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(226, 232, 240, 0.95);
      background: rgba(255, 255, 255, 0.96);
      font-size: 11px;
      cursor: pointer;
      transition: all 0.12s ease;
    }

    .product-limit-filter-toggle:hover {
      background: #fff;
    }

    .product-limit-filter-toggle.is-active {
      background: rgba(139, 92, 246, 0.12);
      border-color: rgba(139, 92, 246, 0.6);
      color: #6d28d9;
    }

    .product-limit-list {
      max-height: 280px;
      overflow-y: auto;
      scrollbar-width: thin;
      scrollbar-color: rgba(148, 163, 184, 0.7) transparent;
    }

    .product-limit-list::-webkit-scrollbar {
      width: 6px;
    }

    .product-limit-list::-webkit-scrollbar-track {
      background: transparent;
    }

    .product-limit-list::-webkit-scrollbar-thumb {
      background-color: rgba(148, 163, 184, 0.85);
      border-radius: 999px;
    }

    .product-limit-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 6px;
      border-bottom: 1px solid rgba(229, 231, 235, 0.8);
      gap: 10px;
    }

    .product-limit-item:last-child {
      border-bottom: none;
    }

    .product-limit-item.is-modified {
      background: rgba(139, 92, 246, 0.06);
    }

    .product-limit-item-info {
      display: flex;
      align-items: center;
      gap: 8px;
      flex: 1;
      min-width: 0;
    }

    .product-limit-item-icon {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      object-fit: contain;
      background: rgba(249, 250, 251, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      flex-shrink: 0;
    }

    .product-limit-item-details {
      flex: 1;
      min-width: 0;
    }

    .product-limit-item-name {
      font-size: 12px;
      font-weight: 600;
      color: #111827;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .product-limit-item-price {
      font-size: 10px;
      color: #6b7280;
    }

    .product-limit-stepper {
      display: flex;
      align-items: center;
      gap: 2px;
      background: rgba(249, 250, 251, 0.96);
      border-radius: 999px;
      border: 1px solid rgba(226, 232, 240, 0.95);
      padding: 2px;
    }

    .product-limit-stepper button {
      width: 26px;
      height: 26px;
      border: none;
      background: transparent;
      border-radius: 999px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      color: #6b7280;
      transition: all 0.12s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .product-limit-stepper button:hover {
      background: rgba(139, 92, 246, 0.15);
      color: #6d28d9;
    }

    .product-limit-stepper button:active {
      transform: scale(0.95);
    }

    .product-limit-stepper-value {
      min-width: 50px;
      text-align: center;
      font-size: 11px;
      font-weight: 600;
      color: #111827;
    }

    .product-limit-stepper-value.is-zero {
      color: #dc2626;
    }

    .product-limit-stepper-value.is-unlimited {
      color: #6b7280;
      font-style: italic;
    }

    .product-limit-save-row {
      margin-top: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
      justify-content: flex-start;
    }

    .product-limit-save-row button {
      border-radius: 999px;
      padding: 6px 11px;
      border: none;
      background: linear-gradient(135deg, #8b5cf6, #6d28d9);
      color: white;
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      box-shadow: 0 10px 22px rgba(109, 40, 217, 0.4);
      transition: transform 0.1s ease, box-shadow 0.1s ease, filter 0.1s ease;
    }

    .product-limit-save-row button:hover {
      transform: translateY(-1px);
      box-shadow: 0 14px 26px rgba(109, 40, 217, 0.48);
      filter: brightness(1.03);
    }

    .product-limit-save-row button:active {
      transform: translateY(0);
      box-shadow: 0 8px 16px rgba(109, 40, 217, 0.35);
      filter: brightness(0.97);
    }

    .product-limit-save-row button:disabled {
      opacity: 0.7;
      box-shadow: none;
      cursor: default;
    }

    .product-limit-feedback {
      min-height: 14px;
      font-size: 11px;
      color: #6d28d9;
    }

    .product-limit-empty {
      text-align: center;
      padding: 20px;
      font-size: 12px;
      color: #6b7280;
    }

    .spend-limit-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 6px;
    }

    .spend-limit-chip {
      border-radius: 999px;
      border: 1px solid rgba(226, 232, 240, 0.95);
      background: rgba(255, 255, 255, 0.96);
      padding: 4px 10px;
      font-size: 11px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      box-shadow: 0 8px 18px rgba(148, 163, 184, 0.18);
      transition:
        background 0.12s ease,
        box-shadow 0.12s ease,
        transform 0.12s ease;
    }

    .spend-limit-chip:hover {
      background: #ffffff;
      transform: translateY(-1px);
      box-shadow: 0 10px 22px rgba(148, 163, 184, 0.22);
    }

    .spend-limit-chip.is-active {
      background: rgba(59, 130, 246, 0.12);
      border-color: rgba(59, 130, 246, 0.6);
      color: #1d4ed8;
      font-weight: 600;
    }

    .spend-limit-row {
      display: flex;
      gap: 6px;
      align-items: center;
      margin-top: 2px;
    }

    .spend-limit-row input[type="number"] {
      flex: 1;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      padding: 7px 12px;
      font-size: 12px;
      background: rgba(249, 250, 251, 0.98);
      outline: none;
      transition:
        border-color 0.15s ease,
        box-shadow 0.15s ease,
        background-color 0.15s ease;
    }

    .spend-limit-row input[type="number"]:focus {
      border-color: #3b82f6;
      box-shadow: 0 0 0 1px rgba(59, 130, 246, 0.25);
      background: #ffffff;
    }

    .spend-limit-row button {
      border-radius: 999px;
      border: none;
      padding: 7px 12px;
      font-size: 11px;
      font-weight: 600;
      background: linear-gradient(135deg, #3b82f6, #6366f1);
      color: white;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      box-shadow: 0 10px 22px rgba(59, 130, 246, 0.4);
      transition:
        transform 0.1s ease,
        box-shadow 0.1s ease,
        filter 0.1s ease;
      white-space: nowrap;
    }

    .spend-limit-row button:hover {
      transform: translateY(-1px);
      box-shadow: 0 14px 26px rgba(59, 130, 246, 0.48);
      filter: brightness(1.03);
    }

    .spend-limit-row button:active {
      transform: translateY(0);
      box-shadow: 0 8px 16px rgba(59, 130, 246, 0.35);
      filter: brightness(0.97);
    }

    .spend-limit-row button:disabled {
      opacity: 0.7;
      box-shadow: none;
      cursor: default;
    }

    .spend-limit-feedback {
      margin-top: 4px;
      font-size: 11px;
      min-height: 14px;
      color: #16a34a;
    }

    @media (max-width: 780px) {
      .container-inner {
        grid-template-columns: 1fr;
      }

      .intro-section {
        order: 2;
      }

      .login-section {
        order: 1;
      }

      .info-cards {
        grid-template-columns: 1fr;
      }

      .notify-body {
        grid-template-columns: 1fr;
      }
      .allergy-grid {
        grid-template-columns: 1fr;
      }

      /* Produktgr√¶nser - mobile forbedringer */
      .product-limit-list {
        max-height: 400px;
      }

      .product-limit-item {
        gap: 6px;
        flex-wrap: wrap;
      }

      .product-limit-controls {
        flex-direction: column;
        gap: 8px;
      }

      .product-limit-search {
        min-width: 100px;
        width: 100%;
      }

      .product-limit-stepper button {
        width: 32px;
        height: 32px;
        font-size: 16px;
      }

      .product-limit-stepper-value {
        min-width: 70px;
        font-size: 11px;
      }
    }
  </style>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
  <div class="page-wrapper">
    <div class="logo-row">
      <div class="logo">
        <div class="logo-badge">F</div>
        <div class="logo-text-main">
          <div class="logo-name">Flango</div>
          <div class="logo-tagline">B√∏rnenes caf√©-system</div>
        </div>
      </div>
      <div class="top-tag">
        <span class="dot"></span>
        <span>For√¶ldre-portal ‚Äì sikker visning af saldo & historik</span>
      </div>
    </div>

    <main class="container">
      <div class="container-inner">
        <section class="intro-section">
          <div class="title-row">
            <h1>
              <span>Flango</span>
              <span class="highlight">For√¶ldre-portal</span>
            </h1>
          </div>

          <p class="subtitle">
            Her kan du som for√¶lder f√• et hurtigt overblik over
            <strong>dit barns saldo</strong> i caf√©en og se en
            <strong>tydelig historik</strong> over k√∏b og optankninger.
          </p>

          <div class="info-cards">
            <div class="info-card">
              <div class="info-icon">üí≥</div>
              <div class="info-content">
                <strong>Tryghed & gennemsigtighed</strong>
                Du kan altid se, hvad der er k√∏bt, og hvorn√•r saldoen er blevet
                tanket op.
              </div>
            </div>
            <div class="info-card">
              <div class="info-icon">üîî</div>
              <div class="info-content">
                <strong>E-mail n√•r saldoen er lav</strong>
                V√¶lg at f√• en besked, n√•r der er fx 0 kr. eller 10 kr. tilbage p√• kontoen.
              </div>
            </div>
          </div>

          <p class="help-text">
            <strong>S√•dan g√∏r du:</strong><br />
            1) V√¶lg klubbens/SFO‚Äôens navn<br />
            2) Skriv dit barns fulde navn (som aftalt med klubben)<br />
            3) Indtast den kode, I har f√•et fra personalet
          </p>
        </section>

        <section class="login-section">
          <div class="login-inner">
            <div class="section-title">
              <span class="icon">üë®‚Äçüë©‚Äçüëß</span>
              Log ind som for√¶lder
            </div>
            <p class="section-subtitle">
              Brug den kode, I har f√•et fra klubben/SFO‚Äôen. Er du i tvivl, s√• sp√∏rg personalet ‚Äì de hj√¶lper gerne.
            </p>

            <!-- Login View -->
            <div id="login-view">
              <div class="login-card">
                <form id="parent-login-form" class="login-form">
                  <!-- Klub/SFO -->
                  <div class="form-group" id="institution-row">
                    <label for="institution-select" class="section-subtitle" id="institution-label">
                      V√¶lg klub/SFO
                    </label>
                    <select id="institution-select" required>
                      <option value="">V√¶lg klub/SFO‚Ä¶</option>
                    </select>
                  </div>

                  <p
                    id="institution-info"
                    class="section-subtitle"
                    style="display: none; margin-bottom: 10px;"
                  >
                    Institutioner i n√¶rheden af dig:
                    <strong id="institution-name-label"></strong>
                  </p>

                  <!-- Barnets navn -->
                  <input
                    type="text"
                    id="child-name-input"
                    placeholder="Barnets fulde navn (fx Oliver Jensen)"
                    required
                  />

                  <!-- For√¶ldre-kode -->
                  <input
                    type="password"
                    id="parent-pin-input"
                    placeholder="For√¶ldre-kode (fx 6 cifre eller kodeord)"
                    inputmode="text"
                    maxlength="32"
                    required
                  />

                  <button type="submit" id="login-btn">Se saldo og historik</button>
                  <p id="login-error" class="error-message" style="display: none;"></p>
                </form>

                <p class="login-help">
                  <strong>Har du ikke f√•et en kode?</strong><br />
                  Kontakt klubben/SFO‚Äôen ‚Äì de kan oplyse eller nulstille jeres for√¶ldre-login.
                </p>
              </div>
            </div>

            <!-- Results View -->
            <div id="results-view" style="display: none;">
              <div class="results-header">
                <div class="child-info">
                  <div class="child-name" id="child-name-display">Barnets navn</div>
                  <div class="balance-chip">
                    <span class="balance-dot" id="balance-dot"></span>
                    <div>
                      <div class="balance-label" id="balance-status-label">Saldo-status</div>
                      <div class="balance-amount" id="balance-display">0,00 kr</div>
                    </div>
                  </div>
                </div>
                <button id="logout-btn" class="logout-button">
                  <span>Log ud</span> ‚èè
                </button>
              </div>

              <div class="history-card">
                <div class="history-header">
                  <div class="history-title">
                    Historik
                    <span class="badge">Sidste 30 dage</span>
                  </div>
                  <div class="history-summary" id="history-summary">
                    Viser k√∏b og optankninger p√• kontoen.
                  </div>
                </div>
                <ul id="history-list" class="history-list"></ul>
              </div>

              <section class="payment-card" id="payment-card" style="display: none;">
                <div class="payment-header">
                  <div class="payment-title">
                    <div class="icon">üí≥</div>
                    Optank saldo
                  </div>
                  <span class="payment-badge" id="payment-status-badge">Institutionen bestemmer</span>
                </div>
                <p class="payment-subtitle" id="payment-subtitle">
                  Portalen viser kun de betalingsmuligheder, som din klub/SFO har sl√•et til.
                </p>

                <div class="payment-grid" id="payment-grid"></div>

                <div class="payment-qr" id="payment-qr">
                  <img id="payment-qr-img" alt="MobilePay QR" />
                  <div class="payment-qr-note" id="payment-qr-note">
                    Betal via MobilePay QR. Saldoen opdateres efter godkendelse af personalet.
                  </div>
                </div>

                <div class="payment-feedback" id="payment-feedback"></div>
              </section>

              <section id="spending-limit-section" class="card" style="margin-top: 12px; background: linear-gradient(135deg, rgba(59, 130, 246, 0.04), rgba(255, 255, 255, 0.98)); border-radius: 16px; padding: 10px 12px 11px; border: 1px solid rgba(199, 210, 254, 0.9); box-shadow: 0 12px 24px rgba(148, 163, 184, 0.2);">
                <h2 class="section-title" style="font-size: 13px; font-weight: 600; color: #0f172a; display: flex; align-items: center; gap: 7px;">
                  <div class="icon" style="width: 24px; height: 24px; border-radius: 999px; background: rgba(59, 130, 246, 0.12); display: flex; align-items: center; justify-content: center; font-size: 14px;">üí∞</div>
                  Daglig bel√∏bsgr√¶nse
                </h2>
                <p class="section-subtitle" style="font-size: 11px; color: #6b7280; margin-bottom: 6px;">
                  S√¶t en maksimal gr√¶nse for, hvor meget der m√• bruges i caf√©en pr. dag. Du kan v√¶lge et forslag eller skrive et andet bel√∏b.
                </p>

                <div class="spend-limit-chips">
                  <button type="button" class="spend-limit-chip daily-limit-chip" data-amount="20">20 kr.</button>
                  <button type="button" class="spend-limit-chip daily-limit-chip" data-amount="30">30 kr.</button>
                  <button type="button" class="spend-limit-chip daily-limit-chip" data-amount="40">40 kr.</button>
                  <button type="button" class="spend-limit-chip daily-limit-chip" data-amount="50">50 kr.</button>
                </div>

                <div class="spend-limit-row">
                  <input
                    type="number"
                    id="daily-limit-input"
                    min="0"
                    step="1"
                    placeholder="Bel√∏bsgr√¶nse i kr. pr. dag (fx 20)"
                  />
                  <button type="button" id="save-daily-limit-btn">Gem bel√∏bsgr√¶nse</button>
                </div>
                <p id="daily-limit-feedback" class="spend-limit-feedback"></p>
              </section>
              <div id="email-notification-section" class="notify-card">
                <div class="notify-header">
                  <div class="notify-title">
                    <div class="icon">üìß</div>
                    E-mail, n√•r saldoen er lav
                  </div>
                  <span class="notify-badge">Valgfrit</span>
                </div>
                <div class="notify-body">
                  <div class="field">
                    <label for="parent-email-input">E-mailadresse til besked</label>
                    <input
                      type="email"
                      id="parent-email-input"
                      placeholder="fx mor@eksempel.dk"
                    />
                    <div class="notify-options">
                      <label class="notify-option">
                        <input type="checkbox" id="notify-zero-checkbox" />
                        <span>N√•r saldoen er 0 kr.</span>
                      </label>
                      <label class="notify-option">
                        <input type="checkbox" id="notify-ten-checkbox" />
                        <span>N√•r saldoen er 10 kr. eller derunder</span>
                      </label>
                    </div>
                  </div>
                  <div class="field">
                    <div class="notify-save-row">
                      <button id="save-notify-btn" type="button">
                        Gem e-mail-beskeder
                      </button>
                      <div id="notify-feedback" class="notify-feedback"></div>
                    </div>
                    <p style="font-size: 11px; color: #6b7280; margin-top: 4px;">
                      Du kan altid √¶ndre eller sl√• beskeder fra igen.
                    </p>
                  </div>
                </div>
              </div>

              <section id="allergens-section" class="allergy-card">
                <div class="allergy-header">
                  <div class="allergy-title">
                    <div class="icon">ü•ú</div>
                    Allergier & madbegr√¶nsninger
                  </div>
                  <span class="allergy-badge">Valgfrit</span>
                </div>
                <p class="allergy-description">
                  Her kan du som for√¶lder hj√¶lpe med at markere, hvad dit barn <strong>ikke</strong> b√∏r k√∏be.
                  Personalet kan altid hj√¶lpe, hvis der er tale om l√¶ge-diagnosticerede allergier.
                </p>
                <p class="allergy-description" style="margin-top: 4px;">
                  <em>
                    Ingrediens- og allergenoplysninger i systemet er vejledende og kan indeholde fejl eller mangler, da produkter og opskrifter l√∏bende √¶ndres af personalet. Institutionen og systemet kan derfor ikke garantere fuldst√¶ndig korrekthed eller fuldst√¶ndigt frav√¶r af allergener. For√¶ldre til b√∏rn med allergi b√∏r altid tale direkte med personalet.
                  </em>
                </p>
                <div class="allergy-grid" id="allergy-grid">
                  <div class="allergy-item" data-allergen-row="peanuts">
                    <div class="allergy-label">
                      <span class="emoji">ü•ú</span>
                      <span>Jordn√∏dder (peanuts)</span>
                    </div>
                    <div class="allergy-toggle-group">
                      <button type="button" class="allergy-toggle-button" data-allergen="peanuts" data-policy="allow">Tillad</button>
                      <button type="button" class="allergy-toggle-button" data-allergen="peanuts" data-policy="warn">Advar</button>
                      <button type="button" class="allergy-toggle-button" data-allergen="peanuts" data-policy="block">Blok√©r</button>
                    </div>
                  </div>

                  <div class="allergy-item" data-allergen-row="tree_nuts">
                    <div class="allergy-label">
                      <span class="emoji">üå∞</span>
                      <span>Tr√¶n√∏dder (mandel, cashew, mm.)</span>
                    </div>
                    <div class="allergy-toggle-group">
                      <button type="button" class="allergy-toggle-button" data-allergen="tree_nuts" data-policy="allow">Tillad</button>
                      <button type="button" class="allergy-toggle-button" data-allergen="tree_nuts" data-policy="warn">Advar</button>
                      <button type="button" class="allergy-toggle-button" data-allergen="tree_nuts" data-policy="block">Blok√©r</button>
                    </div>
                  </div>

                  <div class="allergy-item" data-allergen-row="milk">
                    <div class="allergy-label">
                      <span class="emoji">ü•õ</span>
                      <span>M√¶lk / m√¶lkeprodukter</span>
                    </div>
                    <div class="allergy-toggle-group">
                      <button type="button" class="allergy-toggle-button" data-allergen="milk" data-policy="allow">Tillad</button>
                      <button type="button" class="allergy-toggle-button" data-allergen="milk" data-policy="warn">Advar</button>
                      <button type="button" class="allergy-toggle-button" data-allergen="milk" data-policy="block">Blok√©r</button>
                    </div>
                  </div>

                  <div class="allergy-item" data-allergen-row="egg">
                    <div class="allergy-label">
                      <span class="emoji">ü•ö</span>
                      <span>√Üg</span>
                    </div>
                    <div class="allergy-toggle-group">
                      <button type="button" class="allergy-toggle-button" data-allergen="egg" data-policy="allow">Tillad</button>
                      <button type="button" class="allergy-toggle-button" data-allergen="egg" data-policy="warn">Advar</button>
                      <button type="button" class="allergy-toggle-button" data-allergen="egg" data-policy="block">Blok√©r</button>
                    </div>
                  </div>

                  <div class="allergy-item" data-allergen-row="gluten">
                    <div class="allergy-label">
                      <span class="emoji">üåæ</span>
                      <span>Gluten / hvede</span>
                    </div>
                    <div class="allergy-toggle-group">
                      <button type="button" class="allergy-toggle-button" data-allergen="gluten" data-policy="allow">Tillad</button>
                      <button type="button" class="allergy-toggle-button" data-allergen="gluten" data-policy="warn">Advar</button>
                      <button type="button" class="allergy-toggle-button" data-allergen="gluten" data-policy="block">Blok√©r</button>
                    </div>
                  </div>

                  <div class="allergy-item" data-allergen-row="fish">
                    <div class="allergy-label">
                      <span class="emoji">üêü</span>
                      <span>Fisk</span>
                    </div>
                    <div class="allergy-toggle-group">
                      <button type="button" class="allergy-toggle-button" data-allergen="fish" data-policy="allow">Tillad</button>
                      <button type="button" class="allergy-toggle-button" data-allergen="fish" data-policy="warn">Advar</button>
                      <button type="button" class="allergy-toggle-button" data-allergen="fish" data-policy="block">Blok√©r</button>
                    </div>
                  </div>

                  <div class="allergy-item" data-allergen-row="shellfish">
                    <div class="allergy-label">
                      <span class="emoji">ü¶ê</span>
                      <span>Skaldyr</span>
                    </div>
                    <div class="allergy-toggle-group">
                      <button type="button" class="allergy-toggle-button" data-allergen="shellfish" data-policy="allow">Tillad</button>
                      <button type="button" class="allergy-toggle-button" data-allergen="shellfish" data-policy="warn">Advar</button>
                      <button type="button" class="allergy-toggle-button" data-allergen="shellfish" data-policy="block">Blok√©r</button>
                    </div>
                  </div>

                  <div class="allergy-item" data-allergen-row="sesame">
                    <div class="allergy-label">
                      <span class="emoji">üßÜ</span>
                      <span>Sesam</span>
                    </div>
                    <div class="allergy-toggle-group">
                      <button type="button" class="allergy-toggle-button" data-allergen="sesame" data-policy="allow">Tillad</button>
                      <button type="button" class="allergy-toggle-button" data-allergen="sesame" data-policy="warn">Advar</button>
                      <button type="button" class="allergy-toggle-button" data-allergen="sesame" data-policy="block">Blok√©r</button>
                    </div>
                  </div>

                <div class="allergy-item" data-allergen-row="soy">
                    <div class="allergy-label">
                      <span class="emoji">ü´ò</span>
                      <span>Soja</span>
                    </div>
                    <div class="allergy-toggle-group">
                      <button type="button" class="allergy-toggle-button" data-allergen="soy" data-policy="allow">Tillad</button>
                      <button type="button" class="allergy-toggle-button" data-allergen="soy" data-policy="warn">Advar</button>
                      <button type="button" class="allergy-toggle-button" data-allergen="soy" data-policy="block">Blok√©r</button>
                    </div>
                  </div>
                </div>
                <div class="allergy-save-row">
                  <button type="button" id="save-allergy-btn">Gem allergi-indstillinger</button>
                  <div id="allergy-feedback" class="allergy-feedback"></div>
                </div>
              </section>

              <!-- K√∏bsgr√¶nser pr. produkt -->
              <section id="product-limit-section" class="product-limit-card" style="display: none;">
                <div class="product-limit-header">
                  <div class="product-limit-title">
                    <div class="icon">üõí</div>
                    K√∏bsgr√¶nser pr. produkt
                  </div>
                  <span class="product-limit-badge">Valgfrit</span>
                </div>
                <p class="product-limit-description">
                  S√¶t en gr√¶nse for, hvor mange stk. af hvert produkt dit barn m√• k√∏be per dag.
                  Efterlad som "Ubegr√¶nset" hvis du ikke √∏nsker en gr√¶nse.
                </p>
                <div class="product-limit-info">
                  <span>üí°</span>
                  <span>Hvis klubben har sat en gr√¶nse, g√¶lder den strengeste. Dit barns k√∏b m√• aldrig overstige hverken din eller klubbens gr√¶nse.</span>
                </div>

                <div class="product-limit-controls">
                  <input type="text" class="product-limit-search" id="product-limit-search" placeholder="S√∏g efter produkt..." />
                  <label class="product-limit-filter-toggle" id="product-limit-filter-toggle">
                    <input type="checkbox" id="product-limit-show-modified" style="display: none;" />
                    <span>Vis kun √¶ndrede</span>
                  </label>
                </div>

                <div class="product-limit-list" id="product-limit-list">
                  <div class="product-limit-empty">Indl√¶ser produkter...</div>
                </div>

                <div class="product-limit-save-row">
                  <button type="button" id="save-product-limits-btn">Gem produktgr√¶nser</button>
                  <div id="product-limit-feedback" class="product-limit-feedback"></div>
                </div>
              </section>

              <!-- Skift kode-kort -->
              <section class="card" style="margin-top: 12px; background: rgba(255, 255, 255, 0.98); border-radius: 16px; padding: 10px 12px 11px; border: 1px solid rgba(220, 220, 220, 0.95); box-shadow: 0 12px 24px rgba(148, 163, 184, 0.2);">
                <h2 class="section-title" style="font-size: 13px; font-weight: 600; color: #0f172a; display: flex; align-items: center; gap: 7px;">
                  <div class="icon" style="width: 24px; height: 24px; border-radius: 999px; background: rgba(255, 122, 60, 0.12); display: flex; align-items: center; justify-content: center; font-size: 14px;">üîë</div>
                  Skift kode til for√¶ldre-login
                </h2>
                <p class="section-subtitle" style="font-size: 11px; color: #6b7280; margin-bottom: 8px;">
                  Her kan du √¶ndre den kode, du bruger til Flango For√¶ldre-portal.
                </p>

                <form id="change-pin-form" class="login-form" style="gap: 6px;">
                  <div class="form-group">
                    <input
                      type="password"
                      id="new-pin"
                      maxlength="20"
                      autocomplete="off"
                      placeholder="Ny kode (mindst 4 tegn)"
                      required
                      style="padding: 7px 12px; font-size: 12px;"
                    />
                  </div>

                  <div class="form-group">
                    <input
                      type="password"
                      id="confirm-new-pin"
                      maxlength="20"
                      autocomplete="off"
                      placeholder="Gentag ny kode"
                      required
                      style="padding: 7px 12px; font-size: 12px;"
                    />
                  </div>
                  <button type="submit" class="primary-btn" style="padding: 6px 11px; font-size: 11px; font-weight: 600; background: linear-gradient(135deg, #ff7a3c, #ffb100); box-shadow: 0 10px 22px rgba(248, 113, 22, 0.4);">Gem ny kode</button>
                  <p id="change-pin-message" style="margin-top: 6px; font-size: 11px; display: none;"></p>
                </form>
              </section>
            </div>
          </div>
        </section>
      </div>

      <p class="footer-note">
        Flango er udviklet til SFO‚Äôer og fritidsklubber, s√• b√∏rn kan √∏ve ansvar p√• en tryg m√•de.
      </p>
    </main>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const FUNCTION_URL =
        "https://jbknjgbpghrbrstqwoxj.functions.supabase.co/get-parent-view";
      const SAVE_NOTIFY_URL =
        "https://jbknjgbpghrbrstqwoxj.functions.supabase.co/save-parent-notification";
      const GET_ALLERGY_URL =
        "https://jbknjgbpghrbrstqwoxj.functions.supabase.co/get-allergy-settings";

      const SUPABASE_URL = "https://jbknjgbpghrbrstqwoxj.supabase.co";
      const SUPABASE_ANON_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impia25qZ2JwZ2hyYnJzdHF3b3hqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI2MjIwNjMsImV4cCI6MjA3ODE5ODA2M30.ZMlxQyzmXuy43EcKIN6-eO8pJZs2F6kfDw_cfaks9qQ";

      const supabase = window.supabase.createClient(
        SUPABASE_URL,
        SUPABASE_ANON_KEY
      );

      let institutions = [];
      let currentChildId = null;
      let currentParentPin = null;

      const loginView = document.getElementById("login-view");
      const resultsView = document.getElementById("results-view");
      const loginForm = document.getElementById("parent-login-form");
      const loginBtn = document.getElementById("login-btn");
      const loginError = document.getElementById("login-error");
      const logoutBtn = document.getElementById("logout-btn");
      const institutionSelect = document.getElementById("institution-select");
      const institutionLabel = document.getElementById("institution-label");

      // Referencer til "Skift kode"
      const changePinForm = document.getElementById("change-pin-form");
      const newPinInput = document.getElementById("new-pin");
      const confirmNewPinInput = document.getElementById("confirm-new-pin");
      const changePinMessage = document.getElementById("change-pin-message");

      const UPDATE_PIN_URL =
        "https://jbknjgbpghrbrstqwoxj.functions.supabase.co/update-parent-pin";

      const institutionRow = document.getElementById("institution-row");
      const institutionInfo = document.getElementById("institution-info");
      const institutionNameLabel = document.getElementById("institution-name-label");

      const parentEmailInput = document.getElementById("parent-email-input");
      const notifyZeroCheckbox = document.getElementById("notify-zero-checkbox");
      const notifyTenCheckbox = document.getElementById("notify-ten-checkbox");
      const saveNotifyBtn = document.getElementById("save-notify-btn");
      const notifyFeedback = document.getElementById("notify-feedback");

      const balanceDot = document.getElementById("balance-dot");

      const SAVE_ALLERGY_URL =
        "https://jbknjgbpghrbrstqwoxj.functions.supabase.co/save-allergy-settings";
      const SAVE_DAILY_LIMIT_URL =
        "https://jbknjgbpghrbrstqwoxj.functions.supabase.co/save-daily-limit";

      const allergyButtons = document.querySelectorAll(
        ".allergy-toggle-button[data-allergen][data-policy]"
      );
      const saveAllergyBtn = document.getElementById("save-allergy-btn");
      const allergyFeedback = document.getElementById("allergy-feedback");

      // Daglig bel√∏bsgr√¶nse (for√¶ldre)
      const dailyLimitInput = document.getElementById("daily-limit-input");
      const dailyLimitChips = document.querySelectorAll(".daily-limit-chip");
      const saveDailyLimitBtn = document.getElementById("save-daily-limit-btn");
      const dailyLimitFeedback = document.getElementById("daily-limit-feedback");

      // Betalingssektion (kontant / QR / portal)
      const paymentCard = document.getElementById("payment-card");
      const paymentGrid = document.getElementById("payment-grid");
      const paymentFeedback = document.getElementById("payment-feedback");
      const paymentStatusBadge = document.getElementById("payment-status-badge");
      const paymentQrWrap = document.getElementById("payment-qr");
      const paymentQrImg = document.getElementById("payment-qr-img");
      const paymentQrNote = document.getElementById("payment-qr-note");
      let currentInstitutionId = null;
      let currentInstitutionPrefs = null;
      let selectedTopupAmount = null;

      function safeBool(v) {
        return v === true || v === "true" || v === 1 || v === "1";
      }

      function renderPaymentSection(prefs) {
        if (!paymentCard || !paymentGrid) return;

        // Standard: intet
        paymentGrid.innerHTML = "";
        if (paymentFeedback) paymentFeedback.textContent = "";
        if (paymentQrWrap) paymentQrWrap.style.display = "none";

        const cashEnabled = safeBool(prefs && prefs.topup_cash_enabled);
        const qrEnabled = safeBool(prefs && prefs.topup_qr_enabled);
        const portalEnabled = safeBool(prefs && prefs.topup_portal_enabled);

        const anyEnabled = cashEnabled || qrEnabled || portalEnabled;

        if (!anyEnabled) {
          paymentCard.style.display = "block";
          if (paymentStatusBadge) {
            paymentStatusBadge.textContent = "Ingen online optankning";
          }
          paymentGrid.innerHTML = `
            <div class="payment-option">
              <div class="payment-option-title">
                <div class="left"><span class="emoji">üè´</span><span>Kontakt personalet</span></div>
                <span class="payment-badge">Info</span>
              </div>
              <div class="payment-body">
                Denne institution modtager ikke online optankning i Flango lige nu.
                Kontakt personalet for hj√¶lp til optankning.
              </div>
            </div>
          `;
          return;
        }

        paymentCard.style.display = "block";

        // Badge
        if (paymentStatusBadge) {
          if (portalEnabled && qrEnabled) {
            paymentStatusBadge.textContent = "Flere muligheder";
          } else if (portalEnabled) {
            paymentStatusBadge.textContent = "Automatisk optankning";
          } else if (qrEnabled) {
            paymentStatusBadge.textContent = "MobilePay QR";
          } else {
            paymentStatusBadge.textContent = "Kontant";
          }
        }

        // Kontant
        if (cashEnabled) {
          const cashText =
            (prefs && (prefs.topup_cash_message || prefs.cash_topup_message)) ||
            "For√¶ldre afleverer kontanter til personalet. Saldoen opdateres manuelt.";
          paymentGrid.insertAdjacentHTML(
            "beforeend",
            `
            <div class="payment-option">
              <div class="payment-option-title">
                <div class="left"><span class="emoji">üíµ</span><span>Kontant indbetaling</span></div>
                <span class="payment-badge">Manuel</span>
              </div>
              <div class="payment-body">${cashText}</div>
            </div>
            `
          );
        }

        // Portal optankning (kaldes "Tank op i portalen (automatisk)" ‚Äì ikke "API")
        if (portalEnabled) {
          const portalText =
            (prefs && (prefs.topup_portal_message || prefs.portal_topup_message)) ||
            "Tank op direkte i portalen. Saldoen opdateres med det samme.";
          const recommendedClass = qrEnabled ? "recommended" : "";
          const recommendedBadge = qrEnabled ? `<span class="payment-badge good">Anbefalet</span>` : `<span class="payment-badge good">Aktiv</span>`;

          paymentGrid.insertAdjacentHTML(
            "beforeend",
            `
            <div class="payment-option ${recommendedClass}" id="portal-topup-option">
              <div class="payment-option-title">
                <div class="left"><span class="emoji">üü¢</span><span>Tank op i portalen (automatisk)</span></div>
                ${recommendedBadge}
              </div>
              <div class="payment-body">${portalText}</div>

              <div class="payment-actions" id="topup-amounts">
                <button type="button" class="payment-amount" data-amount="50">50 kr.</button>
                <button type="button" class="payment-amount" data-amount="100">100 kr.</button>
                <button type="button" class="payment-amount" data-amount="150">150 kr.</button>
              </div>

              <div class="payment-row">
                <input type="number" id="topup-amount-input" min="0" step="1" placeholder="Andet bel√∏b i kr." />
                <button type="button" id="topup-now-btn">Tank op</button>
              </div>
              <div class="payment-qr-note" style="margin-top: 6px;">
                Optankning kr√¶ver at institutionen har sl√•et online-betaling til. Hvis knappen ikke virker, kontakt personalet.
              </div>
            </div>
            `
          );
        }

        // QR
        if (qrEnabled) {
          const qrText =
            (prefs && (prefs.topup_qr_message || prefs.qr_topup_message)) ||
            "Betal via MobilePay QR. Saldoen opdateres efter godkendelse af personalet.";
          const secondaryClass = portalEnabled ? "secondary" : "";
          const badge = portalEnabled ? `<span class="payment-badge warn">Kr√¶ver godkendelse</span>` : `<span class="payment-badge warn">Aktiv</span>`;

          paymentGrid.insertAdjacentHTML(
            "beforeend",
            `
            <div class="payment-option ${secondaryClass}" id="qr-topup-option">
              <div class="payment-option-title">
                <div class="left"><span class="emoji">üü°</span><span>MobilePay QR</span></div>
                ${badge}
              </div>
              <div class="payment-body">${qrText}</div>
              <div class="payment-actions">
                <button type="button" class="payment-amount" id="show-qr-btn">Vis QR</button>
              </div>
            </div>
            `
          );

          // QR-asset
          const qrUrl = prefs && (prefs.topup_qr_image_url || prefs.qr_image_url || prefs.mobilepay_qr_url);
          if (paymentQrImg && qrUrl) {
            paymentQrImg.src = qrUrl;
          } else if (paymentQrImg) {
            paymentQrImg.removeAttribute("src");
          }

          if (paymentQrNote) paymentQrNote.textContent = qrText;
        }

        // Wire events (amount chips + show QR + portal topup)
        wirePaymentEvents();
      }

      function wirePaymentEvents() {
        if (!paymentCard) return;

        const amountButtons = paymentCard.querySelectorAll(".payment-amount[data-amount]");
        const amountInput = document.getElementById("topup-amount-input");
        const topupNowBtn = document.getElementById("topup-now-btn");
        const showQrBtn = document.getElementById("show-qr-btn");

        // Amount buttons
        if (amountButtons && amountButtons.length) {
          amountButtons.forEach((btn) => {
            btn.addEventListener("click", () => {
              const amt = Number(btn.dataset.amount);
              if (!Number.isFinite(amt)) return;

              selectedTopupAmount = amt;
              amountButtons.forEach((b) => b.classList.remove("is-active"));
              btn.classList.add("is-active");

              if (amountInput) {
                amountInput.value = String(amt);
                amountInput.focus();
              }
              if (paymentFeedback) paymentFeedback.textContent = "";
            });
          });
        }

        // Show QR
        if (showQrBtn) {
          showQrBtn.addEventListener("click", () => {
            if (!paymentQrWrap) return;
            const hasSrc = paymentQrImg && paymentQrImg.getAttribute("src");
            paymentQrWrap.style.display = "block";
            if (!hasSrc && paymentFeedback) {
              paymentFeedback.textContent =
                "QR er sl√•et til, men der er ikke uploadet et QR-billede endnu. Kontakt personalet.";
              paymentFeedback.style.color = "#92400e";
            }
          });
        }

        // Portal topup button (UI-klar; backend kan kobles p√• senere)
        if (topupNowBtn) {
          topupNowBtn.addEventListener("click", () => {
            if (paymentFeedback) {
              paymentFeedback.textContent =
                "Optankning i portalen er endnu ikke koblet til betaling her i demoen. Kontakt personalet, eller brug institutionens valgte metode.";
              paymentFeedback.style.color = "#92400e";
            }
          });
        }
      }

      // Vis/skjul funktionssektioner baseret p√• institutionens indstillinger
      function renderFeatureSections(prefs) {
        const emailSection = document.getElementById("email-notification-section");
        const spendingSection = document.getElementById("spending-limit-section");
        const allergensSection = document.getElementById("allergens-section");
        const productLimitSection = document.getElementById("product-limit-section");

        // E-mail notifikationer (default true hvis ikke sat)
        const emailEnabled = prefs && prefs.parent_portal_email_notifications !== false;
        if (emailSection) {
          emailSection.style.display = emailEnabled ? "block" : "none";
        }

        // Daglig bel√∏bsgr√¶nse (default true hvis ikke sat)
        const spendingEnabled = prefs && prefs.parent_portal_spending_limit !== false;
        if (spendingSection) {
          spendingSection.style.display = spendingEnabled ? "block" : "none";
        }

        // Allergener (default true hvis ikke sat)
        const allergensEnabled = prefs && prefs.parent_portal_allergens !== false;
        if (allergensSection) {
          allergensSection.style.display = allergensEnabled ? "block" : "none";
        }

        // K√∏bsgr√¶nser pr. produkt (default false - institution m√• aktivere)
        const productLimitEnabled = prefs && prefs.parent_portal_product_limit === true;
        if (productLimitSection) {
          productLimitSection.style.display = productLimitEnabled ? "block" : "none";
          if (productLimitEnabled && currentChildId && currentInstitutionId) {
            loadProductLimits(currentInstitutionId, currentChildId);
          }
        }
      }

      // ===== PRODUKTGR√ÜNSER FUNKTIONER =====
      let productLimitProducts = [];
      let productLimitSettings = new Map(); // productId -> max_per_day (null = ubegr√¶nset)
      let institutionProductLimits = new Map(); // productId -> max_per_day fra institutionen

      async function loadProductLimits(institutionId, childId) {
        const listEl = document.getElementById("product-limit-list");
        if (!listEl) return;

        listEl.innerHTML = '<div class="product-limit-empty">Indl√¶ser produkter...</div>';

        try {
          // Hent aktive produkter fra institutionen
          const { data: products, error: productsError } = await supabase
            .from("products")
            .select("id, name, price, emoji, icon_url")
            .eq("institution_id", institutionId)
            .eq("is_enabled", true)
            .order("sort_order", { ascending: true });

          if (productsError) {
            console.error("Fejl ved hentning af produkter:", productsError);
            listEl.innerHTML = '<div class="product-limit-empty">Kunne ikke indl√¶se produkter.</div>';
            return;
          }

          productLimitProducts = products || [];

          if (productLimitProducts.length === 0) {
            listEl.innerHTML = '<div class="product-limit-empty">Ingen aktive produkter fundet.</div>';
            return;
          }

          // Hent institutionens produktgr√¶nser (product_limits tabel)
          const { data: instLimits, error: instLimitsError } = await supabase
            .from("product_limits")
            .select("product_id, max_per_day")
            .eq("institution_id", institutionId);

          institutionProductLimits.clear();
          if (!instLimitsError && instLimits) {
            instLimits.forEach(row => {
              if (row.max_per_day != null && row.max_per_day > 0) {
                institutionProductLimits.set(row.product_id, row.max_per_day);
              }
            });
          }

          // Hent barnets eksisterende produktgr√¶nser (fra parent_limits tabel)
          const { data: childLimits, error: childLimitsError } = await supabase
            .from("parent_limits")
            .select("product_id, max_per_day")
            .eq("child_id", childId);

          productLimitSettings.clear();
          if (!childLimitsError && childLimits) {
            childLimits.forEach(row => {
              productLimitSettings.set(row.product_id, row.max_per_day);
            });
          }

          renderProductLimitList();
          wireProductLimitEvents();

        } catch (err) {
          console.error("Uventet fejl ved indl√¶sning af produktgr√¶nser:", err);
          listEl.innerHTML = '<div class="product-limit-empty">Uventet fejl opstod.</div>';
        }
      }

      function renderProductLimitList() {
        const listEl = document.getElementById("product-limit-list");
        const searchInput = document.getElementById("product-limit-search");
        const showModifiedCheckbox = document.getElementById("product-limit-show-modified");

        if (!listEl) return;

        const searchTerm = (searchInput?.value || "").toLowerCase().trim();
        const showOnlyModified = showModifiedCheckbox?.checked || false;

        let filteredProducts = productLimitProducts;

        // Filtrering
        if (searchTerm) {
          filteredProducts = filteredProducts.filter(p =>
            (p.name || "").toLowerCase().includes(searchTerm)
          );
        }

        if (showOnlyModified) {
          // Vis kun produkter med en gr√¶nse sat (ikke -1 = ubegr√¶nset)
          filteredProducts = filteredProducts.filter(p =>
            productLimitSettings.has(p.id) && productLimitSettings.get(p.id) !== -1
          );
        }

        if (filteredProducts.length === 0) {
          listEl.innerHTML = '<div class="product-limit-empty">Ingen produkter matcher din s√∏gning.</div>';
          return;
        }

        listEl.innerHTML = filteredProducts.map(product => {
          const childLimit = productLimitSettings.has(product.id) ? productLimitSettings.get(product.id) : -1;
          const instLimit = institutionProductLimits.get(product.id);
          const isModified = productLimitSettings.has(product.id) && productLimitSettings.get(product.id) !== -1;
          // -1 = Ubegr√¶nset, 0 = Blokeret, 1-99 = Gr√¶nse
          const displayValue = childLimit === -1 ? "Ubegr√¶nset" : (childLimit === 0 ? "Blokeret" : `${childLimit}/dag`);
          const valueClass = childLimit === 0 ? "is-zero" : (childLimit === -1 ? "is-unlimited" : "");

          // Vis institutionsgr√¶nse hvis den findes
          let instLimitNote = "";
          if (instLimit != null) {
            instLimitNote = `<span style="font-size: 9px; color: #9ca3af;">(Klub: maks ${instLimit})</span>`;
          }

          // Produktikon
          let iconHtml = "";
          if (product.icon_url) {
            iconHtml = `<img src="${product.icon_url}" alt="${product.name}" class="product-limit-item-icon" style="object-fit: contain;" />`;
          } else {
            iconHtml = `<div class="product-limit-item-icon">${product.emoji || "üõí"}</div>`;
          }

          return `
            <div class="product-limit-item ${isModified ? 'is-modified' : ''}" data-product-id="${product.id}">
              <div class="product-limit-item-info">
                ${iconHtml}
                <div class="product-limit-item-details">
                  <div class="product-limit-item-name">${product.name || "Ukendt"}</div>
                  <div class="product-limit-item-price">${product.price ? product.price.toFixed(2) + " kr." : ""} ${instLimitNote}</div>
                </div>
              </div>
              <div class="product-limit-stepper" data-product-id="${product.id}">
                <button type="button" class="stepper-dec" title="Mindre">‚àí</button>
                <span class="product-limit-stepper-value ${valueClass}">${displayValue}</span>
                <button type="button" class="stepper-inc" title="Mere">+</button>
              </div>
            </div>
          `;
        }).join("");
      }

      let productLimitEventsWired = false;
      function wireProductLimitEvents() {
        if (productLimitEventsWired) return; // Undg√• dobbelt-binding
        productLimitEventsWired = true;

        const listEl = document.getElementById("product-limit-list");
        const searchInput = document.getElementById("product-limit-search");
        const filterToggle = document.getElementById("product-limit-filter-toggle");
        const showModifiedCheckbox = document.getElementById("product-limit-show-modified");
        const saveBtn = document.getElementById("save-product-limits-btn");
        const feedback = document.getElementById("product-limit-feedback");

        // S√∏gning
        if (searchInput) {
          searchInput.addEventListener("input", () => {
            renderProductLimitList();
          });
        }

        // Filter toggle
        if (filterToggle && showModifiedCheckbox) {
          filterToggle.addEventListener("click", () => {
            showModifiedCheckbox.checked = !showModifiedCheckbox.checked;
            filterToggle.classList.toggle("is-active", showModifiedCheckbox.checked);
            renderProductLimitList();
          });
        }

        // Stepper controls (event delegation)
        if (listEl) {
          listEl.addEventListener("click", (e) => {
            const btn = e.target.closest(".stepper-dec, .stepper-inc");
            if (!btn) return;

            const stepper = btn.closest(".product-limit-stepper");
            const productId = stepper?.dataset.productId;
            if (!productId) return;

            const currentValue = productLimitSettings.has(productId) ? productLimitSettings.get(productId) : -1;
            const isInc = btn.classList.contains("stepper-inc");

            // Logik (loop begge veje):
            // dec: -1 ‚Üí 5 ‚Üí 4 ‚Üí 3 ‚Üí 2 ‚Üí 1 ‚Üí 0 ‚Üí -1
            // inc: -1 ‚Üí 0 ‚Üí 1 ‚Üí 2 ‚Üí 3 ‚Üí 4 ‚Üí 5 ‚Üí -1
            let newValue;
            if (currentValue === -1) {
              // Ubegr√¶nset: dec ‚Üí 5, inc ‚Üí 0
              newValue = isInc ? 0 : 5;
            } else if (currentValue === 0) {
              // Blokeret: dec ‚Üí -1 (Ubegr√¶nset), inc ‚Üí 1
              newValue = isInc ? 1 : -1;
            } else if (currentValue === 5) {
              // Maks: dec ‚Üí 4, inc ‚Üí -1 (Ubegr√¶nset)
              newValue = isInc ? -1 : 4;
            } else {
              // Normal v√¶rdi 1-4: +/- 1
              newValue = isInc ? currentValue + 1 : currentValue - 1;
            }

            productLimitSettings.set(productId, newValue);

            renderProductLimitList();
            if (feedback) feedback.textContent = "";
          });
        }

        // Gem knap
        if (saveBtn) {
          saveBtn.addEventListener("click", async () => {
            await saveProductLimits();
          });
        }
      }

      async function saveProductLimits() {
        const saveBtn = document.getElementById("save-product-limits-btn");
        const feedback = document.getElementById("product-limit-feedback");

        if (!currentChildId || !currentInstitutionId) {
          if (feedback) feedback.textContent = "Fejl: Mangler barn eller institution.";
          return;
        }

        if (saveBtn) saveBtn.disabled = true;
        if (feedback) feedback.textContent = "Gemmer...";

        try {
          // Byg limits array fra Map (filtrer -1 ud, da det betyder "ubegr√¶nset/ingen gr√¶nse")
          const limits = [];
          productLimitSettings.forEach((maxPerDay, productId) => {
            if (maxPerDay !== -1) {
              limits.push({ product_id: productId, max_per_day: maxPerDay });
            }
          });

          // Kald Edge Function (bypasser RLS sikkert med PIN-verifikation)
          const response = await fetch(`${SUPABASE_URL}/functions/v1/save-parent-limits`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "apikey": SUPABASE_ANON_KEY,
              "Authorization": `Bearer ${SUPABASE_ANON_KEY}`,
            },
            body: JSON.stringify({ child_id: currentChildId, parent_pin: currentParentPin, limits }),
          });

          const result = await response.json();

          if (!response.ok || !result.success) {
            throw new Error(result.error || "Kunne ikke gemme gr√¶nser.");
          }

          if (feedback) {
            feedback.textContent = "Gemt ‚úÖ";
            feedback.style.color = "#16a34a";
          }

          // Clear feedback efter 3 sekunder
          setTimeout(() => {
            if (feedback) feedback.textContent = "";
          }, 3000);

        } catch (err) {
          console.error("Fejl ved gemning af produktgr√¶nser:", err);
          if (feedback) {
            feedback.textContent = "Fejl ved gemning. Pr√∏v igen.";
            feedback.style.color = "#dc2626";
          }
        } finally {
          if (saveBtn) saveBtn.disabled = false;
        }
      }

      async function loadInstitutionPreferences(institutionId) {
        if (!institutionId) return null;
        try {
          const { data, error } = await supabase
            .from("institutions")
            .select("*")
            .eq("id", institutionId)
            .single();

          if (error) {
            console.warn("Kunne ikke hente institutions-pr√¶ferencer:", error);
            return null;
          }
          return data || null;
        } catch (e) {
          console.warn("Uventet fejl ved hentning af institutions-pr√¶ferencer:", e);
          return null;
        }
      }

      const balanceStatusLabel = document.getElementById("balance-status-label");
      const balanceDisplay = document.getElementById("balance-display");

      function collectAllergySettingsFromUI() {
        const map = new Map(); // allergen -> policy

        allergyButtons.forEach((btn) => {
          const allergen = btn.dataset.allergen;
          if (!allergen) return;

          if (btn.classList.contains("is-active-allow")) {
            map.set(allergen, "allow");
          } else if (btn.classList.contains("is-active-warn")) {
            map.set(allergen, "warn");
          } else if (btn.classList.contains("is-active-block")) {
            map.set(allergen, "block");
          }
        });

        return Array.from(map.entries()).map(([allergen, policy]) => ({
          allergen,
          policy,
        }));
      }

      function setAllergyPolicyInUI(allergenKey, policy) {
        // F√∏rst: fjern aktive klasser for alle tre knapper i denne allergi-gruppe
        allergyButtons.forEach((btn) => {
          if (btn.dataset.allergen !== allergenKey) return;
          btn.classList.remove("is-active-allow", "is-active-warn", "is-active-block");
        });

        // Derefter: find den knap der matcher policy og giv den en tydelig aktiv tilstand
        allergyButtons.forEach((btn) => {
          if (btn.dataset.allergen !== allergenKey) return;
          if (btn.dataset.policy !== policy) return;

          if (policy === "allow") {
            btn.classList.add("is-active-allow");
          } else if (policy === "warn") {
            btn.classList.add("is-active-warn");
          } else if (policy === "block") {
            btn.classList.add("is-active-block");
          }
        });
      }

      function applyAllergySettingsFromData(allergySettings) {
        if (!allergySettings || !Array.isArray(allergySettings)) {
          // Default: mark all as "Tillad" i UI
          const uniqueAllergens = new Set();
          allergyButtons.forEach((btn) => {
            uniqueAllergens.add(btn.dataset.allergen);
          });
          uniqueAllergens.forEach((key) => {
            setAllergyPolicyInUI(key, "allow");
          });
          return;
        }

        // allergySettings forventes at v√¶re en liste af { allergen: string, policy: 'allow'|'warn'|'block' }
        const seen = new Set();
        allergySettings.forEach((entry) => {
          if (!entry || !entry.allergen || !entry.policy) return;
          seen.add(entry.allergen);
          setAllergyPolicyInUI(entry.allergen, entry.policy);
        });

        // Alt hvad vi ikke har data for ‚Üí "allow" i UI
        allergyButtons.forEach((btn) => {
          const key = btn.dataset.allergen;
          if (!seen.has(key)) {
            setAllergyPolicyInUI(key, "allow");
          }
        });
      }

     async function loadAllergySettingsForChild(childId) {
  if (!childId) return;
  try {
    const res = await fetch(
      `${GET_ALLERGY_URL}?child_id=${encodeURIComponent(childId)}`,
      {
        method: "GET",
        headers: {
          apikey: SUPABASE_ANON_KEY,
          Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
        },
      }
    );

    if (!res.ok) {
      console.warn("Kunne ikke hente allergi-indstillinger (HTTP):", res.status);
      return;
    }

    const data = await res.json().catch(() => ({}));
    if (!data || data.success === false) {
      console.warn("Kunne ikke hente allergi-indstillinger:", data && data.error);
      return;
    }

    if (data.settings && Array.isArray(data.settings)) {
      applyAllergySettingsFromData(data.settings);
    }
  } catch (err) {
    console.error("Netv√¶rksfejl ved hentning af allergier:", err);
  }
}

      allergyButtons.forEach((btn) => {
        btn.addEventListener("click", () => {
          const allergenKey = btn.dataset.allergen;
          const policy = btn.dataset.policy;
          setAllergyPolicyInUI(allergenKey, policy);
          // Her kan du senere tilf√∏je kald til Supabase Edge Function for at gemme valget.
        });
      });

      // Quick-valg til daglig bel√∏bsgr√¶nse (20, 30, 40, 50 kr.)
      if (dailyLimitChips && dailyLimitChips.length) {
        dailyLimitChips.forEach((chip) => {
          chip.addEventListener("click", () => {
            const amount = chip.dataset.amount;
            if (dailyLimitInput) {
              dailyLimitInput.value = amount || "";
              dailyLimitInput.focus();
            }

            dailyLimitChips.forEach((c) => c.classList.remove("is-active"));
            chip.classList.add("is-active");

            if (dailyLimitFeedback) {
              dailyLimitFeedback.textContent = "";
            }
          });
        });
      }

      if (saveAllergyBtn) {
        saveAllergyBtn.addEventListener("click", async () => {
          if (!currentChildId) {
            allergyFeedback.textContent = "Fejl: Log ind f√∏rst.";
            allergyFeedback.style.color = "#dc3545";
            return;
          }

          const settings = collectAllergySettingsFromUI();

          saveAllergyBtn.disabled = true;
          const originalText = saveAllergyBtn.textContent;
          saveAllergyBtn.textContent = "Gemmer...";
          allergyFeedback.textContent = "";

          try {
            const res = await fetch(SAVE_ALLERGY_URL, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                apikey: SUPABASE_ANON_KEY,
                Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
              },
              body: JSON.stringify({
                child_id: currentChildId,
                allergy_settings: settings,
              }),
            });

            const data = await res.json().catch(() => ({}));

            if (!res.ok || data.success === false) {
              allergyFeedback.textContent =
                data.error || "Fejl: Kunne ikke gemme allergier.";
              allergyFeedback.style.color = "#dc3545";
              return;
            }

            allergyFeedback.textContent = "Allergi-indstillinger er gemt.";
            allergyFeedback.style.color = "#16a34a";
          } catch (err) {
            console.error("Fejl ved gemning af allergier:", err);
            allergyFeedback.textContent =
              "Fejl: Kunne ikke gemme. Pr√∏v igen.";
            allergyFeedback.style.color = "#dc3545";
          } finally {
            saveAllergyBtn.disabled = false;
            saveAllergyBtn.textContent = originalText;
          }
        });
      }

      if (saveDailyLimitBtn) {
        saveDailyLimitBtn.addEventListener("click", async () => {
          if (!currentChildId) {
            if (dailyLimitFeedback) {
              dailyLimitFeedback.textContent = "Fejl: Log ind f√∏rst.";
              dailyLimitFeedback.style.color = "#dc3545";
            }
            return;
          }

          if (!dailyLimitInput) return;

          const raw = (dailyLimitInput.value || "").trim();
          if (!raw) {
            if (dailyLimitFeedback) {
              dailyLimitFeedback.textContent = "Skriv et bel√∏b i kroner.";
              dailyLimitFeedback.style.color = "#dc3545";
            }
            return;
          }

          const parsed = Number(raw.replace(",", "."));
          if (!Number.isFinite(parsed) || parsed < 0) {
            if (dailyLimitFeedback) {
              dailyLimitFeedback.textContent = "Bel√∏bet skal v√¶re et tal p√• mindst 0 kr.";
              dailyLimitFeedback.style.color = "#dc3545";
            }
            return;
          }

          const limit = Math.round(parsed);

          saveDailyLimitBtn.disabled = true;
          const originalText = saveDailyLimitBtn.textContent;
          saveDailyLimitBtn.textContent = "Gemmer...";
          if (dailyLimitFeedback) dailyLimitFeedback.textContent = "";

          try {
            const res = await fetch(SAVE_DAILY_LIMIT_URL, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                apikey: SUPABASE_ANON_KEY,
                Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
              },
              body: JSON.stringify({
                child_id: currentChildId,
                daily_spend_limit: limit, // forventes at v√¶re i kroner pr. dag
              }),
            });

            const data = await res.json().catch(() => ({}));

            if (!res.ok || data.success === false) {
              if (dailyLimitFeedback) {
                dailyLimitFeedback.textContent =
                  data.error || "Fejl: Kunne ikke gemme bel√∏bsgr√¶nsen.";
                dailyLimitFeedback.style.color = "#dc3545";
              }
              return;
            }

            if (dailyLimitFeedback) {
              dailyLimitFeedback.textContent = "Bel√∏bsgr√¶nsen er gemt.";
              dailyLimitFeedback.style.color = "#16a34a";
            }
          } catch (err) {
            console.error("Fejl ved gemning af daglig bel√∏bsgr√¶nse:", err);
            if (dailyLimitFeedback) {
              dailyLimitFeedback.textContent =
                "Fejl: Kunne ikke gemme bel√∏bsgr√¶nsen. Pr√∏v igen.";
              dailyLimitFeedback.style.color = "#dc3545";
            }
          } finally {
            saveDailyLimitBtn.disabled = false;
            saveDailyLimitBtn.textContent = originalText;
          }
        });
      }

      loadInstitutions();

      async function loadInstitutions() {
        try {
          const { data, error } = await supabase
            .from("institutions")
            .select("id, name")
            .order("name", { ascending: true });
      
          if (error) {
            console.error("Fejl ved hentning af institutioner", error);
            return;
          }
      
          // Ingen institutioner
          if (!data || data.length === 0) {
            institutionSelect.innerHTML =
              '<option value="">Ingen institutioner tilg√¶ngelige</option>';
            if (institutionRow) institutionRow.style.display = "block";
            if (institutionInfo) {
              institutionInfo.style.display = "none";
              if (institutionNameLabel) institutionNameLabel.textContent = "";
            }
            return;
          }
      
          // KUN √©n institution (fx Stampen) ‚Üí auto-v√¶lg + skjul dropdown
          if (data.length === 1) {
            const inst = data[0];
      
            // S√¶t select til kun denne institution
            institutionSelect.innerHTML = `<option value="${inst.id}">${inst.name}</option>`;
            institutionSelect.value = inst.id;
            institutionSelect.disabled = false; // S√∏rg for at dropdownen er aktiv

            // Vis dropdown-r√¶kken og skift label-teksten til det, du √∏nsker
            if (institutionRow) institutionRow.style.display = "block";
            if (institutionLabel) institutionLabel.textContent = "Institutioner i n√¶rheden af dig:";

            // Skjul den alternative info-tekst
            if (institutionInfo) institutionInfo.style.display = "none";

            return;
          }
      
          // FLERE institutioner ‚Üí almindelig dropdown
          const options =
            '<option value="">V√¶lg klub/SFO‚Ä¶</option>' +
            data
              .map(
                (inst) =>
                  `<option value="${inst.id}">${inst.name}</option>`
              )
              .join("");
      
          institutionSelect.innerHTML = options;
          institutionSelect.disabled = false; // S√∏rg for at den er aktiv
      
          // S√∏rg for at dropdown vises, og info-teksten skjules
          if (institutionRow) institutionRow.style.display = "block";
          if (institutionLabel) institutionLabel.textContent = "V√¶lg klub/SFO";
          if (institutionInfo) institutionInfo.style.display = "none";
        } catch (e) {
          console.error("Uventet fejl ved hentning af institutioner", e);
        }
      }
      loginForm.addEventListener("submit", async (event) => {
        event.preventDefault();
        loginError.style.display = "none";

        const institutionId = institutionSelect.value;
        currentInstitutionId = institutionId;
        const nameInput = document
          .getElementById("child-name-input")
          .value.trim();
        const parentPin = document
          .getElementById("parent-pin-input")
          .value.trim();

        if (!institutionId) {
          loginError.textContent = "V√¶lg f√∏rst klub/SFO.";
          loginError.style.display = "block";
          return;
        }

        if (!nameInput || !parentPin) {
          loginError.textContent = "Udfyld navn og kode.";
          loginError.style.display = "block";
          return;
        }

        loginBtn.disabled = true;
        loginBtn.textContent = "Logger ind...";

        try {
          const res = await fetch(FUNCTION_URL, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              apikey: SUPABASE_ANON_KEY,
              Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
            },
            body: JSON.stringify({
              institution_id: institutionId,
              name_input: nameInput,
              parent_pin: parentPin,
            }),
          });

          const data = await res.json().catch(() => ({}));

          if (!res.ok) {
            console.log("Fejl fra server:", data);

            if (data.error_code === "MULTIPLE_MATCHES") {
              loginError.textContent =
                "Der er flere b√∏rn med dette navn. Skriv barnets fulde navn.";
            } else if (data.error) {
              loginError.textContent = data.error;
            } else {
              loginError.textContent =
                "Forkert navn eller kode. Tjek navn + kode og pr√∏v igen.";
            }

            loginError.style.display = "block";
            return;
          }

          displayResults(data);
          currentParentPin = parentPin; // Gem PIN til senere brug (produktgr√¶nser)
          // Hent institutions-pr√¶ferencer og render betalingsmuligheder + funktioner
          currentInstitutionPrefs = await loadInstitutionPreferences(institutionId);
          renderPaymentSection(currentInstitutionPrefs || {});
          renderFeatureSections(currentInstitutionPrefs || {});
        } catch (err) {
          console.error("Fetch-fejl:", err);
          loginError.textContent =
            "Der opstod en netv√¶rksfejl. Pr√∏v igen eller kontakt SFO‚Äôen.";
          loginError.style.display = "block";
        } finally {
          loginBtn.disabled = false;
          loginBtn.textContent = "Se saldo og historik";
        }
      });

      logoutBtn.addEventListener("click", () => {
        loginView.style.display = "block";
        resultsView.style.display = "none";
        loginForm.reset();
        loginError.style.display = "none";

        notifyFeedback.textContent = "";
        parentEmailInput.value = "";
        notifyZeroCheckbox.checked = false;
        notifyTenCheckbox.checked = false;

        // Nulstil allergi/limits UI
        if (allergyFeedback) allergyFeedback.textContent = "";
        if (dailyLimitFeedback) dailyLimitFeedback.textContent = "";
        if (dailyLimitInput) dailyLimitInput.value = "";
        if (dailyLimitChips && dailyLimitChips.length) {
          dailyLimitChips.forEach((chip) => chip.classList.remove("is-active"));
        }

        currentInstitutionId = null;
        currentInstitutionPrefs = null;
        selectedTopupAmount = null;
        if (paymentFeedback) paymentFeedback.textContent = "";
        if (paymentQrWrap) paymentQrWrap.style.display = "none";
        if (paymentGrid) paymentGrid.innerHTML = "";
        if (paymentCard) paymentCard.style.display = "none";
        currentChildId = null;
        currentParentPin = null;
      });

      if (changePinForm) {
        changePinForm.addEventListener("submit", async (event) => {
          event.preventDefault();
          if (!changePinMessage) return;

          changePinMessage.style.display = "none";
          changePinMessage.textContent = "";
          changePinMessage.style.color = "";

          const newPin = newPinInput.value.trim();
          const confirmPin = confirmNewPinInput.value.trim();

          if (!currentChildId) {
            changePinMessage.textContent =
              "Der opstod en fejl. Pr√∏v at logge ind igen og fors√∏g derefter at skifte kode.";
            changePinMessage.style.color = "var(--danger-color)";
            changePinMessage.style.display = "block";
            return;
          }

          if (!newPin || !confirmPin) {
            changePinMessage.textContent = "Udfyld begge felter.";
            changePinMessage.style.color = "var(--danger-color)";
            changePinMessage.style.display = "block";
            return;
          }

          if (newPin !== confirmPin) {
            changePinMessage.textContent =
              "De to nye koder er ikke ens. Pr√∏v igen.";
            changePinMessage.style.color = "var(--danger-color)";
            changePinMessage.style.display = "block";
            return;
          }

          if (newPin.length < 4) {
            changePinMessage.textContent =
              "Koden skal mindst v√¶re p√• 4 tegn.";
            changePinMessage.style.color = "var(--danger-color)";
            changePinMessage.style.display = "block";
            return;
          }

          try {
            const res = await fetch(UPDATE_PIN_URL, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                apikey: SUPABASE_ANON_KEY,
                Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
              },
              body: JSON.stringify({
                child_id: currentChildId,
                new_pin: newPin,
                source: 'parent', // Mark this change as coming from a parent
              }),
            });

            const data = await res.json();

            if (!res.ok || !data.success) {
              console.error("Fejl ved skift af kode:", data);
              throw new Error(data.error || "Der opstod en fejl under skift af kode. Pr√∏v igen.");
            }

            changePinMessage.textContent = "Din kode er nu opdateret.";
            changePinMessage.style.color = "var(--success-color)";
            changePinMessage.style.display = "block";
            newPinInput.value = "";
            confirmNewPinInput.value = "";
          } catch (e) {
            console.error("Uventet fejl ved skift af kode:", e);
            changePinMessage.textContent = "Uventet fejl. Pr√∏v igen lidt senere.";
            changePinMessage.style.color = "var(--danger-color)";
            changePinMessage.style.display = "block";
          }
        });
      }

      saveNotifyBtn.addEventListener("click", async () => {
        if (!currentChildId) {
          notifyFeedback.textContent = "Fejl: Ingen barnedata indl√¶st.";
          notifyFeedback.style.color = "#dc3545";
          return;
        }

        const email = parentEmailInput.value.trim();
        const notifyAtZero = notifyZeroCheckbox.checked;
        const notifyAtTen = notifyTenCheckbox.checked;

        if (!email) {
          notifyFeedback.textContent = "Indtast venligst en e-mailadresse.";
          notifyFeedback.style.color = "#dc3545";
          return;
        }

        saveNotifyBtn.disabled = true;
        saveNotifyBtn.textContent = "Gemmer...";

        try {
          const res = await fetch(SAVE_NOTIFY_URL, {
  method: "POST",
  headers: {
    "Content-Type": "application/json",
    apikey: SUPABASE_ANON_KEY,
    // VIGTIGT: til Edge Functions med Verify JWT
    Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
  },
  body: JSON.stringify({
    child_id: currentChildId,
    email: email,
    notify_at_zero: notifyAtZero,
    notify_at_ten: notifyAtTen,
  }),
});

          const data = await res.json().catch(() => ({}));

          if (!res.ok || data.success === false) {
            notifyFeedback.textContent = data.error || "Fejl: Kunne ikke gemme.";
            notifyFeedback.style.color = "#dc3545";
            return;
          }

          notifyFeedback.textContent = "Dine indstillinger er gemt!";
          notifyFeedback.style.color = "#28a745";
        } catch (err) {
          console.error("Fejl ved gemning af notifikationer:", err);
          notifyFeedback.textContent = "Fejl: Kunne ikke gemme. Pr√∏v igen.";
          notifyFeedback.style.color = "#dc3545";
        } finally {
          saveNotifyBtn.disabled = false;
          saveNotifyBtn.textContent = "Gem e-mail-beskeder";
        }
      });

      function updateBalanceStatus(balance) {
        const b = Number(balance) || 0;

        balanceDot.classList.remove("low", "negative");
        if (b <= 0) {
          balanceDot.classList.add("negative");
          balanceStatusLabel.textContent = "Saldo under 0 kr.";
        } else if (b <= 10) {
          balanceDot.classList.add("low");
          balanceStatusLabel.textContent = "Lav saldo";
        } else {
          balanceStatusLabel.textContent = "OK saldo";
        }
      }

      function displayResults(data) {
        currentChildId = data.child_id || null;
        // Hvis vi allerede har institutionspr√¶ferencer, s√• render betalingsmuligheder + funktioner
        if (currentInstitutionPrefs) {
          renderPaymentSection(currentInstitutionPrefs || {});
          renderFeatureSections(currentInstitutionPrefs || {});
        } else if (currentInstitutionId) {
          loadInstitutionPreferences(currentInstitutionId).then((prefs) => {
            currentInstitutionPrefs = prefs || {};
            renderPaymentSection(currentInstitutionPrefs || {});
            renderFeatureSections(currentInstitutionPrefs || {});
          });
        }

        if (currentChildId && typeof loadAllergySettingsForChild === "function") {
          loadAllergySettingsForChild(currentChildId);
        }

        document.getElementById("child-name-display").textContent =
          data.child_name || "";
        const balance =
          typeof data.balance === "number"
            ? data.balance
            : Number(data.balance || 0);
        balanceDisplay.textContent = balance.toFixed(2) + " kr";
        updateBalanceStatus(balance);

        const historyList = document.getElementById("history-list");
        historyList.innerHTML = "";

        if (!data.history || data.history.length === 0) {
          const li = document.createElement("li");
          li.textContent = "Ingen historik fundet.";
          li.style.fontSize = "14px";
          li.style.color = "#6b7280";
          li.style.padding = "6px 2px";
          historyList.appendChild(li);
        } else {
          data.history.forEach((item) => {
            const li = document.createElement("li");
            li.className = "history-item";

            const date = new Date(item.date).toLocaleDateString("da-DK", {
              day: "2-digit",
              month: "short",
              year: "numeric",
            });

            const main = document.createElement("div");
            main.className = "history-main";

            const descRow = document.createElement("div");
            descRow.className = "history-row";

            const dateEl = document.createElement("div");
            dateEl.className = "history-date";
            dateEl.textContent = date;

            const typeEl = document.createElement("div");
            typeEl.className = "history-type";
            typeEl.textContent = item.type === "SALE" ? "K√∏b" : "Optankning";

            descRow.appendChild(dateEl);
            descRow.appendChild(typeEl);

            const desc = document.createElement("div");
            desc.className = "history-desc";
            desc.textContent = item.description || "";

            const meta = document.createElement("div");
            meta.className = "history-meta";
            meta.textContent = item.meta || "";

            main.appendChild(descRow);
            main.appendChild(desc);
            if (item.meta) main.appendChild(meta);

            const amountEl = document.createElement("div");
            amountEl.className = "history-amount";

            if (typeof item.amount === "number") {
              const amount = item.amount.toFixed(2) + " kr";
              amountEl.textContent = amount;

              if (item.type === "SALE") {
                amountEl.classList.add("sale");
              } else if (item.type === "DEPOSIT") {
                amountEl.classList.add("deposit");
              }
            } else {
              amountEl.textContent = "";
            }

            li.appendChild(main);
            li.appendChild(amountEl);
            historyList.appendChild(li);
          });
        }

        notifyFeedback.textContent = "";
        if (data.notification_settings) {
          const ns = data.notification_settings;
          parentEmailInput.value = ns.email || "";
          notifyZeroCheckbox.checked = !!ns.notify_at_zero;
          notifyTenCheckbox.checked = !!ns.notify_at_ten;
          if (ns.email) {
            notifyFeedback.textContent = "Tidligere indstillinger er indl√¶st.";
            notifyFeedback.style.color = "#28a745";
          }
        } else {
          parentEmailInput.value = "";
          notifyZeroCheckbox.checked = false;
          notifyTenCheckbox.checked = false;
        }

        // Daglig bel√∏bsgr√¶nse (valgfri) ‚Äì forventer at backend evt. sender `daily_spend_limit` i kroner
        if (dailyLimitInput) {
          const limitRaw = data.daily_spend_limit;
          if (limitRaw !== undefined && limitRaw !== null && !isNaN(Number(limitRaw))) {
            const limit = Number(limitRaw);
            dailyLimitInput.value = limit.toString();

            if (dailyLimitChips && dailyLimitChips.length) {
              dailyLimitChips.forEach((chip) => {
                chip.classList.remove("is-active");
                if (Number(chip.dataset.amount) === limit) {
                  chip.classList.add("is-active");
                }
              });
            }

            if (dailyLimitFeedback) {
              dailyLimitFeedback.textContent = "";
            }
          } else {
            dailyLimitInput.value = "";
            if (dailyLimitChips && dailyLimitChips.length) {
              dailyLimitChips.forEach((chip) => chip.classList.remove("is-active"));
            }
            if (dailyLimitFeedback) {
              dailyLimitFeedback.textContent = "";
            }
          }
        }

        // Allergi-indstillinger (valgfrit felt fra backend)
        if (typeof applyAllergySettingsFromData === "function") {
          applyAllergySettingsFromData(data.allergy_settings || null);
        }

        loginView.style.display = "none";
        resultsView.style.display = "block";
      }
    });
  </script>
</body>
</html>