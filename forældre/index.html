<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Flango Forældre-portal</title>

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@700&family=Nunito:wght@400;600;700&display=swap"
    rel="stylesheet"
  />

  <style>
    :root {
      --primary-color: #ff7a3c;
      --primary-color-soft: rgba(255, 122, 60, 0.12);
      --secondary-color: #3c7dff;
      --secondary-soft: rgba(60, 125, 255, 0.12);
      --accent-color: #ffc857;
      --background-gradient: radial-gradient(circle at top left, #ffe1c7 0, #f5f7ff 40%, #dfe8ff 100%);
      --card-bg: rgba(255, 255, 255, 0.88);
      --border-soft: rgba(255, 255, 255, 0.6);
      --shadow-soft: 0 18px 45px rgba(15, 23, 42, 0.18);
      --success-color: #28a745;
      --danger-color: #dc3545;
      --warning-color: #ffb100;
      --font-body: "Nunito", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      --font-heading: "Baloo 2", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: var(--font-body);
      background: var(--background-gradient);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 18px;
      color: #111827;
    }

    .page-wrapper {
      max-width: 960px;
      width: 100%;
    }

    .logo-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 18px;
    }

    .logo {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-family: var(--font-heading);
      font-size: 24px;
      font-weight: 700;
      color: #111827;
    }

    .logo-badge {
      width: 34px;
      height: 34px;
      border-radius: 14px;
      background: linear-gradient(135deg, #ff9d5a, #ff7a3c);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-size: 18px;
      box-shadow: 0 12px 25px rgba(249, 115, 22, 0.35);
    }

    .logo-text-main {
      display: flex;
      flex-direction: column;
      line-height: 1;
    }

    .logo-name {
      font-size: 20px;
      letter-spacing: 0.02em;
    }

    .logo-tagline {
      font-size: 11px;
      color: #6b7280;
      margin-top: 3px;
    }

    .top-tag {
      font-size: 12px;
      color: #6b7280;
      background: rgba(255, 255, 255, 0.5);
      padding: 6px 10px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border: 1px solid rgba(255, 255, 255, 0.7);
      box-shadow: 0 10px 25px rgba(148, 163, 184, 0.18);
    }

    .top-tag .dot {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: #22c55e;
      box-shadow: 0 0 0 5px rgba(34, 197, 94, 0.22);
    }

    .container {
      background: var(--card-bg);
      border-radius: 26px;
      padding: 28px 22px 24px;
      box-shadow: var(--shadow-soft);
      border: 1px solid var(--border-soft);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      position: relative;
      overflow: hidden;
    }

    .container::before,
    .container::after {
      content: "";
      position: absolute;
      border-radius: 999px;
      filter: blur(0);
      opacity: 0.7;
      pointer-events: none;
    }

    .container::before {
      width: 220px;
      height: 220px;
      background: radial-gradient(circle, rgba(60, 125, 255, 0.16), transparent 60%);
      top: -90px;
      right: -100px;
    }

    .container::after {
      width: 180px;
      height: 180px;
      background: radial-gradient(circle, rgba(255, 122, 60, 0.16), transparent 60%);
      bottom: -70px;
      left: -80px;
    }

    .container-inner {
      position: relative;
      z-index: 1;
      display: grid;
      grid-template-columns: minmax(0, 1.25fr) minmax(0, 1.1fr);
      gap: 24px;
      align-items: stretch;
    }

    .intro-section {
      padding-right: 4px;
    }

    .title-row {
      display: flex;
      flex-wrap: wrap;
      align-items: flex-start;
      gap: 8px 10px;
      margin-bottom: 6px;
    }

    h1 {
      font-family: var(--font-heading);
      font-size: clamp(24px, 3vw, 28px);
      font-weight: 700;
      letter-spacing: 0.02em;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    h1 span.highlight {
      background: linear-gradient(120deg, #ff7a3c, #ffb100);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }

    .subtitle {
      font-size: 14px;
      color: #4b5563;
      margin-bottom: 18px;
      max-width: 400px;
    }

    .pill-tag {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: rgba(255, 255, 255, 0.9);
      padding: 6px 11px;
      border-radius: 999px;
      border: 1px solid rgba(226, 232, 240, 0.9);
      font-size: 12px;
      color: #4b5563;
      box-shadow: 0 10px 25px rgba(148, 163, 184, 0.22);
    }

    .pill-dot {
      width: 9px;
      height: 9px;
      border-radius: 999px;
      background: linear-gradient(135deg, #3c7dff, #22c55e);
      box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.22);
    }

    .info-cards {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
      margin-bottom: 18px;
    }

    .info-card {
      background: linear-gradient(135deg, rgba(60, 125, 255, 0.08), rgba(255, 255, 255, 0.95));
      border-radius: 16px;
      padding: 11px 12px 10px;
      border: 1px solid rgba(226, 232, 240, 0.9);
      box-shadow: 0 12px 25px rgba(148, 163, 184, 0.22);
      display: grid;
      grid-template-columns: auto 1fr;
      gap: 8px;
      align-items: flex-start;
    }

    .info-icon {
      width: 34px;
      height: 34px;
      border-radius: 999px;
      background: rgba(59, 130, 246, 0.08);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }

    .info-content {
      font-size: 12px;
      color: #374151;
    }

    .info-content strong {
      display: block;
      font-size: 13px;
      margin-bottom: 2px;
      color: #111827;
    }

    .help-text {
      font-size: 12px;
      color: #6b7280;
      margin-bottom: 6px;
    }

    .help-text strong {
      color: #111827;
    }

    .club-limitations-card {
      background: linear-gradient(135deg, rgba(255, 122, 60, 0.06), rgba(255, 255, 255, 0.98));
      border-radius: 18px;
      padding: 16px 18px;
      border: 1px solid rgba(255, 122, 60, 0.2);
      box-shadow: 0 12px 25px rgba(15, 23, 42, 0.12);
      margin-top: 12px;
    }

    .club-limitations-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 14px;
    }

    .club-limitations-icon {
      width: 36px;
      height: 36px;
      border-radius: 999px;
      background: rgba(255, 122, 60, 0.12);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      flex-shrink: 0;
    }

    .club-limitations-title {
      font-family: var(--font-heading);
      font-size: 17px;
      font-weight: 700;
      color: #111827;
      line-height: 1.3;
    }

    .club-limitations-description {
      font-size: 12px;
      color: #6b7280;
      margin-bottom: 14px;
      line-height: 1.5;
    }

    .club-limitations-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 14px;
    }

    .club-limitation-item {
      display: flex;
      flex-direction: column;
      gap: 6px;
      padding: 10px 12px;
      background: rgba(255, 255, 255, 0.7);
      border-radius: 12px;
      border: 1px solid rgba(226, 232, 240, 0.9);
    }

    .club-limitation-item-title {
      font-size: 13px;
      font-weight: 700;
      color: #111827;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .club-limitation-item-title::before {
      content: "•";
      color: var(--primary-color);
      font-size: 18px;
      line-height: 1;
    }

    .club-limitation-item-content {
      font-size: 12px;
      color: #4b5563;
      margin-left: 16px;
      line-height: 1.5;
    }

    .club-limitation-item-content .product-item {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-top: 4px;
    }

    .club-limitation-item-content .product-name {
      font-weight: 600;
      color: #111827;
    }

    .parent-settings-note {
      font-size: 12px;
      color: #6b7280;
      padding: 12px 14px;
      background: rgba(249, 250, 251, 0.8);
      border-radius: 12px;
      border: 1px solid rgba(226, 232, 240, 0.8);
      margin-top: 16px;
    }

    .parent-settings-note strong {
      display: block;
      font-size: 13px;
      color: #111827;
      margin-bottom: 4px;
    }

    /* Collapsible accordion sections */
    .collapsible-section-container {
      margin-top: 12px;
    }

    .collapsible-section-header {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(249, 250, 251, 0.95));
      border-radius: 14px;
      padding: 14px 16px;
      border: 1px solid rgba(226, 232, 240, 0.9);
      box-shadow: 0 8px 20px rgba(15, 23, 42, 0.1);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
      transition: all 0.2s ease;
      user-select: none;
    }

    .collapsible-section-header:hover {
      background: linear-gradient(135deg, rgba(255, 255, 255, 1), rgba(249, 250, 251, 1));
      box-shadow: 0 10px 24px rgba(15, 23, 42, 0.12);
      transform: translateY(-1px);
    }

    .collapsible-section-header.active {
      border-bottom-left-radius: 0;
      border-bottom-right-radius: 0;
      border-bottom: none;
    }

    .collapsible-section-title {
      display: flex;
      align-items: center;
      gap: 10px;
      font-family: var(--font-heading);
      font-size: 15px;
      font-weight: 600;
      color: #111827;
      flex: 1;
    }

    .collapsible-section-icon {
      width: 32px;
      height: 32px;
      border-radius: 999px;
      background: rgba(59, 130, 246, 0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      flex-shrink: 0;
    }

    .collapsible-section-arrow {
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.2s ease;
      color: #6b7280;
      font-size: 14px;
    }

    .collapsible-section-header.active .collapsible-section-arrow {
      transform: rotate(180deg);
    }

    .collapsible-section-content {
      background: rgba(255, 255, 255, 0.98);
      border-radius: 0 0 14px 14px;
      border: 1px solid rgba(226, 232, 240, 0.9);
      border-top: none;
      padding: 16px 18px;
      box-shadow: 0 8px 20px rgba(15, 23, 42, 0.1);
      display: none;
      overflow: hidden;
    }

    .collapsible-section-content.active {
      display: block;
    }

    .daily-assortment-card {
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.06), rgba(255, 255, 255, 0.98));
      border-radius: 18px;
      padding: 16px 18px;
      border: 1px solid rgba(59, 130, 246, 0.2);
      box-shadow: 0 12px 25px rgba(15, 23, 42, 0.12);
      margin-top: 12px;
    }

    .daily-assortment-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 14px;
    }

    .daily-assortment-icon {
      width: 36px;
      height: 36px;
      border-radius: 999px;
      background: rgba(59, 130, 246, 0.12);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      flex-shrink: 0;
    }

    .daily-assortment-title {
      font-family: var(--font-heading);
      font-size: 17px;
      font-weight: 700;
      color: #111827;
      line-height: 1.3;
    }

    .daily-assortment-description {
      font-size: 12px;
      color: #6b7280;
      margin-bottom: 14px;
      line-height: 1.5;
    }

    .daily-assortment-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 8px;
    }

    .daily-assortment-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 12px;
      background: rgba(255, 255, 255, 0.7);
      border-radius: 10px;
      border: 1px solid rgba(226, 232, 240, 0.9);
      font-size: 13px;
      color: #374151;
    }

    .daily-assortment-item .product-emoji {
      font-size: 18px;
      width: 28px;
      text-align: center;
      flex-shrink: 0;
    }

    .daily-assortment-item .product-name {
      flex: 1;
      font-weight: 500;
      color: #111827;
    }

    .daily-assortment-item .product-price {
      font-weight: 600;
      color: var(--primary-color);
      font-size: 13px;
    }

    .daily-assortment-empty {
      text-align: center;
      padding: 20px;
      color: #9ca3af;
      font-size: 12px;
      font-style: italic;
    }

    .login-section {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 20px;
      padding: 18px 18px 16px;
      border: 1px solid rgba(226, 232, 240, 0.9);
      box-shadow: 0 16px 30px rgba(15, 23, 42, 0.12);
      position: relative;
      overflow: hidden;
    }

    .login-section::before {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at top right, rgba(60, 125, 255, 0.08), transparent 55%);
      pointer-events: none;
    }

    .login-inner {
      position: relative;
      z-index: 1;
    }

    .section-title {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 15px;
      font-weight: 700;
      margin-bottom: 4px;
      color: #111827;
    }

    .section-title .icon {
      width: 30px;
      height: 30px;
      border-radius: 999px;
      background: rgba(255, 122, 60, 0.12);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }

    .section-subtitle {
      font-size: 13px;
      color: #6b7280;
      margin-bottom: 10px;
    }

    .login-form {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .login-form label.section-subtitle {
      margin-bottom: 4px;
    }

    .login-form input,
    .login-form select {
      border-radius: 999px;
      border: 1px solid #d1d5db;
      padding: 9px 14px;
      font-size: 14px;
      outline: none;
      transition: border-color 0.15s ease, box-shadow 0.15s ease, background-color 0.15s ease;
      background: rgba(249, 250, 251, 0.95);
      width: 100%;
    }

    .login-form input:focus,
    .login-form select:focus {
      border-color: #3b82f6;
      box-shadow: 0 0 0 1px rgba(59, 130, 246, 0.25);
      background: #ffffff;
    }

    .login-form input::placeholder {
      color: #9ca3af;
      font-size: 13px;
    }

    .login-form select {
      font-size: 13px;
    }

    .login-form button {
      margin-top: 4px;
      border-radius: 999px;
      border: none;
      padding: 10px 16px;
      font-size: 14px;
      font-weight: 600;
      background: linear-gradient(135deg, #ff7a3c, #ffb100);
      color: white;
      cursor: pointer;
      transition: transform 0.12s ease, box-shadow 0.12s ease, filter 0.12s ease;
      box-shadow: 0 14px 25px rgba(248, 113, 22, 0.4);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .login-form button:hover {
      transform: translateY(-1px);
      box-shadow: 0 18px 32px rgba(248, 113, 22, 0.5);
      filter: brightness(1.03);
    }

    .login-form button:active {
      transform: translateY(0);
      box-shadow: 0 10px 20px rgba(248, 113, 22, 0.35);
      filter: brightness(0.98);
    }

    .login-form button:disabled {
      opacity: 0.7;
      cursor: default;
      box-shadow: none;
      transform: none;
    }

    .error-message {
      color: var(--danger-color);
      font-size: 12px;
      margin-top: 4px;
    }

    .login-help {
      margin-top: 10px;
      font-size: 12px;
      color: #6b7280;
      line-height: 1.45;
    }

    .login-help strong {
      color: #111827;
    }

    .results-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
      gap: 10px;
    }

    .child-info {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .child-name {
      font-size: 16px;
      font-weight: 700;
    }

    .balance-chip {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      border-radius: 999px;
      padding: 7px 14px;
      background: rgba(249, 250, 251, 0.96);
      border: 1px solid rgba(226, 232, 240, 0.85);
      font-size: 13px;
      color: #111827;
    }

    .balance-dot {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.22);
    }

    .balance-dot.low {
      background: var(--warning-color);
      box-shadow: 0 0 0 4px rgba(251, 191, 36, 0.25);
    }

    .balance-dot.negative {
      background: var(--danger-color);
      box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.25);
    }

    .balance-label {
      font-size: 12px;
      color: #4b5563;
    }

    .balance-amount {
      font-weight: 700;
      font-size: 14px;
    }

    .logout-button {
      border-radius: 999px;
      padding: 6px 11px;
      border: 1px solid rgba(226, 232, 240, 0.9);
      background: rgba(248, 250, 252, 0.96);
      font-size: 12px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      color: #4b5563;
      transition: background 0.12s ease, box-shadow 0.12s ease, transform 0.12s ease;
      box-shadow: 0 10px 20px rgba(148, 163, 184, 0.18);
    }

    .logout-button:hover {
      background: #ffffff;
      transform: translateY(-1px);
      box-shadow: 0 14px 28px rgba(148, 163, 184, 0.24);
    }

    .logout-button span {
      font-size: 14px;
    }

    .history-card {
      margin-top: 4px;
      background: rgba(249, 250, 251, 0.98);
      border-radius: 16px;
      padding: 10px 12px;
      border: 1px solid rgba(226, 232, 240, 0.9);
      box-shadow: 0 12px 24px rgba(148, 163, 184, 0.18);
      max-height: 260px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .history-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }

    .history-title {
      font-size: 13px;
      font-weight: 600;
      color: #111827;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .history-title .badge {
      font-size: 10px;
      padding: 3px 7px;
      border-radius: 999px;
      background: rgba(59, 130, 246, 0.08);
      color: #2563eb;
      border: 1px solid rgba(191, 219, 254, 0.9);
    }

    .history-summary {
      font-size: 11px;
      color: #6b7280;
    }

    .history-list {
      list-style: none;
      margin: 0;
      padding: 0;
      overflow-y: auto;
      max-height: 200px;
      scrollbar-width: thin;
      scrollbar-color: rgba(148, 163, 184, 0.7) transparent;
    }

    .history-list::-webkit-scrollbar {
      width: 6px;
    }

    .history-list::-webkit-scrollbar-track {
      background: transparent;
    }

    .history-list::-webkit-scrollbar-thumb {
      background-color: rgba(148, 163, 184, 0.85);
      border-radius: 999px;
    }

    .history-item {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      padding: 6px 4px;
      border-bottom: 1px dashed rgba(209, 213, 219, 0.9);
      font-size: 12px;
      gap: 6px;
    }

    .history-item:last-child {
      border-bottom: none;
    }

    .history-main {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .history-row {
      display: flex;
      justify-content: space-between;
      gap: 6px;
    }

    .history-date {
      font-size: 11px;
      color: #6b7280;
    }

    .history-type {
      font-size: 11px;
      padding: 2px 7px;
      border-radius: 999px;
      border: 1px solid rgba(209, 213, 219, 0.9);
      background: rgba(249, 250, 251, 0.95);
      color: #4b5563;
    }

    .history-desc {
      font-size: 12px;
      color: #111827;
    }

    .history-meta {
      font-size: 11px;
      color: #6b7280;
    }

    .history-amount {
      font-weight: 700;
      font-size: 13px;
      text-align: right;
      min-width: 68px;
    }

    .history-amount.sale {
      color: #dc2626;
    }

    .history-amount.deposit {
      color: #15803d;
    }

    .payment-card {
      margin-top: 12px;
      background: rgba(255, 255, 255, 0.96);
      border-radius: 16px;
      padding: 10px 12px 11px;
      border: 1px solid rgba(226, 232, 240, 0.9);
      box-shadow: 0 12px 24px rgba(148, 163, 184, 0.18);
    }

    .payment-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 6px;
    }

    .payment-title {
      font-size: 13px;
      font-weight: 600;
      color: #0f172a;
      display: flex;
      align-items: center;
      gap: 7px;
    }

    .payment-title .icon {
      width: 24px;
      height: 24px;
      border-radius: 999px;
      background: rgba(255, 122, 60, 0.12);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }

    .payment-subtitle {
      font-size: 11px;
      color: #6b7280;
      margin-bottom: 8px;
    }

    .payment-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
    }

    .payment-option {
      border-radius: 14px;
      padding: 10px 10px 9px;
      border: 1px solid rgba(226, 232, 240, 0.95);
      background: rgba(255, 255, 255, 0.98);
      display: flex;
      flex-direction: column;
      gap: 6px;
      box-shadow: 0 10px 20px rgba(148, 163, 184, 0.14);
    }

    .payment-option.recommended {
      border-color: rgba(34, 197, 94, 0.35);
      background: linear-gradient(135deg, rgba(34, 197, 94, 0.08), rgba(255, 255, 255, 0.98));
    }

    .payment-option.secondary {
      border-color: rgba(245, 158, 11, 0.35);
      background: linear-gradient(135deg, rgba(245, 158, 11, 0.10), rgba(255, 255, 255, 0.98));
    }

    .payment-option-title {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      font-size: 12px;
      font-weight: 700;
      color: #111827;
    }

    .payment-option-title .left {
      display: inline-flex;
      align-items: center;
      gap: 7px;
      min-width: 0;
    }

    .payment-option-title .emoji {
      font-size: 16px;
    }

    .payment-badge {
      font-size: 10px;
      padding: 3px 7px;
      border-radius: 999px;
      border: 1px solid rgba(226, 232, 240, 0.95);
      background: rgba(249, 250, 251, 0.95);
      color: #4b5563;
      white-space: nowrap;
    }

    .payment-badge.good {
      border-color: rgba(187, 247, 208, 0.9);
      background: rgba(22, 163, 74, 0.10);
      color: #15803d;
    }

    .payment-badge.warn {
      border-color: rgba(252, 211, 77, 0.9);
      background: rgba(245, 158, 11, 0.12);
      color: #92400e;
    }

    .payment-body {
      font-size: 11px;
      color: #6b7280;
      line-height: 1.35;
    }

    .payment-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 2px;
      align-items: center;
    }

    .payment-amount {
      border-radius: 999px;
      border: 1px solid rgba(226, 232, 240, 0.95);
      background: rgba(255, 255, 255, 0.96);
      padding: 4px 10px;
      font-size: 11px;
      cursor: pointer;
      box-shadow: 0 8px 18px rgba(148, 163, 184, 0.16);
      transition: transform 0.12s ease, box-shadow 0.12s ease, background 0.12s ease;
    }

    .payment-amount:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 22px rgba(148, 163, 184, 0.2);
      background: #ffffff;
    }

    .payment-amount.is-active {
      background: rgba(34, 197, 94, 0.12);
      border-color: rgba(34, 197, 94, 0.45);
      color: #15803d;
      font-weight: 700;
    }

    .payment-row {
      display: flex;
      gap: 6px;
      align-items: center;
      margin-top: 2px;
    }

    .payment-row input[type="number"] {
      flex: 1;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      padding: 7px 12px;
      font-size: 12px;
      background: rgba(249, 250, 251, 0.98);
      outline: none;
    }

    .payment-row button {
      border-radius: 999px;
      border: none;
      padding: 7px 12px;
      font-size: 11px;
      font-weight: 700;
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: #fff;
      cursor: pointer;
      box-shadow: 0 10px 22px rgba(22, 163, 74, 0.35);
      white-space: nowrap;
    }

    .payment-row button:disabled {
      opacity: 0.7;
      cursor: default;
      box-shadow: none;
    }

    .payment-feedback {
      min-height: 14px;
      font-size: 11px;
      margin-top: 6px;
      color: #16a34a;
    }

    .payment-qr {
      width: 100%;
      max-width: 220px;
      border-radius: 14px;
      border: 1px solid rgba(226, 232, 240, 0.95);
      background: rgba(249, 250, 251, 0.98);
      box-shadow: 0 12px 24px rgba(148, 163, 184, 0.16);
      padding: 10px;
      display: none;
    }

    .payment-qr img {
      width: 100%;
      height: auto;
      display: block;
      border-radius: 10px;
    }

    .payment-qr-note {
      font-size: 10px;
      color: #6b7280;
      margin-top: 6px;
      line-height: 1.35;
    }

    @media (max-width: 780px) {
      .payment-grid {
        grid-template-columns: 1fr;
      }
    }

    .notify-card {
      margin-top: 12px;
      background: linear-gradient(135deg, rgba(56, 189, 248, 0.06), rgba(255, 255, 255, 0.98));
      border-radius: 16px;
      padding: 10px 12px 11px;
      border: 1px solid rgba(191, 219, 254, 0.95);
      box-shadow: 0 12px 24px rgba(148, 163, 184, 0.2);
    }

    .notify-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 6px;
      gap: 8px;
    }

    .notify-title {
      font-size: 13px;
      font-weight: 600;
      color: #0f172a;
      display: flex;
      align-items: center;
      gap: 7px;
    }

    .notify-title .icon {
      width: 24px;
      height: 24px;
      border-radius: 999px;
      background: rgba(34, 197, 94, 0.12);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }

    .notify-badge {
      font-size: 10px;
      padding: 3px 7px;
      border-radius: 999px;
      background: rgba(22, 163, 74, 0.1);
      color: #15803d;
      border: 1px solid rgba(187, 247, 208, 0.9);
    }

    .notify-body {
      display: grid;
      grid-template-columns: minmax(0, 1.2fr) minmax(0, 1.1fr);
      gap: 6px;
      align-items: flex-end;
    }

    .notify-body .field {
      display: flex;
      flex-direction: column;
      gap: 3px;
      font-size: 11px;
      color: #4b5563;
    }

    .notify-body label {
      font-size: 11px;
      color: #4b5563;
    }

    .notify-body input[type="email"] {
      border-radius: 999px;
      border: 1px solid #d1d5db;
      padding: 7px 12px;
      font-size: 12px;
      outline: none;
      background: rgba(249, 250, 251, 0.98);
      transition: border-color 0.15s ease, box-shadow 0.15s ease;
    }

    .notify-body input[type="email"]:focus {
      border-color: #22c55e;
      box-shadow: 0 0 0 1px rgba(34, 197, 94, 0.28);
      background: #ffffff;
    }

    .notify-options {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 4px;
      margin-bottom: 4px;
      font-size: 11px;
      color: #4b5563;
    }

    .notify-option {
      display: flex;
      align-items: center;
      gap: 5px;
      padding: 4px 6px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid rgba(226, 232, 240, 0.95);
    }

    .notify-option input[type="checkbox"] {
      accent-color: #22c55e;
      width: 13px;
      height: 13px;
    }

    .notify-save-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      font-size: 11px;
      margin-top: 4px;
    }

    .notify-save-row button {
      border-radius: 999px;
      padding: 6px 11px;
      border: none;
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: white;
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      box-shadow: 0 10px 22px rgba(22, 163, 74, 0.4);
      transition: transform 0.1s ease, box-shadow 0.1s ease, filter 0.1s ease;
    }

    .notify-save-row button:hover {
      transform: translateY(-1px);
      box-shadow: 0 14px 26px rgba(22, 163, 74, 0.48);
      filter: brightness(1.03);
    }

    .notify-save-row button:active {
      transform: translateY(0);
      box-shadow: 0 8px 16px rgba(22, 163, 74, 0.35);
      filter: brightness(0.97);
    }

    .notify-save-row button:disabled {
      opacity: 0.7;
      box-shadow: none;
      cursor: default;
    }

    .notify-feedback {
      font-size: 11px;
      color: #16a34a;
    }

    .footer-note {
      margin-top: 12px;
      font-size: 11px;
      color: #9ca3af;
      text-align: center;
    }

    .footer-note a {
      color: #3b82f6;
      text-decoration: none;
      font-weight: 500;
    }

    .footer-note a:hover {
      text-decoration: underline;
    }

    .allergy-card {
      margin-top: 12px;
      background: linear-gradient(135deg, rgba(252, 211, 77, 0.06), rgba(255, 255, 255, 0.98));
      border-radius: 16px;
      padding: 10px 12px 11px;
      border: 1px solid rgba(253, 230, 138, 0.9);
      box-shadow: 0 12px 24px rgba(148, 163, 184, 0.2);
    }

    .allergy-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 6px;
    }

    .allergy-title {
      display: flex;
      align-items: center;
      gap: 7px;
      font-size: 13px;
      font-weight: 600;
      color: #0f172a;
    }

    .allergy-title .icon {
      width: 24px;
      height: 24px;
      border-radius: 999px;
      background: rgba(250, 204, 21, 0.16);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }

    .allergy-badge {
      font-size: 10px;
      padding: 3px 7px;
      border-radius: 999px;
      background: rgba(251, 191, 36, 0.1);
      color: #92400e;
      border: 1px solid rgba(252, 211, 77, 0.9);
      white-space: nowrap;
    }

    .allergy-description {
      font-size: 11px;
      color: #6b7280;
      margin-bottom: 8px;
    }

    .allergy-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 6px 10px;
    }

    .allergy-item {
      display: flex;
      flex-direction: column;
      gap: 5px;
      font-size: 11px;
      color: #4b5563;
      background: rgba(255, 255, 255, 0.98);
      border-radius: 12px;
      padding: 6px 8px;
      border: 1px solid rgba(229, 231, 235, 0.9);
    }

    .allergy-label {
      display: flex;
      align-items: center;
      gap: 6px;
      font-weight: 600;
      color: #111827;
      font-size: 11px;
    }

    .allergy-label span.emoji {
      font-size: 14px;
    }

    .allergy-toggle-group {
      display: inline-flex;
      align-items: center;
      border-radius: 999px;
      background: rgba(248, 250, 252, 0.96);
      border: 1px solid rgba(226, 232, 240, 0.9);
      overflow: hidden;
    }

    .allergy-toggle-button {
      border: none;
      background: transparent;
      padding: 5px 10px;
      font-size: 10px;
      cursor: pointer;
      color: #6b7280;
      min-width: 0;
      flex: 1;
      white-space: nowrap;
      position: relative;
      transition:
        background 0.12s ease,
        color 0.12s ease,
        box-shadow 0.12s ease,
        transform 0.12s ease;
    }

    .allergy-toggle-button:first-child {
      border-top-left-radius: 999px;
      border-bottom-left-radius: 999px;
    }

    .allergy-toggle-button:last-child {
      border-top-right-radius: 999px;
      border-bottom-right-radius: 999px;
    }

    .allergy-toggle-button + .allergy-toggle-button {
      border-left: 1px solid rgba(226, 232, 240, 0.9);
    }

    .allergy-toggle-button.is-active-allow {
      background: rgba(34, 197, 94, 0.14);
      color: #15803d;
      font-weight: 700;
      box-shadow: 0 0 0 1px rgba(34, 197, 94, 0.7) inset;
      transform: translateY(-0.5px);
    }

    .allergy-toggle-button.is-active-warn {
      background: rgba(245, 158, 11, 0.18);
      color: #92400e;
      font-weight: 700;
      box-shadow: 0 0 0 1px rgba(245, 158, 11, 0.75) inset;
      transform: translateY(-0.5px);
    }

    .allergy-toggle-button.is-active-block {
      background: rgba(239, 68, 68, 0.2);
      color: #b91c1c;
      font-weight: 700;
      box-shadow: 0 0 0 1px rgba(239, 68, 68, 0.85) inset;
      transform: translateY(-0.5px);
    }

    .allergy-save-row {
      margin-top: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
      justify-content: flex-start;
      font-size: 11px;
    }

    .allergy-save-row button {
      border-radius: 999px;
      padding: 6px 11px;
      border: none;
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: white;
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      box-shadow: 0 10px 22px rgba(22, 163, 74, 0.4);
      transition: transform 0.1s ease, box-shadow 0.1s ease, filter 0.1s ease;
    }

    .allergy-save-row button:hover {
      transform: translateY(-1px);
      box-shadow: 0 14px 26px rgba(22, 163, 74, 0.48);
      filter: brightness(1.03);
    }

    .allergy-save-row button:active {
      transform: translateY(0);
      box-shadow: 0 8px 16px rgba(22, 163, 74, 0.35);
      filter: brightness(0.97);
    }

    .allergy-save-row button:disabled {
      opacity: 0.7;
      box-shadow: none;
      cursor: default;
    }

    .allergy-feedback {
      min-height: 14px;
      font-size: 11px;
      color: #16a34a;
    }

    /* Product Limit Section Styles */
    .product-limit-card {
      margin-top: 12px;
      background: linear-gradient(135deg, rgba(139, 92, 246, 0.06), rgba(255, 255, 255, 0.98));
      border-radius: 16px;
      padding: 10px 12px 11px;
      border: 1px solid rgba(196, 181, 253, 0.9);
      box-shadow: 0 12px 24px rgba(148, 163, 184, 0.2);
    }

    .product-limit-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 6px;
    }

    .product-limit-title {
      display: flex;
      align-items: center;
      gap: 7px;
      font-size: 13px;
      font-weight: 600;
      color: #0f172a;
    }

    .product-limit-title .icon {
      width: 24px;
      height: 24px;
      border-radius: 999px;
      background: rgba(139, 92, 246, 0.16);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }

    .product-limit-badge {
      font-size: 10px;
      padding: 3px 7px;
      border-radius: 999px;
      background: rgba(139, 92, 246, 0.1);
      color: #6d28d9;
      border: 1px solid rgba(196, 181, 253, 0.9);
    }

    .product-limit-description {
      font-size: 11px;
      color: #6b7280;
      margin-bottom: 8px;
    }

    .product-limit-info {
      font-size: 10px;
      color: #7c3aed;
      background: rgba(139, 92, 246, 0.08);
      padding: 6px 10px;
      border-radius: 8px;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .product-limit-controls {
      display: flex;
      gap: 8px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }

    .product-limit-search {
      flex: 1;
      min-width: 150px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(226, 232, 240, 0.95);
      font-size: 11px;
      outline: none;
      transition: border-color 0.15s ease, box-shadow 0.15s ease;
    }

    .product-limit-search:focus {
      border-color: #8b5cf6;
      box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.2);
    }

    .product-limit-filter-toggle {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(226, 232, 240, 0.95);
      background: rgba(255, 255, 255, 0.96);
      font-size: 11px;
      cursor: pointer;
      transition: all 0.12s ease;
    }

    .product-limit-filter-toggle:hover {
      background: #fff;
    }

    .product-limit-filter-toggle.is-active {
      background: rgba(139, 92, 246, 0.12);
      border-color: rgba(139, 92, 246, 0.6);
      color: #6d28d9;
    }

    .product-limit-list {
      max-height: 280px;
      overflow-y: auto;
      scrollbar-width: thin;
      scrollbar-color: rgba(148, 163, 184, 0.7) transparent;
    }

    .product-limit-list::-webkit-scrollbar {
      width: 6px;
    }

    .product-limit-list::-webkit-scrollbar-track {
      background: transparent;
    }

    .product-limit-list::-webkit-scrollbar-thumb {
      background-color: rgba(148, 163, 184, 0.85);
      border-radius: 999px;
    }

    .product-limit-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 6px;
      border-bottom: 1px solid rgba(229, 231, 235, 0.8);
      gap: 10px;
    }

    .product-limit-item:last-child {
      border-bottom: none;
    }

    .product-limit-item.is-modified {
      background: rgba(139, 92, 246, 0.06);
    }

    .product-limit-item-info {
      display: flex;
      align-items: center;
      gap: 8px;
      flex: 1;
      min-width: 0;
    }

    .product-limit-item-icon {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      object-fit: contain;
      background: rgba(249, 250, 251, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      flex-shrink: 0;
    }

    .product-limit-item-details {
      flex: 1;
      min-width: 0;
    }

    .product-limit-item-name {
      font-size: 12px;
      font-weight: 600;
      color: #111827;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .product-limit-item-price {
      font-size: 10px;
      color: #6b7280;
    }

    .product-limit-stepper {
      display: flex;
      align-items: center;
      gap: 2px;
      background: rgba(249, 250, 251, 0.96);
      border-radius: 999px;
      border: 1px solid rgba(226, 232, 240, 0.95);
      padding: 2px;
    }

    .product-limit-stepper button {
      width: 26px;
      height: 26px;
      border: none;
      background: transparent;
      border-radius: 999px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      color: #6b7280;
      transition: all 0.12s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .product-limit-stepper button:hover {
      background: rgba(139, 92, 246, 0.15);
      color: #6d28d9;
    }

    .product-limit-stepper button:active {
      transform: scale(0.95);
    }

    .product-limit-stepper-value {
      min-width: 50px;
      text-align: center;
      font-size: 11px;
      font-weight: 600;
      color: #111827;
    }

    .product-limit-stepper-value.is-zero {
      color: #dc2626;
    }

    .product-limit-stepper-value.is-unlimited {
      color: #6b7280;
      font-style: italic;
    }

    .product-limit-save-row {
      margin-top: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
      justify-content: flex-start;
    }

    .product-limit-save-row button {
      border-radius: 999px;
      padding: 6px 11px;
      border: none;
      background: linear-gradient(135deg, #8b5cf6, #6d28d9);
      color: white;
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      box-shadow: 0 10px 22px rgba(109, 40, 217, 0.4);
      transition: transform 0.1s ease, box-shadow 0.1s ease, filter 0.1s ease;
    }

    .product-limit-save-row button:hover {
      transform: translateY(-1px);
      box-shadow: 0 14px 26px rgba(109, 40, 217, 0.48);
      filter: brightness(1.03);
    }

    .product-limit-save-row button:active {
      transform: translateY(0);
      box-shadow: 0 8px 16px rgba(109, 40, 217, 0.35);
      filter: brightness(0.97);
    }

    .product-limit-save-row button:disabled {
      opacity: 0.7;
      box-shadow: none;
      cursor: default;
    }

    .product-limit-feedback {
      min-height: 14px;
      font-size: 11px;
      color: #6d28d9;
    }

    .product-limit-empty {
      text-align: center;
      padding: 20px;
      font-size: 12px;
      color: #6b7280;
    }

    .spend-limit-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 6px;
    }

    .spend-limit-chip {
      border-radius: 999px;
      border: 1px solid rgba(226, 232, 240, 0.95);
      background: rgba(255, 255, 255, 0.96);
      padding: 4px 10px;
      font-size: 11px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      box-shadow: 0 8px 18px rgba(148, 163, 184, 0.18);
      transition:
        background 0.12s ease,
        box-shadow 0.12s ease,
        transform 0.12s ease;
    }

    .spend-limit-chip:hover {
      background: #ffffff;
      transform: translateY(-1px);
      box-shadow: 0 10px 22px rgba(148, 163, 184, 0.22);
    }

    .spend-limit-chip.is-active {
      background: rgba(59, 130, 246, 0.12);
      border-color: rgba(59, 130, 246, 0.6);
      color: #1d4ed8;
      font-weight: 600;
    }

    .spend-limit-row {
      display: flex;
      gap: 6px;
      align-items: center;
      margin-top: 2px;
    }

    .spend-limit-row input[type="number"] {
      flex: 1;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      padding: 7px 12px;
      font-size: 12px;
      background: rgba(249, 250, 251, 0.98);
      outline: none;
      transition:
        border-color 0.15s ease,
        box-shadow 0.15s ease,
        background-color 0.15s ease;
    }

    .spend-limit-row input[type="number"]:focus {
      border-color: #3b82f6;
      box-shadow: 0 0 0 1px rgba(59, 130, 246, 0.25);
      background: #ffffff;
    }

    .spend-limit-row button {
      border-radius: 999px;
      border: none;
      padding: 7px 12px;
      font-size: 11px;
      font-weight: 600;
      background: linear-gradient(135deg, #3b82f6, #6366f1);
      color: white;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      box-shadow: 0 10px 22px rgba(59, 130, 246, 0.4);
      transition:
        transform 0.1s ease,
        box-shadow 0.1s ease,
        filter 0.1s ease;
      white-space: nowrap;
    }

    .spend-limit-row button:hover {
      transform: translateY(-1px);
      box-shadow: 0 14px 26px rgba(59, 130, 246, 0.48);
      filter: brightness(1.03);
    }

    .spend-limit-row button:active {
      transform: translateY(0);
      box-shadow: 0 8px 16px rgba(59, 130, 246, 0.35);
      filter: brightness(0.97);
    }

    .spend-limit-row button:disabled {
      opacity: 0.7;
      box-shadow: none;
      cursor: default;
    }

    .spend-limit-feedback {
      margin-top: 4px;
      font-size: 11px;
      min-height: 14px;
      color: #16a34a;
    }

    @media (max-width: 780px) {
      .container-inner {
        grid-template-columns: 1fr;
      }

      .intro-section {
        order: 2;
      }

      .login-section {
        order: 1;
      }

      .info-cards {
        grid-template-columns: 1fr;
      }

      .notify-body {
        grid-template-columns: 1fr;
      }
      .allergy-grid {
        grid-template-columns: 1fr;
      }

      /* Produktgrænser - mobile forbedringer */
      .product-limit-list {
        max-height: 400px;
      }

      .product-limit-item {
        gap: 6px;
        flex-wrap: wrap;
      }

      .product-limit-controls {
        flex-direction: column;
        gap: 8px;
      }

      .product-limit-search {
        min-width: 100px;
        width: 100%;
      }

      .product-limit-stepper button {
        width: 32px;
        height: 32px;
        font-size: 16px;
      }

      .product-limit-stepper-value {
        min-width: 70px;
        font-size: 11px;
      }
    }

    /* ── Event cards ── */
    .event-card {
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      transition: border-color 0.2s;
    }
    .event-card.registered {
      border-left: 4px solid #22c55e;
    }
    .event-card-title {
      font-weight: 700;
      font-size: 15px;
      color: #111827;
      margin-bottom: 4px;
    }
    .event-card-desc {
      font-size: 13px;
      color: #6b7280;
      margin-bottom: 8px;
      line-height: 1.4;
    }
    .event-card-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      font-size: 12px;
      color: #374151;
      margin-bottom: 10px;
    }
    .event-card-meta span {
      background: #f3f4f6;
      padding: 3px 8px;
      border-radius: 6px;
      white-space: nowrap;
    }
    .event-card-badge {
      display: inline-block;
      font-size: 11px;
      font-weight: 600;
      padding: 3px 10px;
      border-radius: 999px;
      margin-bottom: 8px;
    }
    .event-card-badge.badge-registered {
      background: #dcfce7;
      color: #166534;
    }
    .event-card-badge.badge-paid {
      background: #dbeafe;
      color: #1e40af;
    }
    .event-card-badge.badge-pending {
      background: #fef3c7;
      color: #92400e;
    }
    .event-card-badge.badge-full {
      background: #fee2e2;
      color: #991b1b;
    }
    .event-card-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 8px;
    }
    .event-register-btn,
    .event-cancel-btn,
    .event-pay-btn {
      padding: 8px 16px;
      border: none;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: opacity 0.2s;
    }
    .event-register-btn {
      background: #2563eb;
      color: #fff;
    }
    .event-register-btn:disabled {
      background: #93c5fd;
      cursor: not-allowed;
    }
    .event-pay-btn {
      background: #16a34a;
      color: #fff;
    }
    .event-cancel-btn {
      background: #fee2e2;
      color: #991b1b;
    }

    /* ── Event payment overlay ── */
    .event-payment-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      padding: 16px;
    }
    .event-payment-modal {
      background: #fff;
      border-radius: 16px;
      padding: 24px;
      max-width: 400px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
    }
    .event-payment-modal h3 {
      font-size: 17px;
      font-weight: 700;
      margin: 0 0 4px;
      color: #111827;
    }
    .event-payment-modal .modal-subtitle {
      font-size: 13px;
      color: #6b7280;
      margin-bottom: 16px;
    }
    .event-payment-option {
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      padding: 14px;
      margin-bottom: 10px;
      cursor: pointer;
      transition: border-color 0.2s, background 0.2s;
    }
    .event-payment-option:hover {
      border-color: #2563eb;
      background: #eff6ff;
    }
    .event-payment-option.disabled {
      opacity: 0.5;
      cursor: not-allowed;
      pointer-events: none;
    }
    .event-payment-option .opt-title {
      font-weight: 600;
      font-size: 14px;
      color: #111827;
      margin-bottom: 2px;
    }
    .event-payment-option .opt-desc {
      font-size: 12px;
      color: #6b7280;
    }
    .event-payment-close {
      display: block;
      width: 100%;
      margin-top: 12px;
      padding: 10px;
      background: #f3f4f6;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      color: #374151;
      cursor: pointer;
    }
    .event-stripe-container {
      margin-top: 12px;
      padding: 16px;
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      background: #f9fafb;
    }
    .event-stripe-container #event-payment-element {
      margin-bottom: 12px;
    }
    .event-stripe-submit {
      width: 100%;
      padding: 12px;
      background: #2563eb;
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
    }
    .event-stripe-submit:disabled {
      background: #93c5fd;
      cursor: not-allowed;
    }
    .event-stripe-error {
      color: #dc2626;
      font-size: 13px;
      margin-top: 8px;
    }
    .event-feedback {
      font-size: 13px;
      padding: 8px 12px;
      border-radius: 8px;
      margin-top: 8px;
    }
    .event-feedback.success {
      background: #dcfce7;
      color: #166534;
    }
    .event-feedback.error {
      background: #fee2e2;
      color: #991b1b;
    }
  </style>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
  <div class="page-wrapper">
    <div class="logo-row">
      <div class="logo">
        <div class="logo-badge">F</div>
        <div class="logo-text-main">
          <div class="logo-name">Flango</div>
          <div class="logo-tagline">Børnenes café-system</div>
        </div>
      </div>
      <div class="top-tag">
        <span class="dot"></span>
        <span>Forældre-portal – sikker visning af saldo & historik</span>
      </div>
    </div>

    <main class="container">
      <div class="container-inner">
        <section class="intro-section">
          <div class="title-row">
            <h1>
              <span>Flango</span>
              <span class="highlight">Forældre-portal</span>
            </h1>
          </div>

          <p class="subtitle">
            Her kan du som forælder få et hurtigt overblik over
            <strong>dit barns saldo</strong> i caféen og se en
            <strong>tydelig historik</strong> over køb og optankninger.
          </p>

          <div class="info-cards">
            <div class="info-card">
              <div class="info-icon">💳</div>
              <div class="info-content">
                <strong>Tryghed & gennemsigtighed</strong>
                Du kan altid se, hvad der er købt, og hvornår saldoen er blevet
                tanket op.
              </div>
            </div>
            <div class="info-card">
              <div class="info-icon">🔔</div>
              <div class="info-content">
                <strong>E-mail når saldoen er lav</strong>
                Vælg at få en besked, når der er fx 0 kr. eller 10 kr. tilbage på kontoen.
              </div>
            </div>
          </div>

          <p class="help-text">
            <strong>Sådan gør du:</strong><br />
            1) Vælg klubbens/SFO’ens navn<br />
            2) Skriv dit barns fulde navn (som aftalt med klubben)<br />
            3) Indtast den kode, I har fået fra personalet
          </p>
        </section>

        <section class="login-section">
          <div class="login-inner">
            <div class="section-title">
              <span class="icon">👨‍👩‍👧</span>
              Log ind som forælder
            </div>
            <p class="section-subtitle">
              Brug den kode, I har fået fra klubben/SFO’en. Er du i tvivl, så spørg personalet – de hjælper gerne.
            </p>

            <!-- Login View -->
            <div id="login-view">
              <div class="login-card">
                <!-- Kode-login sektion -->
                <div id="code-login-section">
                  <h3 style="margin-top: 0; margin-bottom: 12px;">Log ind med kode</h3>
                  <form id="parent-login-form" class="login-form">
                    <!-- Klub/SFO -->
                    <div class="form-group" id="institution-row">
                      <label for="institution-select" class="section-subtitle" id="institution-label">
                        Vælg klub/SFO
                      </label>
                      <select id="institution-select" required>
                        <option value="">Vælg klub/SFO…</option>
                      </select>
                    </div>

                    <p
                      id="institution-info"
                      class="section-subtitle"
                      style="display: none; margin-bottom: 10px;"
                    >
                      Institutioner i nærheden af dig:
                      <strong id="institution-name-label"></strong>
                    </p>

                    <!-- Barnets navn -->
                    <input
                      type="text"
                      id="child-name-input"
                      placeholder="Barnets fulde navn (fx Oliver Jensen)"
                      required
                    />

                    <!-- Forældre-kode -->
                    <input
                      type="password"
                      id="parent-pin-input"
                      placeholder="Forældre-kode (fx 6 cifre eller kodeord)"
                      inputmode="text"
                      maxlength="32"
                      required
                    />

                    <button type="submit" id="login-btn">Se saldo og historik</button>
                    <p id="login-error" class="error-message" style="display: none;"></p>
                  </form>

                  <p class="login-help">
                    <strong>Har du ikke fået en kode?</strong><br />
                    Kontakt klubben/SFO’en – de kan oplyse eller nulstille jeres forældre-login.
                  </p>
                </div>

                <!-- Divider -->
                <div class="login-divider" style="margin: 24px 0; text-align: center; position: relative;">
                  <span style="background: var(--card-bg, #fff); padding: 0 12px; color: #666;">eller</span>
                  <hr style="position: absolute; top: 50%; left: 0; right: 0; margin: 0; border: none; border-top: 1px solid #ddd; z-index: -1;">
                </div>

                <!-- Email login sektion -->
                <div id="email-login-section">
                  <h3 style="margin-top: 0; margin-bottom: 8px;">Opret forældre-login (valgfrit)</h3>
                  <p class="microcopy" style="font-size: 13px; color: #666; margin-bottom: 12px;">
                    Vil du kunne logge ind på nye enheder uden koden? Opret forældre-login.
                  </p>
                  <form id="email-login-form" class="login-form">
                    <input
                      type="email"
                      id="parent-email-login-input"
                      placeholder="Din e-mail"
                      required
                      style="width: 100%; padding: 12px; margin-bottom: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px;"
                    />
                    <button type="submit" id="email-login-btn" style="width: 100%; padding: 12px; background: #4a90e2; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;">
                      Send magic link
                    </button>
                    <p id="email-login-error" class="error-message" style="display: none; margin-top: 8px;"></p>
                    <p id="email-login-success" style="display: none; margin-top: 8px; color: #28a745; font-size: 14px;">
                      Tjek din e-mail for login-link
                    </p>
                  </form>
                </div>
              </div>
            </div>

            <!-- Results View -->
            <div id="results-view" style="display: none;">
              <div class="results-header">
                <div class="child-info">
                  <div class="child-name" id="child-name-display">Barnets navn</div>
                  <div class="balance-chip">
                    <span class="balance-dot" id="balance-dot"></span>
                    <div>
                      <div class="balance-label" id="balance-status-label">Saldo-status</div>
                      <div class="balance-amount" id="balance-display">0,00 kr</div>
                    </div>
                  </div>
                </div>
                <div style="display: flex; gap: 8px; align-items: center;">
                  <!-- Child switcher -->
                  <div id="child-switcher" style="display: none;">
                    <select id="child-switcher-select" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; background: white; cursor: pointer;">
                    </select>
                  </div>
                  <!-- Tilknyt barn knap -->
                  <button id="link-sibling-btn" class="logout-button" style="background: #4a90e2; color: white;">
                    <span>Tilknyt barn</span>
                  </button>
                  <button id="logout-btn" class="logout-button">
                    <span>Log ud</span> ⏏
                  </button>
                </div>
              </div>

              <!-- Collapsible Sections Container -->
              <div id="collapsible-sections-container">
                <!-- 1. E-mail, når saldoen er lav -->
                <div class="collapsible-section-container" id="email-notification-collapsible" style="display: none;">
                  <div class="collapsible-section-header">
                    <div class="collapsible-section-title">
                      <div class="collapsible-section-icon">📧</div>
                      <span>E-mail, når saldoen er lav</span>
                    </div>
                    <div class="collapsible-section-arrow">▼</div>
                  </div>
                  <div class="collapsible-section-content">
                    <div id="email-notification-section" class="notify-card" style="margin: 0; border: none; box-shadow: none; padding: 0;">
                      <div class="notify-header" style="display: none;">
                        <div class="notify-title">
                          <div class="icon">📧</div>
                          E-mail, når saldoen er lav
                        </div>
                        <span class="notify-badge">Valgfrit</span>
                      </div>
                      <div class="notify-body">
                        <div class="field">
                          <label for="parent-email-input">E-mailadresse til besked</label>
                          <input
                            type="email"
                            id="parent-email-input"
                            placeholder="fx mor@eksempel.dk"
                          />
                          <div class="notify-options">
                            <label class="notify-option">
                              <input type="checkbox" id="notify-zero-checkbox" />
                              <span>Når saldoen er 0 kr.</span>
                            </label>
                            <label class="notify-option">
                              <input type="checkbox" id="notify-ten-checkbox" />
                              <span>Når saldoen er 10 kr. eller derunder</span>
                            </label>
                          </div>
                        </div>
                        <div class="field">
                          <div class="notify-save-row">
                            <button id="save-notify-btn" type="button">
                              Gem e-mail-beskeder
                            </button>
                            <div id="notify-feedback" class="notify-feedback"></div>
                          </div>
                          <p style="font-size: 11px; color: #6b7280; margin-top: 4px;">
                            Du kan altid ændre eller slå beskeder fra igen.
                          </p>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- 2. Historik -->
                <div class="collapsible-section-container" id="history-collapsible" style="display: block;">
                  <div class="collapsible-section-header">
                    <div class="collapsible-section-title">
                      <div class="collapsible-section-icon">📜</div>
                      <span>Historik</span>
                    </div>
                    <div class="collapsible-section-arrow">▼</div>
                  </div>
                  <div class="collapsible-section-content">
                    <div class="history-card" style="margin: 0; border: none; box-shadow: none; padding: 0;">
                      <div class="history-header" style="display: none;">
                        <div class="history-title">
                          Historik
                          <span class="badge">Sidste 30 dage</span>
                        </div>
                        <div class="history-summary" id="history-summary">
                          Viser køb og optankninger på kontoen.
                        </div>
                      </div>
                      <ul id="history-list" class="history-list"></ul>
                    </div>
                  </div>
                </div>

                <!-- 3. Kommende arrangementer -->
                <div class="collapsible-section-container" id="events-collapsible" style="display: none;">
                  <div class="collapsible-section-header">
                    <div class="collapsible-section-title">
                      <div class="collapsible-section-icon">📅</div>
                      <span>Kommende arrangementer</span>
                    </div>
                    <div class="collapsible-section-arrow">▼</div>
                  </div>
                  <div class="collapsible-section-content">
                    <div id="events-list"></div>
                    <div id="events-empty" style="display:none;">
                      <p style="font-size:14px;color:#6b7280;padding:6px 2px;">Ingen kommende arrangementer for dit barn.</p>
                    </div>
                    <div id="events-feedback"></div>
                  </div>
                </div>

                <!-- 4. Optank saldo -->
                <div class="collapsible-section-container" id="payment-collapsible" style="display: none;">
                  <div class="collapsible-section-header">
                    <div class="collapsible-section-title">
                      <div class="collapsible-section-icon">💳</div>
                      <span>Optank saldo</span>
                    </div>
                    <div class="collapsible-section-arrow">▼</div>
                  </div>
                  <div class="collapsible-section-content">
                    <section class="payment-card" id="payment-card" style="margin: 0; border: none; box-shadow: none; padding: 0;">
                      <div class="payment-header" style="display: none;">
                        <div class="payment-title">
                          <div class="icon">💳</div>
                          Optank saldo
                        </div>
                        <span class="payment-badge" id="payment-status-badge">Institutionen bestemmer</span>
                      </div>
                      <p class="payment-subtitle" id="payment-subtitle" style="margin-bottom: 12px;">
                        Portalen viser kun de betalingsmuligheder, som din klub/SFO har slået til.
                      </p>
                      <div class="payment-grid" id="payment-grid"></div>
                      <div class="payment-qr" id="payment-qr">
                        <img id="payment-qr-img" alt="MobilePay QR" />
                        <div class="payment-qr-note" id="payment-qr-note">
                          Betal via MobilePay QR. Saldoen opdateres efter godkendelse af personalet.
                        </div>
                      </div>
                      <div class="payment-feedback" id="payment-feedback"></div>
                    </section>
                  </div>
                </div>

                <!-- 4. Sådan passer klubben på børnenes forbrug -->
                <div class="collapsible-section-container" id="club-limitations-collapsible" style="display: none;">
                  <div class="collapsible-section-header">
                    <div class="collapsible-section-title">
                      <div class="collapsible-section-icon">🛡️</div>
                      <span>Sådan passer klubben på børnenes forbrug</span>
                    </div>
                    <div class="collapsible-section-arrow">▼</div>
                  </div>
                  <div class="collapsible-section-content">
                    <section id="club-limitations-card" class="club-limitations-card" style="margin: 0; border: none; box-shadow: none; padding: 0;">
                      <div class="club-limitations-header" style="display: none;">
                        <div class="club-limitations-icon">🛡️</div>
                        <div class="club-limitations-title">
                          Sådan passer klubben på børnenes forbrug
                        </div>
                      </div>
                      <p class="club-limitations-description" style="margin-bottom: 14px;">
                        Klubben har opsat klare og pædagogiske rammer for caféen, så børnene kan handle trygt og uden overraskelser.
                      </p>
                      <div class="club-limitations-list">
                        <div class="club-limitation-item" id="club-daily-limit-item" style="display: none;">
                          <div class="club-limitation-item-title">Daglig grænse</div>
                          <div class="club-limitation-item-content">
                            Maks. forbrug pr. dag: <strong id="club-daily-limit">x kr.</strong>
                          </div>
                        </div>
                        <div class="club-limitation-item" id="club-product-limits-item" style="display: none;">
                          <div class="club-limitation-item-title">Produkter i det faste sortiment med begrænsning</div>
                          <div class="club-limitation-item-content" id="club-product-limits">
                            <!-- Produkter indsættes dynamisk her -->
                          </div>
                        </div>
                      </div>
                      <p id="club-limitations-fallback" class="club-limitations-description" style="display: none; margin-bottom: 0;">
                        Ingen klubbegrænsninger er sat lige nu.
                      </p>
                    </section>
                  </div>
                </div>

                <!-- 5. Dagens Sortiment -->
                <div class="collapsible-section-container" id="daily-assortment-collapsible" style="display: none;">
                  <div class="collapsible-section-header">
                    <div class="collapsible-section-title">
                      <div class="collapsible-section-icon">📋</div>
                      <span>Dagens Sortiment</span>
                    </div>
                    <div class="collapsible-section-arrow">▼</div>
                  </div>
                  <div class="collapsible-section-content">
                    <section id="daily-assortment-card" class="daily-assortment-card" style="margin: 0; border: none; box-shadow: none; padding: 0;">
                      <div class="daily-assortment-header" style="display: none;">
                        <div class="daily-assortment-icon">📋</div>
                        <div class="daily-assortment-title">Dagens Sortiment</div>
                      </div>
                      <p class="daily-assortment-description" style="margin-bottom: 14px;">
                        Her er de produkter, der er tilgængelige i dagens sortiment lige nu:
                      </p>
                      <div class="daily-assortment-list" id="daily-assortment-list">
                        <!-- Produkter indsættes dynamisk her -->
                      </div>
                    </section>
                  </div>
                </div>

                <!-- 6. Daglig beløbsgrænse -->
                <div class="collapsible-section-container" id="spending-limit-collapsible" style="display: none;">
                  <div class="collapsible-section-header">
                    <div class="collapsible-section-title">
                      <div class="collapsible-section-icon">💰</div>
                      <span>Daglig beløbsgrænse</span>
                    </div>
                    <div class="collapsible-section-arrow">▼</div>
                  </div>
                  <div class="collapsible-section-content">
                    <section id="spending-limit-section" class="card" style="margin: 0; border: none; box-shadow: none; padding: 0;">
                      <h2 class="section-title" style="display: none; font-size: 13px; font-weight: 600; color: #0f172a; display: flex; align-items: center; gap: 7px;">
                        <div class="icon" style="width: 24px; height: 24px; border-radius: 999px; background: rgba(59, 130, 246, 0.12); display: flex; align-items: center; justify-content: center; font-size: 14px;">💰</div>
                        Daglig beløbsgrænse
                      </h2>
                      <p class="section-subtitle" style="font-size: 11px; color: #6b7280; margin-bottom: 12px;">
                        Sæt en maksimal grænse for, hvor meget der må bruges i caféen pr. dag. Du kan vælge et forslag eller skrive et andet beløb.
                      </p>
                      <div class="spend-limit-chips">
                        <button type="button" class="spend-limit-chip daily-limit-chip" data-amount="20">20 kr.</button>
                        <button type="button" class="spend-limit-chip daily-limit-chip" data-amount="30">30 kr.</button>
                        <button type="button" class="spend-limit-chip daily-limit-chip" data-amount="40">40 kr.</button>
                        <button type="button" class="spend-limit-chip daily-limit-chip" data-amount="50">50 kr.</button>
                      </div>
                      <div class="spend-limit-row">
                        <input
                          type="number"
                          id="daily-limit-input"
                          min="0"
                          step="1"
                          placeholder="Beløbsgrænse i kr. pr. dag (fx 20)"
                        />
                        <button type="button" id="save-daily-limit-btn">Gem beløbsgrænse</button>
                      </div>
                      <p id="daily-limit-feedback" class="spend-limit-feedback"></p>
                    </section>
                  </div>
                </div>

                <!-- 7. Købsgrænser pr. produkt -->
                <div class="collapsible-section-container" id="product-limit-collapsible" style="display: none;">
                  <div class="collapsible-section-header">
                    <div class="collapsible-section-title">
                      <div class="collapsible-section-icon">🛒</div>
                      <span>Købsgrænser pr. produkt</span>
                    </div>
                    <div class="collapsible-section-arrow">▼</div>
                  </div>
                  <div class="collapsible-section-content">
                    <section id="product-limit-section" class="product-limit-card" style="margin: 0; border: none; box-shadow: none; padding: 0;">
                      <div class="product-limit-header" style="display: none;">
                        <div class="product-limit-title">
                          <div class="icon">🛒</div>
                          Købsgrænser pr. produkt
                        </div>
                        <span class="product-limit-badge">Valgfrit</span>
                      </div>
                      <p class="product-limit-description" style="margin-bottom: 12px;">
                        Sæt en grænse for, hvor mange stk. af hvert produkt dit barn må købe per dag.
                        Efterlad som "Ubegrænset" hvis du ikke ønsker en grænse.
                      </p>
                      <div class="product-limit-info">
                        <span>💡</span>
                        <span>Hvis klubben har sat en grænse, gælder den strengeste. Dit barns køb må aldrig overstige hverken din eller klubbens grænse.</span>
                      </div>
                      <div class="product-limit-controls">
                        <input type="text" class="product-limit-search" id="product-limit-search" placeholder="Søg efter produkt..." />
                        <label class="product-limit-filter-toggle" id="product-limit-filter-toggle">
                          <input type="checkbox" id="product-limit-show-modified" style="display: none;" />
                          <span>Vis kun ændrede</span>
                        </label>
                      </div>
                      <div class="product-limit-list" id="product-limit-list">
                        <div class="product-limit-empty">Indlæser produkter...</div>
                      </div>
                      <div class="product-limit-save-row">
                        <button type="button" id="save-product-limits-btn">Gem produktgrænser</button>
                        <div id="product-limit-feedback" class="product-limit-feedback"></div>
                      </div>
                    </section>
                  </div>
                </div>

                <!-- 8. Sukkerpolitik -->
                <div class="collapsible-section-container" id="sugar-policy-collapsible" style="display: none;">
                  <div class="collapsible-section-header">
                    <div class="collapsible-section-title">
                      <div class="collapsible-section-icon">🍬</div>
                      <span>Sukkerpolitik</span>
                    </div>
                    <div class="collapsible-section-arrow">▼</div>
                  </div>
                  <div class="collapsible-section-content">
                    <section id="sugar-policy-section" class="product-limit-card" style="margin: 0; border: none; box-shadow: none; padding: 0;">
                      <div class="product-limit-header" style="display: none;">
                        <div class="product-limit-title">
                          <div class="icon">🍬</div>
                          Sukkerpolitik
                        </div>
                        <span class="product-limit-badge">Valgfrit</span>
                      </div>
                      <p class="product-limit-description" style="margin-bottom: 16px;">
                        Her kan du vælge, hvordan dit barn må købe sukkerholdige/usunde produkter i caféen.
                      </p>
                      <div style="padding: 0;">
                        <label style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px; cursor: pointer; padding: 14px; background: linear-gradient(135deg, rgba(139, 92, 246, 0.08), rgba(167, 139, 250, 0.08)); border-radius: 12px; border: 1px solid rgba(139, 92, 246, 0.2);">
                          <input type="checkbox" id="sugar-policy-enabled" style="width: 22px; height: 22px; cursor: pointer; accent-color: #8b5cf6;">
                          <div>
                            <strong style="color: #7c3aed;">Aktiver sukkerpolitik</strong>
                            <div style="font-size: 12px; color: #666; margin-top: 2px;">Slå til for at begrænse usunde køb</div>
                          </div>
                        </label>
                        <div id="sugar-policy-controls" style="display: none;">
                          <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 16px; cursor: pointer; padding: 12px; background: rgba(239, 68, 68, 0.08); border-radius: 10px; border: 1px solid rgba(239, 68, 68, 0.2);">
                            <input type="checkbox" id="sugar-block-unhealthy" style="width: 20px; height: 20px; cursor: pointer;">
                            <div>
                              <strong style="color: #dc2626;">Mit barn må ikke købe usunde produkter</strong>
                              <div style="font-size: 12px; color: #666; margin-top: 2px;">Barnet kan stadig se produkterne, men de kan ikke købes.</div>
                            </div>
                          </label>
                          <div id="sugar-limits-container" style="display: flex; flex-direction: column; gap: 12px;">
                            <div>
                              <label for="sugar-max-per-day" style="display: block; font-size: 13px; font-weight: 500; margin-bottom: 4px; color: #374151;">
                                Maks antal usunde produkter pr. dag
                              </label>
                              <div style="position: relative;">
                                <input type="number" id="sugar-max-per-day" max="10" placeholder="Ingen grænse"
                                       style="width: 100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px;">
                                <span id="sugar-max-per-day-label" style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); font-size: 12px; color: #9ca3af; pointer-events: none;"></span>
                              </div>
                              <div style="font-size: 11px; color: #6b7280; margin-top: 4px;">Gælder samlet for alle usunde produkter. Tom = ingen grænse.</div>
                            </div>
                            <div>
                              <label for="sugar-max-per-product" style="display: block; font-size: 13px; font-weight: 500; margin-bottom: 4px; color: #374151;">
                                Maks antal af hvert usundt produkt pr. dag
                              </label>
                              <div style="position: relative;">
                                <input type="number" id="sugar-max-per-product" max="10" placeholder="Ingen grænse"
                                       style="width: 100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px;">
                                <span id="sugar-max-per-product-label" style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); font-size: 12px; color: #9ca3af; pointer-events: none;"></span>
                              </div>
                              <div style="font-size: 11px; color: #6b7280; margin-top: 4px;">Gælder pr. produkt (fx sodavand eller slik). Tom = ingen grænse.</div>
                            </div>
                          </div>
                        </div>
                        <button type="button" id="save-sugar-policy-btn" style="margin-top: 16px; width: 100%; padding: 12px; background: linear-gradient(135deg, #8b5cf6, #a78bfa); color: white; border: none; border-radius: 10px; font-weight: 600; font-size: 14px; cursor: pointer; box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);">
                          Gem sukkerpolitik
                        </button>
                        <div id="sugar-policy-feedback" style="margin-top: 8px; font-size: 12px; text-align: center;"></div>
                      </div>
                    </section>
                  </div>
                </div>

                <!-- 9. Allergier & madbegrænsninger -->
                <div class="collapsible-section-container" id="allergens-collapsible" style="display: none;">
                  <div class="collapsible-section-header">
                    <div class="collapsible-section-title">
                      <div class="collapsible-section-icon">🥜</div>
                      <span>Allergier & madbegrænsninger</span>
                    </div>
                    <div class="collapsible-section-arrow">▼</div>
                  </div>
                  <div class="collapsible-section-content">
                    <section id="allergens-section" class="allergy-card" style="margin: 0; border: none; box-shadow: none; padding: 0;">
                      <div class="allergy-header" style="display: none;">
                        <div class="allergy-title">
                          <div class="icon">🥜</div>
                          Allergier & madbegrænsninger
                        </div>
                        <span class="allergy-badge">Valgfrit</span>
                      </div>
                      <p class="allergy-description">
                  Her kan du som forælder hjælpe med at markere, hvad dit barn <strong>ikke</strong> bør købe.
                  Personalet kan altid hjælpe, hvis der er tale om læge-diagnosticerede allergier.
                </p>
                <p class="allergy-description" style="margin-top: 4px;">
                  <em>
                    Ingrediens- og allergenoplysninger i systemet er vejledende og kan indeholde fejl eller mangler, da produkter og opskrifter løbende ændres af personalet. Institutionen og systemet kan derfor ikke garantere fuldstændig korrekthed eller fuldstændigt fravær af allergener. Forældre til børn med allergi bør altid tale direkte med personalet.
                  </em>
                </p>
                <div class="allergy-grid" id="allergy-grid">
                  <div class="allergy-item" data-allergen-row="peanuts">
                    <div class="allergy-label">
                      <span class="emoji">🥜</span>
                      <span>Jordnødder (peanuts)</span>
                    </div>
                    <div class="allergy-toggle-group">
                      <button type="button" class="allergy-toggle-button" data-allergen="peanuts" data-policy="allow">Tillad</button>
                      <button type="button" class="allergy-toggle-button" data-allergen="peanuts" data-policy="warn">Advar</button>
                      <button type="button" class="allergy-toggle-button" data-allergen="peanuts" data-policy="block">Blokér</button>
                    </div>
                  </div>

                  <div class="allergy-item" data-allergen-row="tree_nuts">
                    <div class="allergy-label">
                      <span class="emoji">🌰</span>
                      <span>Trænødder (mandel, cashew, mm.)</span>
                    </div>
                    <div class="allergy-toggle-group">
                      <button type="button" class="allergy-toggle-button" data-allergen="tree_nuts" data-policy="allow">Tillad</button>
                      <button type="button" class="allergy-toggle-button" data-allergen="tree_nuts" data-policy="warn">Advar</button>
                      <button type="button" class="allergy-toggle-button" data-allergen="tree_nuts" data-policy="block">Blokér</button>
                    </div>
                  </div>

                  <div class="allergy-item" data-allergen-row="milk">
                    <div class="allergy-label">
                      <span class="emoji">🥛</span>
                      <span>Mælk / mælkeprodukter</span>
                    </div>
                    <div class="allergy-toggle-group">
                      <button type="button" class="allergy-toggle-button" data-allergen="milk" data-policy="allow">Tillad</button>
                      <button type="button" class="allergy-toggle-button" data-allergen="milk" data-policy="warn">Advar</button>
                      <button type="button" class="allergy-toggle-button" data-allergen="milk" data-policy="block">Blokér</button>
                    </div>
                  </div>

                  <div class="allergy-item" data-allergen-row="egg">
                    <div class="allergy-label">
                      <span class="emoji">🥚</span>
                      <span>Æg</span>
                    </div>
                    <div class="allergy-toggle-group">
                      <button type="button" class="allergy-toggle-button" data-allergen="egg" data-policy="allow">Tillad</button>
                      <button type="button" class="allergy-toggle-button" data-allergen="egg" data-policy="warn">Advar</button>
                      <button type="button" class="allergy-toggle-button" data-allergen="egg" data-policy="block">Blokér</button>
                    </div>
                  </div>

                  <div class="allergy-item" data-allergen-row="gluten">
                    <div class="allergy-label">
                      <span class="emoji">🌾</span>
                      <span>Gluten / hvede</span>
                    </div>
                    <div class="allergy-toggle-group">
                      <button type="button" class="allergy-toggle-button" data-allergen="gluten" data-policy="allow">Tillad</button>
                      <button type="button" class="allergy-toggle-button" data-allergen="gluten" data-policy="warn">Advar</button>
                      <button type="button" class="allergy-toggle-button" data-allergen="gluten" data-policy="block">Blokér</button>
                    </div>
                  </div>

                  <div class="allergy-item" data-allergen-row="fish">
                    <div class="allergy-label">
                      <span class="emoji">🐟</span>
                      <span>Fisk</span>
                    </div>
                    <div class="allergy-toggle-group">
                      <button type="button" class="allergy-toggle-button" data-allergen="fish" data-policy="allow">Tillad</button>
                      <button type="button" class="allergy-toggle-button" data-allergen="fish" data-policy="warn">Advar</button>
                      <button type="button" class="allergy-toggle-button" data-allergen="fish" data-policy="block">Blokér</button>
                    </div>
                  </div>

                  <div class="allergy-item" data-allergen-row="shellfish">
                    <div class="allergy-label">
                      <span class="emoji">🦐</span>
                      <span>Skaldyr</span>
                    </div>
                    <div class="allergy-toggle-group">
                      <button type="button" class="allergy-toggle-button" data-allergen="shellfish" data-policy="allow">Tillad</button>
                      <button type="button" class="allergy-toggle-button" data-allergen="shellfish" data-policy="warn">Advar</button>
                      <button type="button" class="allergy-toggle-button" data-allergen="shellfish" data-policy="block">Blokér</button>
                    </div>
                  </div>

                  <div class="allergy-item" data-allergen-row="sesame">
                    <div class="allergy-label">
                      <span class="emoji">🧆</span>
                      <span>Sesam</span>
                    </div>
                    <div class="allergy-toggle-group">
                      <button type="button" class="allergy-toggle-button" data-allergen="sesame" data-policy="allow">Tillad</button>
                      <button type="button" class="allergy-toggle-button" data-allergen="sesame" data-policy="warn">Advar</button>
                      <button type="button" class="allergy-toggle-button" data-allergen="sesame" data-policy="block">Blokér</button>
                    </div>
                  </div>

                <div class="allergy-item" data-allergen-row="soy">
                    <div class="allergy-label">
                      <span class="emoji">🫘</span>
                      <span>Soja</span>
                    </div>
                    <div class="allergy-toggle-group">
                      <button type="button" class="allergy-toggle-button" data-allergen="soy" data-policy="allow">Tillad</button>
                      <button type="button" class="allergy-toggle-button" data-allergen="soy" data-policy="warn">Advar</button>
                      <button type="button" class="allergy-toggle-button" data-allergen="soy" data-policy="block">Blokér</button>
                    </div>
                  </div>
                </div>
                      <div class="allergy-save-row">
                        <button type="button" id="save-allergy-btn">Gem allergi-indstillinger</button>
                        <div id="allergy-feedback" class="allergy-feedback"></div>
                      </div>
                    </section>
                  </div>
                </div>

                <!-- 10. Skift kode til forældre-login -->
                <div class="collapsible-section-container" id="change-pin-collapsible">
                  <div class="collapsible-section-header">
                    <div class="collapsible-section-title">
                      <div class="collapsible-section-icon">🔑</div>
                      <span>Skift kode til forældre-login</span>
                    </div>
                    <div class="collapsible-section-arrow">▼</div>
                  </div>
                  <div class="collapsible-section-content">
                    <section class="card" style="margin: 0; border: none; box-shadow: none; padding: 0;">
                      <h2 class="section-title" style="display: none; font-size: 13px; font-weight: 600; color: #0f172a; display: flex; align-items: center; gap: 7px;">
                        <div class="icon" style="width: 24px; height: 24px; border-radius: 999px; background: rgba(255, 122, 60, 0.12); display: flex; align-items: center; justify-content: center; font-size: 14px;">🔑</div>
                        Skift kode til forældre-login
                      </h2>
                      <p class="section-subtitle" style="font-size: 11px; color: #6b7280; margin-bottom: 12px;">
                        Her kan du ændre den kode, du bruger til Flango Forældre-portal.
                      </p>

                      <form id="change-pin-form" class="login-form" style="gap: 6px;">
                  <div class="form-group">
                    <input
                      type="password"
                      id="new-pin"
                      maxlength="20"
                      autocomplete="off"
                      placeholder="Ny kode (mindst 4 tegn)"
                      required
                      style="padding: 7px 12px; font-size: 12px;"
                    />
                  </div>

                  <div class="form-group">
                    <input
                      type="password"
                      id="confirm-new-pin"
                      maxlength="20"
                      autocomplete="off"
                      placeholder="Gentag ny kode"
                      required
                      style="padding: 7px 12px; font-size: 12px;"
                    />
                  </div>
                        <button type="submit" class="primary-btn" style="padding: 6px 11px; font-size: 11px; font-weight: 600; background: linear-gradient(135deg, #ff7a3c, #ffb100); box-shadow: 0 10px 22px rgba(248, 113, 22, 0.4);">Gem ny kode</button>
                        <p id="change-pin-message" style="margin-top: 6px; font-size: 11px; display: none;"></p>
                      </form>
                    </section>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>
      </div>

      <p class="footer-note">
        Flango er udviklet til SFO’er og fritidsklubber, så børn kan øve ansvar på en tryg måde.
      </p>
    </main>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const FUNCTION_URL =
        "https://jbknjgbpghrbrstqwoxj.functions.supabase.co/get-parent-view";
      const SAVE_NOTIFY_URL =
        "https://jbknjgbpghrbrstqwoxj.functions.supabase.co/save-parent-notification";
      const GET_ALLERGY_URL =
        "https://jbknjgbpghrbrstqwoxj.functions.supabase.co/get-allergy-settings";
      const GET_PRODUCTS_URL =
        "https://jbknjgbpghrbrstqwoxj.functions.supabase.co/get-products-for-parent";
      const SAVE_SUGAR_POLICY_URL =
        "https://jbknjgbpghrbrstqwoxj.functions.supabase.co/save-parent-sugar-policy";
      const GET_PARENT_EVENTS_URL =
        "https://jbknjgbpghrbrstqwoxj.functions.supabase.co/get-parent-events";
      const PARENT_EVENT_REGISTER_URL =
        "https://jbknjgbpghrbrstqwoxj.functions.supabase.co/parent-event-register";
      const PARENT_EVENT_CANCEL_URL =
        "https://jbknjgbpghrbrstqwoxj.functions.supabase.co/parent-event-cancel";
      const CREATE_EVENT_PAYMENT_URL =
        "https://jbknjgbpghrbrstqwoxj.functions.supabase.co/create-event-payment";
      const CONFIRM_EVENT_PAYMENT_URL =
        "https://jbknjgbpghrbrstqwoxj.functions.supabase.co/confirm-event-payment";
      const CREATE_TOPUP_URL =
        "https://jbknjgbpghrbrstqwoxj.functions.supabase.co/create-topup";
      const CONFIRM_TOPUP_URL =
        "https://jbknjgbpghrbrstqwoxj.functions.supabase.co/confirm-topup";

      const SUPABASE_URL = "https://jbknjgbpghrbrstqwoxj.supabase.co";
      const SUPABASE_ANON_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impia25qZ2JwZ2hyYnJzdHF3b3hqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI2MjIwNjMsImV4cCI6MjA3ODE5ODA2M30.ZMlxQyzmXuy43EcKIN6-eO8pJZs2F6kfDw_cfaks9qQ";
      const LINK_SIBLING_URL =
        "https://jbknjgbpghrbrstqwoxj.functions.supabase.co/link-sibling-by-code";

      const supabase = window.supabase.createClient(
        SUPABASE_URL,
        SUPABASE_ANON_KEY
      );

      let institutions = [];
      let currentChildId = null;
      let currentParentPin = null;
      let currentChildName = null;
      let allowedChildren = []; // Liste over alle børn forælderen har adgang til

      const loginView = document.getElementById("login-view");
      const resultsView = document.getElementById("results-view");
      const loginForm = document.getElementById("parent-login-form");
      const loginBtn = document.getElementById("login-btn");
      const loginError = document.getElementById("login-error");
      const logoutBtn = document.getElementById("logout-btn");
      const emailLoginForm = document.getElementById("email-login-form");
      const emailLoginBtn = document.getElementById("email-login-btn");
      const emailLoginError = document.getElementById("email-login-error");
      const emailLoginSuccess = document.getElementById("email-login-success");
      const linkSiblingBtn = document.getElementById("link-sibling-btn");
      const childSwitcher = document.getElementById("child-switcher");
      const childSwitcherSelect = document.getElementById("child-switcher-select");
      const institutionSelect = document.getElementById("institution-select");
      const institutionLabel = document.getElementById("institution-label");

      // Referencer til "Skift kode"
      const changePinForm = document.getElementById("change-pin-form");
      const newPinInput = document.getElementById("new-pin");
      const confirmNewPinInput = document.getElementById("confirm-new-pin");
      const changePinMessage = document.getElementById("change-pin-message");

      const UPDATE_PIN_URL =
        "https://jbknjgbpghrbrstqwoxj.functions.supabase.co/update-parent-pin";

      const institutionRow = document.getElementById("institution-row");
      const institutionInfo = document.getElementById("institution-info");
      const institutionNameLabel = document.getElementById("institution-name-label");

      const parentEmailInput = document.getElementById("parent-email-input");
      const notifyZeroCheckbox = document.getElementById("notify-zero-checkbox");
      const notifyTenCheckbox = document.getElementById("notify-ten-checkbox");
      const saveNotifyBtn = document.getElementById("save-notify-btn");
      const notifyFeedback = document.getElementById("notify-feedback");

      const balanceDot = document.getElementById("balance-dot");

      const SAVE_ALLERGY_URL =
        "https://jbknjgbpghrbrstqwoxj.functions.supabase.co/save-allergy-settings";
      const SAVE_DAILY_LIMIT_URL =
        "https://jbknjgbpghrbrstqwoxj.functions.supabase.co/save-daily-limit";

      const allergyButtons = document.querySelectorAll(
        ".allergy-toggle-button[data-allergen][data-policy]"
      );
      const saveAllergyBtn = document.getElementById("save-allergy-btn");
      const allergyFeedback = document.getElementById("allergy-feedback");

      // Daglig beløbsgrænse (forældre)
      const dailyLimitInput = document.getElementById("daily-limit-input");
      const dailyLimitChips = document.querySelectorAll(".daily-limit-chip");
      const saveDailyLimitBtn = document.getElementById("save-daily-limit-btn");
      const dailyLimitFeedback = document.getElementById("daily-limit-feedback");

      // Betalingssektion (kontant / QR / portal)
      const paymentCard = document.getElementById("payment-card");
      const paymentGrid = document.getElementById("payment-grid");
      const paymentFeedback = document.getElementById("payment-feedback");
      const paymentStatusBadge = document.getElementById("payment-status-badge");
      const paymentQrWrap = document.getElementById("payment-qr");
      const paymentQrImg = document.getElementById("payment-qr-img");
      const paymentQrNote = document.getElementById("payment-qr-note");
      let currentInstitutionId = null;
      let currentInstitutionPrefs = null;
      let selectedTopupAmount = null;

      function safeBool(v) {
        return v === true || v === "true" || v === 1 || v === "1";
      }

      function renderPaymentSection(prefs) {
        console.log('[renderPaymentSection] START med prefs:', prefs);
        const paymentCollapsible = document.getElementById("payment-collapsible");
        if (!paymentCard || !paymentGrid) {
          console.warn('[renderPaymentSection] paymentCard eller paymentGrid mangler!');
          return;
        }

        // Standard: intet
        paymentGrid.innerHTML = "";
        if (paymentFeedback) paymentFeedback.textContent = "";
        if (paymentQrWrap) paymentQrWrap.style.display = "none";

        // Parse new parent_portal_payment structure or fall back to old keys
        let paymentSettings = {};
        if (prefs && prefs.parent_portal_payment) {
          try {
            paymentSettings = typeof prefs.parent_portal_payment === 'string' 
              ? JSON.parse(prefs.parent_portal_payment) 
              : prefs.parent_portal_payment;
            console.log('[renderPaymentSection] Parsed paymentSettings:', paymentSettings);
          } catch (e) {
            console.warn('[parent-portal] Failed to parse payment settings:', e);
          }
        } else {
          console.warn('[renderPaymentSection] Ingen parent_portal_payment i prefs:', prefs);
        }

        // Use new parent_portal_payment structure (only use old keys if new structure doesn't exist)
        const hasNewStructure = prefs && prefs.parent_portal_payment;
        const cashEnabled = hasNewStructure 
          ? paymentSettings.cash?.enabled === true 
          : safeBool(prefs && prefs.topup_cash_enabled);
        const qrEnabled = hasNewStructure 
          ? paymentSettings.mobilepay_qr?.enabled === true 
          : safeBool(prefs && prefs.topup_qr_enabled);
        const portalEnabled = hasNewStructure 
          ? paymentSettings.stripe_connect?.enabled === true 
          : safeBool(prefs && prefs.topup_portal_enabled);
        const mobilepayApiEnabled = paymentSettings.mobilepay_api?.enabled === true;
        const qrScreenshotEnabled = paymentSettings.mobilepay_qr_screenshot?.enabled === true;

        const anyEnabled = cashEnabled || qrEnabled || portalEnabled || mobilepayApiEnabled || qrScreenshotEnabled;
        console.log('[renderPaymentSection] anyEnabled:', anyEnabled, {
          cashEnabled, qrEnabled, portalEnabled, mobilepayApiEnabled, qrScreenshotEnabled
        });
        
        const prefsHasTopupKeys = !!(
          prefs &&
          (prefs.parent_portal_payment ||
            "topup_cash_enabled" in prefs ||
            "topup_qr_enabled" in prefs ||
            "topup_portal_enabled" in prefs)
        );

        console.log('[renderPaymentSection] prefsHasTopupKeys:', prefsHasTopupKeys, {
          has_parent_portal_payment: !!prefs?.parent_portal_payment,
          has_topup_cash: "topup_cash_enabled" in (prefs || {}),
          has_topup_qr: "topup_qr_enabled" in (prefs || {}),
          has_topup_portal: "topup_portal_enabled" in (prefs || {}),
        });

        if (!prefsHasTopupKeys) {
          console.warn('[renderPaymentSection] prefsHasTopupKeys er false - viser fejlbesked');
          if (paymentCollapsible) {
            paymentCollapsible.style.display = "block";
          }
          if (paymentStatusBadge) {
            // Hvis prefs er tomt objekt (pga RLS fejl), vis bedre besked
            if (prefs && Object.keys(prefs).length === 0) {
              paymentStatusBadge.textContent = "Indlæser...";
            } else {
              paymentStatusBadge.textContent = "Kunne ikke hente";
            }
          }
          paymentGrid.innerHTML = `
            <div class="payment-option">
              <div class="payment-option-title">
                <div class="left"><span class="emoji">⚠️</span><span>Optankning midlertidigt utilgængelig</span></div>
                <span class="payment-badge">Info</span>
              </div>
              <div class="payment-body">
                Vi kunne ikke hente betalingsmuligheder lige nu. Prøv igen om lidt.
              </div>
            </div>
          `;
          return;
        }

        // Vis/skjul collapsible sektionen baseret på om der er betalingsmuligheder
        if (paymentCollapsible) {
          paymentCollapsible.style.display = anyEnabled ? "block" : "none";
        }

        if (!anyEnabled) {
          if (paymentStatusBadge) {
            paymentStatusBadge.textContent = "Ingen online optankning";
          }
          paymentGrid.innerHTML = `
            <div class="payment-option">
              <div class="payment-option-title">
                <div class="left"><span class="emoji">🏫</span><span>Kontakt personalet</span></div>
                <span class="payment-badge">Info</span>
              </div>
              <div class="payment-body">
                Denne institution modtager ikke online optankning i Flango lige nu.
                Kontakt personalet for hjælp til optankning.
              </div>
            </div>
          `;
          return;
        }

        // Payment card vises nu via collapsible sektionen

        // Count enabled methods for badge (in correct order: Stripe, MobilePay API, CSV, QR, QR+Screenshot, Cash)
        const enabledCount = [portalEnabled, mobilepayApiEnabled, qrEnabled, qrScreenshotEnabled, cashEnabled].filter(Boolean).length;
        
        // Badge
        if (paymentStatusBadge) {
          if (enabledCount > 1) {
            paymentStatusBadge.textContent = `${enabledCount} muligheder`;
          } else if (portalEnabled || mobilepayApiEnabled) {
            paymentStatusBadge.textContent = "Automatisk optankning";
          } else if (qrEnabled || qrScreenshotEnabled) {
            paymentStatusBadge.textContent = "MobilePay";
          } else if (cashEnabled) {
            paymentStatusBadge.textContent = "Kontant";
          } else {
            paymentStatusBadge.textContent = "Ingen muligheder";
          }
        }

        // Render methods in correct order (matching admin panel):
        // 1. Stripe Connect
        // 2. MobilePay API
        // 3. MobilePay QR
        // 4. MobilePay QR + Screenshot
        // 5. Kontant

        // 1. Stripe Connect (Portal optankning)
        if (portalEnabled) {
          const portalText =
            (prefs && (prefs.topup_portal_message || prefs.portal_topup_message)) ||
            "Forældre indbetaler direkte i forældreportalen. Saldo opdateres automatisk med det samme.";
          const recommendedClass = enabledCount > 1 ? "recommended" : "";
          const recommendedBadge = enabledCount > 1 ? `<span class="payment-badge good">Anbefalet</span>` : `<span class="payment-badge good">Aktiv</span>`;

          paymentGrid.insertAdjacentHTML(
            "beforeend",
            `
            <div class="payment-option ${recommendedClass}" id="stripe-connect-option">
              <div class="payment-option-title">
                <div class="left"><span class="emoji">🟢</span><span>Stripe Connect</span></div>
                ${recommendedBadge}
              </div>
              <div class="payment-body">${portalText}</div>

              <div class="payment-actions" id="stripe-topup-amounts">
                <button type="button" class="payment-amount" data-amount="50" data-method="stripe">50 kr.</button>
                <button type="button" class="payment-amount" data-amount="100" data-method="stripe">100 kr.</button>
                <button type="button" class="payment-amount" data-amount="150" data-method="stripe">150 kr.</button>
              </div>

              <div class="payment-row">
                <input type="number" id="stripe-topup-amount-input" min="0" step="1" placeholder="Andet beløb i kr." />
                <button type="button" id="stripe-topup-now-btn">Tank op</button>
              </div>
              <div class="payment-qr-note" style="margin-top: 6px;">
                Optankning kræver at institutionen har slået online-betaling til. Hvis knappen ikke virker, kontakt personalet.
              </div>
            </div>
            `
          );
        }

        // 2. MobilePay API
        if (mobilepayApiEnabled) {
          const apiText = "Forældre indbetaler via MobilePay. Saldo opdateres automatisk, når betalingen er gennemført.";
          const apiClass = portalEnabled ? "secondary" : "";
          const apiBadge = portalEnabled ? `<span class="payment-badge warn">Kræver opsætning</span>` : `<span class="payment-badge good">Aktiv</span>`;

          paymentGrid.insertAdjacentHTML(
            "beforeend",
            `
            <div class="payment-option ${apiClass}" id="mobilepay-api-option">
              <div class="payment-option-title">
                <div class="left"><span class="emoji">🔵</span><span>MobilePay API</span></div>
                ${apiBadge}
              </div>
              <div class="payment-body">${apiText}</div>
              <div class="payment-qr-note" style="margin-top: 6px;">
                Denne metode kræver at institutionen har en MobilePay API-aftale. Kontakt personalet for at få adgang.
              </div>
            </div>
            `
          );
        }

        // 3. MobilePay QR
        if (qrEnabled) {
          const qrText =
            (prefs && (prefs.topup_qr_message || prefs.qr_topup_message)) ||
            "Forældre scanner en QR-kode. Personalet registrerer indbetalingen manuelt i Flango.";
          const secondaryClass = (portalEnabled || mobilepayApiEnabled) ? "secondary" : "";
          const badge = (portalEnabled || mobilepayApiEnabled) ? `<span class="payment-badge warn">Manuel</span>` : `<span class="payment-badge warn">Aktiv</span>`;

          paymentGrid.insertAdjacentHTML(
            "beforeend",
            `
            <div class="payment-option ${secondaryClass}" id="qr-topup-option">
              <div class="payment-option-title">
                <div class="left"><span class="emoji">🟡</span><span>MobilePay QR</span></div>
                ${badge}
              </div>
              <div class="payment-body">${qrText}</div>
              <div class="payment-actions">
                <button type="button" class="payment-amount" id="show-qr-btn">Vis QR</button>
              </div>
            </div>
            `
          );

          // QR-asset
          const qrUrl = prefs && (prefs.topup_qr_image_url || prefs.qr_image_url || prefs.mobilepay_qr_url);
          if (paymentQrImg && qrUrl) {
            paymentQrImg.src = qrUrl;
          } else if (paymentQrImg) {
            paymentQrImg.removeAttribute("src");
          }

          if (paymentQrNote) paymentQrNote.textContent = qrText;
        }

        // 4. MobilePay QR + Screenshot
        if (qrScreenshotEnabled) {
          const screenshotText = "Forældre sender et skærmbillede som betalingsbevis. Personalet registrerer manuelt i Flango.";
          const screenshotBadge = `<span class="payment-badge" style="background: #f44336; color: white;">Nødløsning</span>`;

          paymentGrid.insertAdjacentHTML(
            "beforeend",
            `
            <div class="payment-option" id="qr-screenshot-option">
              <div class="payment-option-title">
                <div class="left"><span class="emoji">📸</span><span>MobilePay QR + Screenshot</span></div>
                ${screenshotBadge}
              </div>
              <div class="payment-body">${screenshotText}</div>
              <div class="payment-qr-note" style="margin-top: 6px; color: #856404;">
                Nødløsning: kan give ekstra administration. Send skærmbillede af betalingen til klubbens mobil.
              </div>
            </div>
            `
          );
        }

        // 5. Kontant
        if (cashEnabled) {
          const cashText =
            (prefs && (prefs.topup_cash_message || prefs.cash_topup_message)) ||
            "Personalet tager imod kontanter og registrerer indbetalingen manuelt i Flango.";
          paymentGrid.insertAdjacentHTML(
            "beforeend",
            `
            <div class="payment-option" id="cash-option">
              <div class="payment-option-title">
                <div class="left"><span class="emoji">💵</span><span>Kontant indbetaling</span></div>
                <span class="payment-badge" style="background: #757575; color: white;">Offline</span>
              </div>
              <div class="payment-body">${cashText}</div>
            </div>
            `
          );
        }

        // Wire events (amount chips + show QR + portal topup)
        wirePaymentEvents();
      }

      function wirePaymentEvents() {
        if (!paymentCard) return;

        // Handle all amount buttons (both old and new IDs)
        const amountButtons = paymentCard.querySelectorAll(".payment-amount[data-amount]");
        const amountInput = document.getElementById("topup-amount-input") || document.getElementById("stripe-topup-amount-input");
        const topupNowBtn = document.getElementById("topup-now-btn") || document.getElementById("stripe-topup-now-btn");
        const showQrBtn = document.getElementById("show-qr-btn");

        // Amount buttons
        if (amountButtons && amountButtons.length) {
          amountButtons.forEach((btn) => {
            // Remove existing listeners by cloning
            const newBtn = btn.cloneNode(true);
            btn.parentNode.replaceChild(newBtn, btn);
            
            newBtn.addEventListener("click", () => {
              const amt = Number(newBtn.dataset.amount);
              if (!Number.isFinite(amt)) return;

              selectedTopupAmount = amt;
              // Remove active from all buttons in the same container
              const container = newBtn.closest('.payment-option');
              if (container) {
                container.querySelectorAll(".payment-amount[data-amount]").forEach((b) => b.classList.remove("is-active"));
              }
              newBtn.classList.add("is-active");

              const currentInput = document.getElementById("topup-amount-input") || document.getElementById("stripe-topup-amount-input");
              if (currentInput) {
                currentInput.value = String(amt);
                currentInput.focus();
              }
              if (paymentFeedback) paymentFeedback.textContent = "";
            });
          });
        }

        // Show QR
        if (showQrBtn) {
          const newShowQrBtn = showQrBtn.cloneNode(true);
          showQrBtn.parentNode.replaceChild(newShowQrBtn, showQrBtn);
          
          newShowQrBtn.addEventListener("click", () => {
            if (!paymentQrWrap) return;
            const hasSrc = paymentQrImg && paymentQrImg.getAttribute("src");
            paymentQrWrap.style.display = "block";
            if (!hasSrc && paymentFeedback) {
              paymentFeedback.textContent =
                "QR er slået til, men der er ikke uploadet et QR-billede endnu. Kontakt personalet.";
              paymentFeedback.style.color = "#92400e";
            }
          });
        }

        // Stripe Connect / Portal topup button
        if (topupNowBtn) {
          const newTopupBtn = topupNowBtn.cloneNode(true);
          topupNowBtn.parentNode.replaceChild(newTopupBtn, topupNowBtn);
          
          newTopupBtn.addEventListener("click", () => {
            const currentInput = document.getElementById("topup-amount-input") || document.getElementById("stripe-topup-amount-input");
            const amount = currentInput ? Number(currentInput.value) : selectedTopupAmount;
            
            if (!amount || amount <= 0) {
              if (paymentFeedback) {
                paymentFeedback.textContent = "Indtast et beløb først.";
                paymentFeedback.style.color = "#dc3545";
              }
              return;
            }
            if (paymentFeedback) paymentFeedback.textContent = "";
            handleTopupStripePayment(amount);
          });
        }
      }

      // Vis/skjul funktionssektioner baseret på institutionens indstillinger
      function renderFeatureSections(prefs) {
        // E-mail notifikationer (default true hvis ikke sat)
        const emailEnabled = prefs && prefs.parent_portal_email_notifications !== false;
        const emailCollapsible = document.getElementById("email-notification-collapsible");
        if (emailCollapsible) {
          emailCollapsible.style.display = emailEnabled ? "block" : "none";
        }

        // Historik - altid synlig, men lukket fra start
        const historyCollapsible = document.getElementById("history-collapsible");
        if (historyCollapsible) {
          historyCollapsible.style.display = "block";
          // Historik skal være lukket fra start
          const historyHeader = historyCollapsible.querySelector(".collapsible-section-header");
          const historyContent = historyCollapsible.querySelector(".collapsible-section-content");
          if (historyHeader && historyContent) {
            // Fjern active class hvis den er sat, så historik starter lukket
            historyHeader.classList.remove("active");
            historyContent.classList.remove("active");
            const arrow = historyHeader.querySelector(".collapsible-section-arrow");
            if (arrow) arrow.textContent = "▼";
          }
        }

        // Optank saldo - vises/skjules i renderPaymentSection baseret på prefs

        // Club Limitations - vis hvis der er begrænsninger
        const clubLimitationsCollapsible = document.getElementById("club-limitations-collapsible");
        // Vil blive sat til block i loadAndRenderClubLimitations hvis der er data

        // Daily Assortment - vil blive sat til block i loadAndRenderDailyAssortment hvis der er produkter

        // Daglig beløbsgrænse (default true hvis ikke sat)
        const spendingEnabled = prefs && prefs.parent_portal_spending_limit !== false;
        const spendingCollapsible = document.getElementById("spending-limit-collapsible");
        if (spendingCollapsible) {
          spendingCollapsible.style.display = spendingEnabled ? "block" : "none";
        }

        // Købsgrænser pr. produkt (default false - institution må aktivere)
        const productLimitEnabled = prefs && prefs.parent_portal_product_limit === true;
        const productLimitCollapsible = document.getElementById("product-limit-collapsible");
        if (productLimitCollapsible) {
          productLimitCollapsible.style.display = productLimitEnabled ? "block" : "none";
          if (productLimitEnabled && currentChildId && currentInstitutionId) {
            loadProductLimits(currentInstitutionId, currentChildId);
          }
        }

        // Sukkerpolitik (default false - institution må aktivere)
        const sugarPolicyEnabled = prefs && prefs.parent_portal_sugar_policy === true;
        const sugarPolicyCollapsible = document.getElementById("sugar-policy-collapsible");
        if (sugarPolicyCollapsible) {
          sugarPolicyCollapsible.style.display = sugarPolicyEnabled ? "block" : "none";
          if (sugarPolicyEnabled && currentChildId) {
            loadSugarPolicy();
          }
        }

        // Allergener (default true hvis ikke sat)
        const allergensEnabled = prefs && prefs.parent_portal_allergens !== false;
        const allergensCollapsible = document.getElementById("allergens-collapsible");
        if (allergensCollapsible) {
          allergensCollapsible.style.display = allergensEnabled ? "block" : "none";
        }

        // Skift kode - altid synlig
        const changePinCollapsible = document.getElementById("change-pin-collapsible");
        if (changePinCollapsible) {
          changePinCollapsible.style.display = "block";
        }
      }

      // ── Kommende arrangementer ──
      let eventsChildBalance = 0;

      async function loadAndRenderEvents(childId, parentPin) {
        const eventsCollapsible = document.getElementById("events-collapsible");
        const eventsList = document.getElementById("events-list");
        const eventsEmpty = document.getElementById("events-empty");
        const eventsFeedback = document.getElementById("events-feedback");
        if (!eventsList) return;

        eventsList.innerHTML = '<p style="font-size:13px;color:#6b7280;padding:8px 0;">Henter arrangementer...</p>';
        eventsEmpty.style.display = "none";
        eventsFeedback.innerHTML = "";

        try {
          const res = await fetch(GET_PARENT_EVENTS_URL, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              apikey: SUPABASE_ANON_KEY,
              Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
            },
            body: JSON.stringify({ child_id: childId, parent_pin: parentPin }),
          });
          const data = await res.json();

          if (!res.ok || data.error) {
            eventsList.innerHTML = "";
            eventsEmpty.style.display = "block";
            eventsEmpty.querySelector("p").textContent = data.error || "Kunne ikke hente arrangementer.";
            if (eventsCollapsible) eventsCollapsible.style.display = "block";
            return;
          }

          const events = data.events || [];
          eventsChildBalance = typeof data.child_balance === "number" ? data.child_balance : Number(data.child_balance || 0);

          if (events.length === 0) {
            eventsList.innerHTML = "";
            eventsEmpty.style.display = "block";
            if (eventsCollapsible) eventsCollapsible.style.display = "block";
            return;
          }

          eventsEmpty.style.display = "none";
          eventsList.innerHTML = "";

          let stripeAvailable = false;
          if (currentInstitutionPrefs) {
            try {
              const pp = typeof currentInstitutionPrefs.parent_portal_payment === "string"
                ? JSON.parse(currentInstitutionPrefs.parent_portal_payment)
                : currentInstitutionPrefs.parent_portal_payment;
              stripeAvailable = !!(pp && pp.stripe_connect && pp.stripe_connect.enabled);
            } catch (_) {}
          }

          events.forEach((ev) => {
            const card = document.createElement("div");
            card.className = "event-card" + (ev.registration ? " registered" : "");

            const dateStr = ev.event_date ? new Date(ev.event_date).toLocaleDateString("da-DK", { weekday: "short", day: "numeric", month: "short" }) : "";
            const timeStr = (ev.start_time || "").slice(0, 5) + (ev.end_time ? " – " + (ev.end_time || "").slice(0, 5) : "");
            const priceStr = ev.price > 0 ? ev.price + " kr." : "Gratis";
            const spotsStr = ev.remaining !== null && ev.remaining !== undefined ? ev.remaining + " plads" + (ev.remaining !== 1 ? "er" : "") : "";

            let badgeHtml = "";
            let actionsHtml = "";

            if (ev.registration) {
              const reg = ev.registration;
              if (reg.payment_status === "paid") {
                badgeHtml = '<span class="event-card-badge badge-paid">Betalt</span>';
              } else if (reg.payment_status === "not_paid") {
                badgeHtml = '<span class="event-card-badge badge-pending">Afventer betaling</span>';
              } else if (reg.payment_status === "not_required") {
                badgeHtml = '<span class="event-card-badge badge-registered">Tilmeldt</span>';
              } else {
                badgeHtml = '<span class="event-card-badge badge-registered">Tilmeldt</span>';
              }

              actionsHtml += '<button class="event-cancel-btn" data-event-id="' + ev.id + '">Frameld</button>';

              if (reg.payment_status === "not_paid" && ev.price > 0) {
                actionsHtml += '<button class="event-pay-btn" data-event-id="' + ev.id + '">Betal nu</button>';
              }
            } else {
              if (ev.remaining !== null && ev.remaining !== undefined && ev.remaining <= 0) {
                badgeHtml = '<span class="event-card-badge badge-full">Fuldt booket</span>';
                actionsHtml += '<button class="event-register-btn" disabled>Fuldt booket</button>';
              } else {
                actionsHtml += '<button class="event-register-btn" data-event-id="' + ev.id + '">Tilmeld</button>';
              }
            }

            card.innerHTML =
              '<div class="event-card-title">' + escapeHtml(ev.title) + '</div>' +
              (ev.description ? '<div class="event-card-desc">' + escapeHtml(ev.description) + '</div>' : '') +
              '<div class="event-card-meta">' +
                (dateStr ? '<span>' + dateStr + '</span>' : '') +
                (timeStr ? '<span>' + timeStr + '</span>' : '') +
                '<span>' + priceStr + '</span>' +
                (spotsStr ? '<span>' + spotsStr + '</span>' : '') +
              '</div>' +
              badgeHtml +
              '<div class="event-card-actions">' + actionsHtml + '</div>' +
              '<div class="event-card-feedback" id="event-fb-' + ev.id + '"></div>';

            // Wire register button
            const regBtn = card.querySelector(".event-register-btn[data-event-id]");
            if (regBtn) {
              regBtn.addEventListener("click", () => handleEventRegister(ev, eventsChildBalance, stripeAvailable));
            }

            // Wire cancel button
            const cancelBtn = card.querySelector(".event-cancel-btn[data-event-id]");
            if (cancelBtn) {
              cancelBtn.addEventListener("click", () => handleEventCancel(ev, childId, parentPin));
            }

            // Wire pay button
            const payBtn = card.querySelector(".event-pay-btn[data-event-id]");
            if (payBtn) {
              payBtn.addEventListener("click", () => handleEventPayNow(ev, eventsChildBalance, stripeAvailable));
            }

            eventsList.appendChild(card);
          });

          if (eventsCollapsible) eventsCollapsible.style.display = "block";
        } catch (err) {
          console.error("loadAndRenderEvents fejl:", err);
          eventsList.innerHTML = "";
          eventsEmpty.style.display = "block";
          eventsEmpty.querySelector("p").textContent = "Fejl ved hentning af arrangementer.";
          if (eventsCollapsible) eventsCollapsible.style.display = "block";
        }
      }

      function showEventFeedback(eventId, msg, type) {
        const fb = document.getElementById("event-fb-" + eventId);
        if (!fb) return;
        fb.className = "event-feedback " + type;
        fb.textContent = msg;
        setTimeout(() => { fb.textContent = ""; fb.className = ""; }, 5000);
      }

      function handleEventRegister(ev, childBalance, stripeAvailable) {
        if (ev.price <= 0) {
          // Gratis — direkte registrering
          doEventRegister(ev.id, false, "balance");
          return;
        }
        // Betalt — vis betalingsvalg overlay
        showEventPaymentOverlay(ev, childBalance, stripeAvailable, false);
      }

      function handleEventPayNow(ev, childBalance, stripeAvailable) {
        showEventPaymentOverlay(ev, childBalance, stripeAvailable, true);
      }

      function showEventPaymentOverlay(ev, childBalance, stripeAvailable, isPayOnly) {
        const existing = document.querySelector(".event-payment-overlay");
        if (existing) existing.remove();

        const overlay = document.createElement("div");
        overlay.className = "event-payment-overlay";

        const balanceDisabled = childBalance < ev.price;
        const balanceClass = balanceDisabled ? " disabled" : "";

        let optionsHtml = "";

        // Option 1: Betal med saldo
        optionsHtml += '<div class="event-payment-option' + balanceClass + '" data-action="balance">' +
          '<div class="opt-title">Betal med saldo (' + childBalance.toFixed(2) + ' kr.)</div>' +
          '<div class="opt-desc">' + (balanceDisabled ? 'Ikke nok saldo (pris: ' + ev.price + ' kr.)' : 'Beløbet trækkes fra barnets konto') + '</div>' +
          '</div>';

        // Option 2: Betal med kort (kun hvis Stripe)
        if (stripeAvailable) {
          optionsHtml += '<div class="event-payment-option" data-action="stripe">' +
            '<div class="opt-title">Betal med kort</div>' +
            '<div class="opt-desc">Betaling via Stripe (' + ev.price + ' kr.)</div>' +
            '</div>';
        }

        // Option 3: Betal senere (kun ved tilmelding, ikke ved efterbetaling)
        if (!isPayOnly) {
          optionsHtml += '<div class="event-payment-option" data-action="later">' +
            '<div class="opt-title">Betal senere</div>' +
            '<div class="opt-desc">Tilmeld nu, betal inden arrangementet</div>' +
            '</div>';
        }

        overlay.innerHTML =
          '<div class="event-payment-modal">' +
          '<h3>' + escapeHtml(ev.title) + '</h3>' +
          '<div class="modal-subtitle">Pris: ' + ev.price + ' kr.</div>' +
          optionsHtml +
          '<div id="event-stripe-mount"></div>' +
          '<button class="event-payment-close">Annuller</button>' +
          '</div>';

        document.body.appendChild(overlay);

        // Close button
        overlay.querySelector(".event-payment-close").addEventListener("click", () => overlay.remove());

        // Click outside
        overlay.addEventListener("click", (e) => {
          if (e.target === overlay) overlay.remove();
        });

        // Option handlers
        overlay.querySelectorAll(".event-payment-option").forEach((opt) => {
          opt.addEventListener("click", async () => {
            const action = opt.dataset.action;
            if (opt.classList.contains("disabled")) return;

            if (action === "balance") {
              overlay.remove();
              if (isPayOnly) {
                // Efterbetaling: registrer med pay_now=true, balance
                await doEventRegister(ev.id, true, "balance");
              } else {
                await doEventRegister(ev.id, true, "balance");
              }
            } else if (action === "stripe") {
              // Disable alle options mens Stripe loader
              overlay.querySelectorAll(".event-payment-option").forEach(o => o.classList.add("disabled"));
              const closeBtn = overlay.querySelector(".event-payment-close");
              closeBtn.textContent = "Vent venligst...";

              if (!isPayOnly) {
                // Registrér først med pay_now=false
                const regResult = await doEventRegisterRaw(ev.id, false, "balance");
                if (!regResult || !regResult.success) {
                  overlay.remove();
                  return;
                }
              }
              // Start Stripe flow
              await handleEventStripePayment(ev.id, overlay);
            } else if (action === "later") {
              overlay.remove();
              await doEventRegister(ev.id, false, "balance");
            }
          });
        });
      }

      async function doEventRegisterRaw(eventId, payNow, paymentType) {
        try {
          const res = await fetch(PARENT_EVENT_REGISTER_URL, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              apikey: SUPABASE_ANON_KEY,
              Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
            },
            body: JSON.stringify({
              child_id: currentChildId,
              parent_pin: currentParentPin,
              event_id: eventId,
              pay_now: payNow,
              payment_type: paymentType,
            }),
          });
          const data = await res.json();
          if (!res.ok || data.error) {
            showEventFeedback(eventId, data.error || "Tilmelding mislykkedes.", "error");
            return null;
          }
          return data;
        } catch (err) {
          console.error("doEventRegisterRaw fejl:", err);
          showEventFeedback(eventId, "Netværksfejl ved tilmelding.", "error");
          return null;
        }
      }

      async function doEventRegister(eventId, payNow, paymentType) {
        const result = await doEventRegisterRaw(eventId, payNow, paymentType);
        if (result && result.success) {
          showEventFeedback(eventId, payNow ? "Tilmeldt og betalt!" : "Tilmeldt!", "success");
          // Opdatér saldo i UI hvis betalt med saldo
          if (payNow && paymentType === "balance" && result.price_at_signup) {
            const balanceEl = document.getElementById("balance-display") || document.querySelector(".balance-amount");
            if (balanceEl) {
              eventsChildBalance -= Number(result.price_at_signup);
              balanceEl.textContent = eventsChildBalance.toFixed(2) + " kr";
              updateBalanceStatus(eventsChildBalance);
            }
          }
          // Genindlæs events
          await loadAndRenderEvents(currentChildId, currentParentPin);
        }
      }

      async function handleEventCancel(ev, childId, parentPin) {
        const now = new Date();
        const eventStart = new Date(ev.event_date + "T" + (ev.start_time || "00:00:00"));
        const hasStarted = eventStart <= now;
        const isPaid = ev.registration && ev.registration.payment_status === "paid";

        let confirmMsg = "Er du sikker på, at du vil framelde dit barn fra \"" + ev.title + "\"?";
        if (isPaid && !hasStarted) {
          confirmMsg += "\n\nBeløbet (" + ev.registration.price_at_signup + " kr.) refunderes til barnets saldo.\n\nBemærk: Kortbetalinger refunderes til barnets saldo, ikke til kortet.";
        } else if (isPaid && hasStarted) {
          confirmMsg += "\n\nIngen refusion efter arrangementets start.";
        }

        if (!confirm(confirmMsg)) return;

        try {
          const res = await fetch(PARENT_EVENT_CANCEL_URL, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              apikey: SUPABASE_ANON_KEY,
              Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
            },
            body: JSON.stringify({
              child_id: childId,
              parent_pin: parentPin,
              event_id: ev.id,
            }),
          });
          const data = await res.json();

          if (!res.ok || !data.success) {
            showEventFeedback(ev.id, data.error || "Framelding mislykkedes.", "error");
            return;
          }

          let msg = "Frameldt!";
          if (data.refunded && data.refund_amount > 0) {
            msg = "Frameldt! " + Number(data.refund_amount).toFixed(2) + " kr. refunderet til saldo.";
            eventsChildBalance += Number(data.refund_amount);
            const balanceEl = document.getElementById("balance-display") || document.querySelector(".balance-amount");
            if (balanceEl) {
              balanceEl.textContent = eventsChildBalance.toFixed(2) + " kr";
              updateBalanceStatus(eventsChildBalance);
            }
          }
          showEventFeedback(ev.id, msg, "success");
          await loadAndRenderEvents(childId, parentPin);
        } catch (err) {
          console.error("handleEventCancel fejl:", err);
          showEventFeedback(ev.id, "Netværksfejl ved framelding.", "error");
        }
      }

      async function handleEventStripePayment(eventId, overlay) {
        const mountPoint = overlay.querySelector("#event-stripe-mount");
        if (!mountPoint) return;

        mountPoint.innerHTML = '<p style="font-size:13px;color:#6b7280;">Opretter betaling...</p>';

        try {
          // 1. Create PaymentIntent
          const res = await fetch(CREATE_EVENT_PAYMENT_URL, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              apikey: SUPABASE_ANON_KEY,
              Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
            },
            body: JSON.stringify({
              child_id: currentChildId,
              parent_pin: currentParentPin,
              event_id: eventId,
            }),
          });
          const data = await res.json();

          if (!res.ok || data.error) {
            mountPoint.innerHTML = '<p class="event-stripe-error">' + escapeHtml(data.error || "Kunne ikke oprette betaling.") + '</p>';
            const closeBtn = overlay.querySelector(".event-payment-close");
            closeBtn.textContent = "Luk";
            overlay.querySelectorAll(".event-payment-option").forEach(o => o.classList.remove("disabled"));
            return;
          }

          const { clientSecret, registration_id, stripe_publishable_key, stripe_account_id } = data;

          if (!stripe_publishable_key) {
            mountPoint.innerHTML = '<p class="event-stripe-error">Stripe er ikke konfigureret korrekt. Kontakt personalet.</p>';
            const closeBtn = overlay.querySelector(".event-payment-close");
            closeBtn.textContent = "Luk";
            return;
          }

          // 2. Load Stripe.js dynamically
          if (!window.Stripe) {
            await new Promise((resolve, reject) => {
              const script = document.createElement("script");
              script.src = "https://js.stripe.com/v3/";
              script.onload = resolve;
              script.onerror = reject;
              document.head.appendChild(script);
            });
          }

          // 3. Init Stripe + Elements
          const stripe = window.Stripe(stripe_publishable_key, {
            stripeAccount: stripe_account_id,
          });
          const elements = stripe.elements({
            clientSecret: clientSecret,
            appearance: { theme: "stripe" },
          });
          const paymentElement = elements.create("payment");

          mountPoint.innerHTML =
            '<div class="event-stripe-container">' +
            '<div id="event-payment-element"></div>' +
            '<button class="event-stripe-submit">Betal nu</button>' +
            '<div class="event-stripe-error" id="event-stripe-error-msg"></div>' +
            '</div>';

          paymentElement.mount("#event-payment-element");

          const closeBtn = overlay.querySelector(".event-payment-close");
          closeBtn.textContent = "Annuller";
          closeBtn.addEventListener("click", () => overlay.remove());

          // 4. Handle submit
          const submitBtn = mountPoint.querySelector(".event-stripe-submit");
          submitBtn.addEventListener("click", async () => {
            submitBtn.disabled = true;
            submitBtn.textContent = "Behandler...";
            const errEl = document.getElementById("event-stripe-error-msg");
            errEl.textContent = "";

            const { error: stripeError, paymentIntent } = await stripe.confirmPayment({
              elements,
              confirmParams: {},
              redirect: "if_required",
            });

            if (stripeError) {
              errEl.textContent = stripeError.message || "Betaling mislykkedes.";
              submitBtn.disabled = false;
              submitBtn.textContent = "Betal nu";
              return;
            }

            if (paymentIntent && paymentIntent.status === "succeeded") {
              // 5. Confirm payment on backend
              submitBtn.textContent = "Bekræfter...";
              try {
                const confirmRes = await fetch(CONFIRM_EVENT_PAYMENT_URL, {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                    apikey: SUPABASE_ANON_KEY,
                    Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
                  },
                  body: JSON.stringify({
                    child_id: currentChildId,
                    parent_pin: currentParentPin,
                    registration_id: registration_id,
                    payment_intent_id: paymentIntent.id,
                  }),
                });
                const confirmData = await confirmRes.json();

                if (confirmRes.ok && confirmData.success) {
                  overlay.remove();
                  showEventFeedback(eventId, "Betaling gennemført!", "success");
                  await loadAndRenderEvents(currentChildId, currentParentPin);
                } else {
                  errEl.textContent = confirmData.error || "Kunne ikke bekræfte betaling.";
                  submitBtn.disabled = false;
                  submitBtn.textContent = "Prøv igen";
                }
              } catch (confirmErr) {
                console.error("confirm-event-payment fejl:", confirmErr);
                errEl.textContent = "Netværksfejl ved bekræftelse. Betalingen er gennemført — kontakt personalet.";
              }
            } else {
              errEl.textContent = "Betaling blev ikke gennemført.";
              submitBtn.disabled = false;
              submitBtn.textContent = "Betal nu";
            }
          });
        } catch (err) {
          console.error("handleEventStripePayment fejl:", err);
          mountPoint.innerHTML = '<p class="event-stripe-error">Fejl ved indlæsning af betaling. Prøv igen.</p>';
          const closeBtn = overlay.querySelector(".event-payment-close");
          closeBtn.textContent = "Luk";
        }
      }

      async function refreshParentView() {
        if (!currentInstitutionId || !currentParentPin) return;
        // Brug child_id hvis tilgængelig, ellers name_input
        const body = currentChildId
          ? {
              institution_id: currentInstitutionId,
              child_id: currentChildId,
              parent_pin: currentParentPin,
            }
          : {
              institution_id: currentInstitutionId,
              name_input: currentChildName,
              parent_pin: currentParentPin,
            };

        try {
          const res = await fetch(FUNCTION_URL, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              apikey: SUPABASE_ANON_KEY,
              Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
            },
            body: JSON.stringify(body),
          });
          const data = await res.json().catch(() => ({}));
          if (res.ok && data.child_id) {
            displayResults(data);
            // Opdater allowed_children
            if (data.allowed_children && Array.isArray(data.allowed_children)) {
              allowedChildren = data.allowed_children;
              renderChildSwitcher(allowedChildren);
            }
            if (currentChildId && currentParentPin) {
              loadAndRenderEvents(currentChildId, currentParentPin);
            }
          }
        } catch (e) {
          console.error("refreshParentView fejl:", e);
        }
      }

      async function handleTopupStripePayment(amountDkk) {
        const overlay = document.createElement("div");
        overlay.className = "modal-overlay";
        overlay.style.cssText = "position:fixed;inset:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999;padding:20px;box-sizing:border-box;";
        overlay.innerHTML =
          '<div class="event-payment-modal" style="background:var(--card-bg);border-radius:16px;padding:24px;max-width:420px;width:100%;box-shadow:0 18px 45px rgba(15,23,42,0.18);box-sizing:border-box;">' +
          '<h3 style="margin:0 0 8px 0;">Optank saldo – ' + (typeof amountDkk === "number" ? amountDkk : 0) + ' kr.</h3>' +
          '<div id="topup-stripe-mount" style="margin-top:12px;"></div>' +
          '<button type="button" class="event-payment-close" style="margin-top:16px;padding:10px 16px;cursor:pointer;">Annuller</button>' +
          '</div>';
        document.body.appendChild(overlay);

        const mountPoint = overlay.querySelector("#topup-stripe-mount");
        const closeBtn = overlay.querySelector(".event-payment-close");
        closeBtn.addEventListener("click", () => overlay.remove());
        overlay.addEventListener("click", (e) => {
          if (e.target === overlay) overlay.remove();
        });

        mountPoint.innerHTML = '<p style="font-size:13px;color:#6b7280;">Opretter betaling...</p>';

        try {
          const res = await fetch(CREATE_TOPUP_URL, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              apikey: SUPABASE_ANON_KEY,
              Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
            },
            body: JSON.stringify({
              child_id: currentChildId,
              parent_pin: currentParentPin,
              amount_dkk: amountDkk,
            }),
          });
          const data = await res.json();

          if (!res.ok || data.error) {
            mountPoint.innerHTML = '<p class="event-stripe-error">' + escapeHtml(data.error || "Kunne ikke oprette betaling.") + '</p>';
            return;
          }

          const { clientSecret, stripe_publishable_key } = data;
          if (!stripe_publishable_key) {
            mountPoint.innerHTML = '<p class="event-stripe-error">Stripe er ikke konfigureret korrekt. Kontakt personalet.</p>';
            return;
          }

          if (!window.Stripe) {
            await new Promise((resolve, reject) => {
              const s = document.createElement("script");
              s.src = "https://js.stripe.com/v3/";
              s.onload = resolve;
              s.onerror = reject;
              document.head.appendChild(s);
            });
          }

          const stripe = window.Stripe(stripe_publishable_key);
          const elements = stripe.elements({
            clientSecret: clientSecret,
            appearance: { theme: "stripe" },
          });
          const paymentElement = elements.create("payment");

          mountPoint.innerHTML =
            '<div class="event-stripe-container">' +
            '<div id="topup-payment-element"></div>' +
            '<button class="event-stripe-submit" type="button">Betal nu</button>' +
            '<div class="event-stripe-error" id="topup-stripe-error-msg"></div>' +
            '</div>';
          paymentElement.mount("#topup-payment-element");

          const submitBtn = mountPoint.querySelector(".event-stripe-submit");
          submitBtn.addEventListener("click", async () => {
            submitBtn.disabled = true;
            submitBtn.textContent = "Behandler...";
            const errEl = document.getElementById("topup-stripe-error-msg");
            if (errEl) errEl.textContent = "";

            const { error: stripeError, paymentIntent } = await stripe.confirmPayment({
              elements,
              confirmParams: {},
              redirect: "if_required",
            });

            if (stripeError) {
              if (errEl) errEl.textContent = stripeError.message || "Betaling mislykkedes.";
              submitBtn.disabled = false;
              submitBtn.textContent = "Betal nu";
              return;
            }

            if (paymentIntent && paymentIntent.status === "succeeded") {
              submitBtn.textContent = "Bekræfter...";
              try {
                const confirmRes = await fetch(CONFIRM_TOPUP_URL, {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                    apikey: SUPABASE_ANON_KEY,
                    Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
                  },
                  body: JSON.stringify({
                    child_id: currentChildId,
                    parent_pin: currentParentPin,
                    payment_intent_id: paymentIntent.id,
                  }),
                });
                const confirmData = await confirmRes.json();

                if (confirmRes.ok && confirmData.success) {
                  overlay.remove();
                  const nb = confirmData.new_balance;
                  if (typeof nb === "number") {
                    eventsChildBalance = nb;
                    const balanceEl = document.getElementById("balance-display") || document.querySelector(".balance-amount");
                    if (balanceEl) balanceEl.textContent = nb.toFixed(2) + " kr";
                    updateBalanceStatus(nb);
                  }
                  await refreshParentView();
                  if (paymentFeedback) {
                    paymentFeedback.textContent = "Optankning gennemført!";
                    paymentFeedback.style.color = "var(--success-color)";
                  }
                } else {
                  if (errEl) errEl.textContent = confirmData.error || "Kunne ikke bekræfte optankning.";
                  submitBtn.disabled = false;
                  submitBtn.textContent = "Prøv igen";
                }
              } catch (confirmErr) {
                console.error("confirm-topup fejl:", confirmErr);
                if (errEl) errEl.textContent = "Netværksfejl ved bekræftelse. Betalingen er gennemført — kontakt personalet.";
              }
            } else {
              if (errEl) errEl.textContent = "Betaling blev ikke gennemført.";
              submitBtn.disabled = false;
              submitBtn.textContent = "Betal nu";
            }
          });
        } catch (err) {
          console.error("handleTopupStripePayment fejl:", err);
          mountPoint.innerHTML = '<p class="event-stripe-error">Fejl ved indlæsning af betaling. Prøv igen.</p>';
        }
      }

      // Collapsible section toggle functionality with accordion behavior
      function setupCollapsibleSections() {
        // List of all collapsible section IDs - iterate through each one individually
        const sectionIds = [
          "email-notification-collapsible",
          "history-collapsible",
          "events-collapsible",
          "payment-collapsible",
          "club-limitations-collapsible",
          "daily-assortment-collapsible",
          "spending-limit-collapsible",
          "product-limit-collapsible",
          "sugar-policy-collapsible",
          "allergens-collapsible",
          "change-pin-collapsible"
        ];
        
        // Track if we've already set up listeners to avoid duplicate setup
        if (window.collapsibleSectionsSetup) {
          // Already set up, just return
          return;
        }
        window.collapsibleSectionsSetup = true;
        
        // Set up each section individually with its specific ID stored in closure
        sectionIds.forEach((sectionId) => {
          const container = document.getElementById(sectionId);
          if (!container) return;
          
          const header = container.querySelector(".collapsible-section-header");
          if (!header) return;
          
          // Remove any existing listener by cloning
          const newHeader = header.cloneNode(true);
          header.parentNode.replaceChild(newHeader, header);
          
          // Get fresh references after clone
          const freshContainer = document.getElementById(sectionId);
          if (!freshContainer) return;
          
          const freshHeader = freshContainer.querySelector(".collapsible-section-header");
          if (!freshHeader) return;
          
          // Store the section ID in the closure - CRITICAL to ensure isolation
          const thisSectionId = sectionId;
          
          // Add event listener to THIS specific header only
          // Use a flag to prevent multiple rapid clicks from causing issues
          let isToggling = false;
          
          freshHeader.addEventListener("click", function(e) {
            // Prevent event bubbling and multiple triggers
            e.preventDefault();
            e.stopPropagation();
            e.stopImmediatePropagation();
            
            // Prevent multiple rapid clicks
            if (isToggling) {
              return;
            }
            isToggling = true;
            
            // CRITICAL: Use the specific section ID from the closure
            const thisContainer = document.getElementById(thisSectionId);
            if (!thisContainer || thisContainer.id !== thisSectionId) {
              isToggling = false;
              return;
            }
            
            const thisHeader = thisContainer.querySelector(".collapsible-section-header");
            const thisContent = thisContainer.querySelector(".collapsible-section-content");
            const thisArrow = thisHeader?.querySelector(".collapsible-section-arrow");
            
            if (!thisHeader || !thisContent) {
              isToggling = false;
              return;
            }

            // Check if this section is currently active BEFORE doing anything
            const isActive = thisHeader.classList.contains("active");
            
            // ACCORDION BEHAVIOR: Close all other sections before opening this one
            if (!isActive) {
              // Step 1: Close all other sections first
              sectionIds.forEach((otherSectionId) => {
                if (otherSectionId === thisSectionId) return; // Skip current section
                
                const otherContainer = document.getElementById(otherSectionId);
                if (!otherContainer) return;
                
                const otherHeader = otherContainer.querySelector(".collapsible-section-header");
                const otherContent = otherContainer.querySelector(".collapsible-section-content");
                const otherArrow = otherHeader?.querySelector(".collapsible-section-arrow");
                
                if (otherHeader && otherContent && otherHeader.classList.contains("active")) {
                  // Only close if they are currently active
                  otherHeader.classList.remove("active");
                  otherContent.classList.remove("active");
                  if (otherArrow) otherArrow.textContent = "▼";
                }
              });
              
              // Step 2: Now open this section
              // Double-check it's still not active (shouldn't be, but be safe)
              if (!thisHeader.classList.contains("active")) {
                thisHeader.classList.add("active");
                thisContent.classList.add("active");
                if (thisArrow) thisArrow.textContent = "▲";
              }
            } else {
              // This section is active, so close it
              thisHeader.classList.remove("active");
              thisContent.classList.remove("active");
              if (thisArrow) thisArrow.textContent = "▼";
            }
            
            // Reset flag after a short delay to allow the DOM to update
            setTimeout(() => {
              isToggling = false;
            }, 50);
          }, false);
        });
      }

      // ===== PRODUKTGRÆNSER FUNKTIONER =====
      let productLimitProducts = [];
      let productLimitSettings = new Map(); // productId -> max_per_day (null = ubegrænset)
      let institutionProductLimits = new Map(); // productId -> max_per_day fra institutionen

      async function loadProductLimits(institutionId, childId) {
        const listEl = document.getElementById("product-limit-list");
        if (!listEl) return;

        console.log("[loadProductLimits] START via Edge Function", { institutionId, childId });
        listEl.innerHTML = '<div class="product-limit-empty">Indlæser produkter...</div>';

        try {
          // Brug Edge Function i stedet for direkte Supabase query (løser RLS-problemer på mobil)
          const res = await fetch(GET_PRODUCTS_URL, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              apikey: SUPABASE_ANON_KEY,
              Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
            },
            body: JSON.stringify({
              institution_id: institutionId,
              child_id: childId,
            }),
          });

          const data = await res.json().catch(() => ({}));
          console.log("[loadProductLimits] Edge Function response:", { status: res.status, data });

          if (!res.ok) {
            console.error("Fejl fra Edge Function:", data);
            listEl.innerHTML = `<div class="product-limit-empty">Kunne ikke indlæse produkter. (${data.error || 'ukendt fejl'})</div>`;
            return;
          }

          productLimitProducts = data.products || [];

          if (productLimitProducts.length === 0) {
            console.warn("[loadProductLimits] Ingen produkter fra Edge Function");
            listEl.innerHTML = '<div class="product-limit-empty">Ingen aktive produkter fundet.</div>';
            return;
          }

          // Sæt institutionens produktgrænser
          institutionProductLimits.clear();
          (data.institution_limits || []).forEach(row => {
            if (row.max_per_day != null && row.max_per_day > 0) {
              institutionProductLimits.set(row.product_id, row.max_per_day);
            }
          });

          // Sæt barnets produktgrænser
          productLimitSettings.clear();
          (data.child_limits || []).forEach(row => {
            productLimitSettings.set(row.product_id, row.max_per_day);
          });

          renderProductLimitList();
          wireProductLimitEvents();

        } catch (err) {
          console.error("Uventet fejl ved indlæsning af produktgrænser:", err);
          listEl.innerHTML = '<div class="product-limit-empty">Uventet fejl opstod.</div>';
        }
      }

      function renderProductLimitList() {
        const listEl = document.getElementById("product-limit-list");
        const searchInput = document.getElementById("product-limit-search");
        const showModifiedCheckbox = document.getElementById("product-limit-show-modified");

        if (!listEl) return;

        const searchTerm = (searchInput?.value || "").toLowerCase().trim();
        const showOnlyModified = showModifiedCheckbox?.checked || false;

        let filteredProducts = productLimitProducts;

        // Filtrering
        if (searchTerm) {
          filteredProducts = filteredProducts.filter(p =>
            (p.name || "").toLowerCase().includes(searchTerm)
          );
        }

        if (showOnlyModified) {
          // Vis kun produkter med en grænse sat (ikke -1 = ubegrænset)
          filteredProducts = filteredProducts.filter(p =>
            productLimitSettings.has(p.id) && productLimitSettings.get(p.id) !== -1
          );
        }

        if (filteredProducts.length === 0) {
          listEl.innerHTML = '<div class="product-limit-empty">Ingen produkter matcher din søgning.</div>';
          return;
        }

        listEl.innerHTML = filteredProducts.map(product => {
          const childLimit = productLimitSettings.has(product.id) ? productLimitSettings.get(product.id) : -1;
          const instLimit = institutionProductLimits.get(product.id);
          const isModified = productLimitSettings.has(product.id) && productLimitSettings.get(product.id) !== -1;
          // -1 = Ubegrænset, 0 = Blokeret, 1-99 = Grænse
          const displayValue = childLimit === -1 ? "Ubegrænset" : (childLimit === 0 ? "Blokeret" : `${childLimit}/dag`);
          const valueClass = childLimit === 0 ? "is-zero" : (childLimit === -1 ? "is-unlimited" : "");

          // Vis institutionsgrænse hvis den findes
          let instLimitNote = "";
          if (instLimit != null) {
            instLimitNote = `<span style="font-size: 9px; color: #9ca3af;">(Klub: maks ${instLimit})</span>`;
          }

          // Produktikon
          let iconHtml = "";
          if (product.icon_url) {
            iconHtml = `<img src="${product.icon_url}" alt="${product.name}" class="product-limit-item-icon" style="object-fit: contain;" />`;
          } else {
            iconHtml = `<div class="product-limit-item-icon">${product.emoji || "🛒"}</div>`;
          }

          return `
            <div class="product-limit-item ${isModified ? 'is-modified' : ''}" data-product-id="${product.id}">
              <div class="product-limit-item-info">
                ${iconHtml}
                <div class="product-limit-item-details">
                  <div class="product-limit-item-name">${product.name || "Ukendt"}</div>
                  <div class="product-limit-item-price">${product.price ? product.price.toFixed(2) + " kr." : ""} ${instLimitNote}</div>
                </div>
              </div>
              <div class="product-limit-stepper" data-product-id="${product.id}">
                <button type="button" class="stepper-dec" title="Mindre">−</button>
                <span class="product-limit-stepper-value ${valueClass}">${displayValue}</span>
                <button type="button" class="stepper-inc" title="Mere">+</button>
              </div>
            </div>
          `;
        }).join("");
      }

      let productLimitEventsWired = false;
      function wireProductLimitEvents() {
        if (productLimitEventsWired) return; // Undgå dobbelt-binding
        productLimitEventsWired = true;

        const listEl = document.getElementById("product-limit-list");
        const searchInput = document.getElementById("product-limit-search");
        const filterToggle = document.getElementById("product-limit-filter-toggle");
        const showModifiedCheckbox = document.getElementById("product-limit-show-modified");
        const saveBtn = document.getElementById("save-product-limits-btn");
        const feedback = document.getElementById("product-limit-feedback");

        // Søgning
        if (searchInput) {
          searchInput.addEventListener("input", () => {
            renderProductLimitList();
          });
        }

        // Filter toggle
        if (filterToggle && showModifiedCheckbox) {
          filterToggle.addEventListener("click", () => {
            showModifiedCheckbox.checked = !showModifiedCheckbox.checked;
            filterToggle.classList.toggle("is-active", showModifiedCheckbox.checked);
            renderProductLimitList();
          });
        }

        // Stepper controls (event delegation)
        if (listEl) {
          listEl.addEventListener("click", (e) => {
            const btn = e.target.closest(".stepper-dec, .stepper-inc");
            if (!btn) return;

            const stepper = btn.closest(".product-limit-stepper");
            const productId = stepper?.dataset.productId;
            if (!productId) return;

            const currentValue = productLimitSettings.has(productId) ? productLimitSettings.get(productId) : -1;
            const isInc = btn.classList.contains("stepper-inc");

            // Logik (loop begge veje):
            // dec: -1 → 5 → 4 → 3 → 2 → 1 → 0 → -1
            // inc: -1 → 0 → 1 → 2 → 3 → 4 → 5 → -1
            let newValue;
            if (currentValue === -1) {
              // Ubegrænset: dec → 5, inc → 0
              newValue = isInc ? 0 : 5;
            } else if (currentValue === 0) {
              // Blokeret: dec → -1 (Ubegrænset), inc → 1
              newValue = isInc ? 1 : -1;
            } else if (currentValue === 5) {
              // Maks: dec → 4, inc → -1 (Ubegrænset)
              newValue = isInc ? -1 : 4;
            } else {
              // Normal værdi 1-4: +/- 1
              newValue = isInc ? currentValue + 1 : currentValue - 1;
            }

            productLimitSettings.set(productId, newValue);

            renderProductLimitList();
            if (feedback) feedback.textContent = "";
          });
        }

        // Gem knap
        if (saveBtn) {
          saveBtn.addEventListener("click", async () => {
            await saveProductLimits();
          });
        }
      }

      async function saveProductLimits() {
        const saveBtn = document.getElementById("save-product-limits-btn");
        const feedback = document.getElementById("product-limit-feedback");

        if (!currentChildId || !currentInstitutionId) {
          if (feedback) feedback.textContent = "Fejl: Mangler barn eller institution.";
          return;
        }

        if (saveBtn) saveBtn.disabled = true;
        if (feedback) feedback.textContent = "Gemmer...";

        try {
          // Byg limits array fra Map (filtrer -1 ud, da det betyder "ubegrænset/ingen grænse")
          const limits = [];
          productLimitSettings.forEach((maxPerDay, productId) => {
            if (maxPerDay !== -1) {
              limits.push({ product_id: productId, max_per_day: maxPerDay });
            }
          });

          // Kald Edge Function (bypasser RLS sikkert med PIN-verifikation)
          const response = await fetch(`${SUPABASE_URL}/functions/v1/save-parent-limits`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "apikey": SUPABASE_ANON_KEY,
              "Authorization": `Bearer ${SUPABASE_ANON_KEY}`,
            },
            body: JSON.stringify({ child_id: currentChildId, parent_pin: currentParentPin, limits }),
          });

          const result = await response.json();

          if (!response.ok || !result.success) {
            throw new Error(result.error || "Kunne ikke gemme grænser.");
          }

          if (feedback) {
            feedback.textContent = "Gemt ✅";
            feedback.style.color = "#16a34a";
          }

          // Clear feedback efter 3 sekunder
          setTimeout(() => {
            if (feedback) feedback.textContent = "";
          }, 3000);

        } catch (err) {
          console.error("Fejl ved gemning af produktgrænser:", err);
          if (feedback) {
            feedback.textContent = "Fejl ved gemning. Prøv igen.";
            feedback.style.color = "#dc2626";
          }
        } finally {
          if (saveBtn) saveBtn.disabled = false;
        }
      }

      // ===== SUKKERPOLITIK FUNKTIONER =====
      let currentSugarPolicy = null;

      function loadSugarPolicy() {
        const enabledCheckbox = document.getElementById("sugar-policy-enabled");
        const blockCheckbox = document.getElementById("sugar-block-unhealthy");
        const maxPerDayInput = document.getElementById("sugar-max-per-day");
        const maxPerProductInput = document.getElementById("sugar-max-per-product");

        if (!enabledCheckbox || !blockCheckbox || !maxPerDayInput || !maxPerProductInput) return;

        // Indlæs fra get-parent-view response (gemt i currentSugarPolicy)
        if (currentSugarPolicy) {
          // enabled = true hvis feltet er sat, ellers default false
          enabledCheckbox.checked = currentSugarPolicy.enabled === true;
          blockCheckbox.checked = currentSugarPolicy.block_unhealthy === true;
          // Vis tom for null/0 (= ingen grænse)
          const maxDay = currentSugarPolicy.max_unhealthy_per_day;
          const maxProduct = currentSugarPolicy.max_unhealthy_per_product_per_day;
          maxPerDayInput.value = (maxDay != null && maxDay > 0) ? maxDay : "";
          maxPerProductInput.value = (maxProduct != null && maxProduct > 0) ? maxProduct : "";
        } else {
          enabledCheckbox.checked = false;
          blockCheckbox.checked = false;
          maxPerDayInput.value = "";
          maxPerProductInput.value = "";
        }

        updateSugarInputsState();
      }

      function updateSugarInputsState() {
        const enabledCheckbox = document.getElementById("sugar-policy-enabled");
        const controlsContainer = document.getElementById("sugar-policy-controls");
        const blockCheckbox = document.getElementById("sugar-block-unhealthy");
        const limitsContainer = document.getElementById("sugar-limits-container");
        const maxPerDayInput = document.getElementById("sugar-max-per-day");
        const maxPerProductInput = document.getElementById("sugar-max-per-product");

        if (!enabledCheckbox || !controlsContainer) return;

        // Vis/skjul controls baseret på enabled
        const isEnabled = enabledCheckbox.checked;
        controlsContainer.style.display = isEnabled ? "block" : "none";

        // Hvis enabled, håndter block checkbox og limits
        if (isEnabled && blockCheckbox && limitsContainer) {
          if (blockCheckbox.checked) {
            limitsContainer.style.opacity = "0.5";
            if (maxPerDayInput) maxPerDayInput.disabled = true;
            if (maxPerProductInput) maxPerProductInput.disabled = true;
          } else {
            limitsContainer.style.opacity = "1";
            if (maxPerDayInput) maxPerDayInput.disabled = false;
            if (maxPerProductInput) maxPerProductInput.disabled = false;
          }
        }
      }

      async function saveSugarPolicy() {
        const enabledCheckbox = document.getElementById("sugar-policy-enabled");
        const blockCheckbox = document.getElementById("sugar-block-unhealthy");
        const maxPerDayInput = document.getElementById("sugar-max-per-day");
        const maxPerProductInput = document.getElementById("sugar-max-per-product");
        const feedback = document.getElementById("sugar-policy-feedback");
        const saveBtn = document.getElementById("save-sugar-policy-btn");

        if (!currentChildId || !currentParentPin) {
          if (feedback) {
            feedback.textContent = "Fejl: Mangler login-information.";
            feedback.style.color = "#dc2626";
          }
          return;
        }

        const isEnabled = enabledCheckbox?.checked === true;

        // Hvis deaktiveret, sæt alle begrænsninger til null/false
        const payload = {
          child_id: currentChildId,
          parent_pin: currentParentPin,
          enabled: isEnabled,
          block_unhealthy: isEnabled ? (blockCheckbox?.checked === true) : false,
          max_unhealthy_per_day: isEnabled && maxPerDayInput?.value ? parseInt(maxPerDayInput.value, 10) : null,
          max_unhealthy_per_product_per_day: isEnabled && maxPerProductInput?.value ? parseInt(maxPerProductInput.value, 10) : null,
        };

        if (saveBtn) saveBtn.disabled = true;

        try {
          const res = await fetch(SAVE_SUGAR_POLICY_URL, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              apikey: SUPABASE_ANON_KEY,
              Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
            },
            body: JSON.stringify(payload),
          });

          const data = await res.json();
          if (data.success) {
            if (feedback) {
              feedback.textContent = "Sukkerpolitik gemt!";
              feedback.style.color = "#16a34a";
            }
            // Opdater lokal state
            currentSugarPolicy = {
              enabled: payload.enabled,
              block_unhealthy: payload.block_unhealthy,
              max_unhealthy_per_day: payload.max_unhealthy_per_day,
              max_unhealthy_per_product_per_day: payload.max_unhealthy_per_product_per_day,
            };
          } else {
            if (feedback) {
              feedback.textContent = data.error || "Kunne ikke gemme.";
              feedback.style.color = "#dc2626";
            }
          }
        } catch (e) {
          console.error("[saveSugarPolicy] Error:", e);
          if (feedback) {
            feedback.textContent = "Netværksfejl. Prøv igen.";
            feedback.style.color = "#dc2626";
          }
        } finally {
          if (saveBtn) saveBtn.disabled = false;
          setTimeout(() => { if (feedback) feedback.textContent = ""; }, 3000);
        }
      }

      // Event listeners for sukkerpolitik
      document.getElementById("sugar-policy-enabled")?.addEventListener("change", updateSugarInputsState);
      document.getElementById("sugar-block-unhealthy")?.addEventListener("change", updateSugarInputsState);
      document.getElementById("save-sugar-policy-btn")?.addEventListener("click", saveSugarPolicy);

      // Ryd felt når værdi går til 0 eller under (vis "Ingen grænse" placeholder)
      function handleSugarLimitInput(e) {
        const val = parseInt(e.target.value, 10);
        if (val <= 0 || isNaN(val)) {
          e.target.value = "";
        }
      }
      document.getElementById("sugar-max-per-day")?.addEventListener("input", handleSugarLimitInput);
      document.getElementById("sugar-max-per-product")?.addEventListener("input", handleSugarLimitInput);

      async function loadInstitutionPreferences(institutionId) {
        if (!institutionId) return null;
        try {
          // Brug Edge Function i stedet for direkte Supabase query (løser RLS-problemer)
          // OBS: Dette kræver at get-parent-view Edge Function returnerer institutions data
          // eller at der oprettes en separat Edge Function til at hente institutions preferences
          // For nu prøver vi direkte query med bedre fejlhåndtering
          const { data, error } = await supabase
            .from("institutions")
            .select("*")
            .eq("id", institutionId)
            .single();

          if (error) {
            console.warn("Kunne ikke hente institutions-præferencer:", error);
            // Hvis RLS blokerer, returner tomt objekt så UI stadig virker
            // (betalingssektionen vil vise "midlertidigt utilgængelig")
            return {};
          }
          return data || null;
        } catch (e) {
          console.warn("Uventet fejl ved hentning af institutions-præferencer:", e);
          return {};
        }
      }

      // Hent og vis klubbens begrænsninger (daglig grænse og produkter med købsgrænse)
      async function loadAndRenderClubLimitations(institutionId, prefs) {
        const clubLimitationsCollapsible = document.getElementById("club-limitations-collapsible");
        const clubLimitationsCard = document.getElementById("club-limitations-card");
        const dailyLimitItem = document.getElementById("club-daily-limit-item");
        const dailyLimitValue = document.getElementById("club-daily-limit");
        const productLimitsItem = document.getElementById("club-product-limits-item");
        const productLimitsContainer = document.getElementById("club-product-limits");
        const clubLimitationsFallback = document.getElementById("club-limitations-fallback");

        if (!clubLimitationsCard || !clubLimitationsCollapsible) return;

        // Hent daglig grænse fra institutionens prefs
        const spendingLimitEnabled = prefs && (prefs.spending_limit_enabled === true || prefs.spending_limit_enabled === "true" || prefs.spending_limit_enabled === 1 || prefs.spending_limit_enabled === "1");
        const spendingLimitAmount = prefs && prefs.spending_limit_amount ? Number(prefs.spending_limit_amount) : null;

        if (spendingLimitEnabled && spendingLimitAmount && spendingLimitAmount > 0) {
          dailyLimitItem.style.display = "block";
          dailyLimitValue.textContent = `${spendingLimitAmount} kr.`;
        } else {
          dailyLimitItem.style.display = "none";
        }

        // Hent produkter med købsgrænse fra product_limits tabellen
        try {
          // Først: Hent product_limits
          const { data: productLimits, error: productLimitsError } = await supabase
            .from("product_limits")
            .select("product_id, max_per_day")
            .eq("institution_id", institutionId)
            .gt("max_per_day", 0);

          if (productLimitsError) {
            console.warn("Kunne ikke hente produkter med købsgrænse:", productLimitsError);
            productLimitsItem.style.display = "none";
          } else if (productLimits && productLimits.length > 0) {
            // Derefter: Hent produkter for de fundne product_ids
            const productIds = productLimits.map((pl) => pl.product_id);
            const { data: products, error: productsError } = await supabase
              .from("products")
              .select("id, name, price")
              .in("id", productIds)
              .eq("is_enabled", true)
              .order("name", { ascending: true });

            if (productsError) {
              console.warn("Kunne ikke hente produktdetaljer:", productsError);
              productLimitsItem.style.display = "none";
            } else if (products && products.length > 0) {
              // Match products med deres limits
              const limitMap = new Map();
              productLimits.forEach((pl) => {
                limitMap.set(pl.product_id, pl.max_per_day);
              });

              productLimitsItem.style.display = "block";
              productLimitsContainer.innerHTML = "";

              products.forEach((product) => {
                const maxPerDay = limitMap.get(product.id);
                if (!maxPerDay) return;

                const productItem = document.createElement("div");
                productItem.className = "product-item";
                const price = product.price ? Number(product.price).toFixed(0) : "0";
                const productName = escapeHtml(product.name);
                productItem.innerHTML = `
                  <span class="product-name">${productName}</span> – ${price} kr. Maks. <strong>${maxPerDay} stk.</strong> pr. dag
                `;
                productLimitsContainer.appendChild(productItem);
              });
            } else {
              productLimitsItem.style.display = "none";
            }
          } else {
            productLimitsItem.style.display = "none";
          }
        } catch (e) {
          console.warn("Uventet fejl ved hentning af produkter med købsgrænse:", e);
          productLimitsItem.style.display = "none";
        }

        // Vis collapsible sektionen også hvis der ikke er begrænsninger
        const hasAnyLimitations =
          (dailyLimitItem.style.display !== "none") ||
          (productLimitsItem.style.display !== "none");
        if (clubLimitationsFallback) {
          clubLimitationsFallback.style.display = hasAnyLimitations ? "none" : "block";
        }
        if (clubLimitationsCollapsible) {
          clubLimitationsCollapsible.style.display = "block";
        }
      }

      // Hent og vis dagens sortiment (produkter med is_visible = true)
      async function loadAndRenderDailyAssortment(institutionId) {
        const dailyAssortmentCollapsible = document.getElementById("daily-assortment-collapsible");
        const dailyAssortmentCard = document.getElementById("daily-assortment-card");
        const dailyAssortmentList = document.getElementById("daily-assortment-list");

        if (!dailyAssortmentCard || !dailyAssortmentList || !dailyAssortmentCollapsible) return;

        try {
          // Hent produkter der er synlige og aktive i dagens sortiment
          const { data: products, error: productsError } = await supabase
            .from("products")
            .select("id, name, price, emoji, sort_order")
            .eq("institution_id", institutionId)
            .eq("is_enabled", true)
            .neq("is_visible", false)
            .order("sort_order", { ascending: true });

          if (productsError) {
            console.warn("Kunne ikke hente dagens sortiment:", productsError);
            dailyAssortmentCollapsible.style.display = "none";
          } else if (products && products.length > 0) {
            dailyAssortmentCollapsible.style.display = "block";
            dailyAssortmentList.innerHTML = "";

            products.forEach((product) => {
              const productItem = document.createElement("div");
              productItem.className = "daily-assortment-item";
              const price = product.price ? Number(product.price).toFixed(0) : "0";
              const productName = escapeHtml(product.name);
              const emoji = product.emoji || "❓";
              
              productItem.innerHTML = `
                <span class="product-emoji">${emoji}</span>
                <span class="product-name">${productName}</span>
                <span class="product-price">${price} kr.</span>
              `;
              dailyAssortmentList.appendChild(productItem);
            });
          } else {
            // Vis kortet selv om der ingen produkter er
            dailyAssortmentCollapsible.style.display = "block";
            dailyAssortmentList.innerHTML = '<div class="daily-assortment-empty">Ingen produkter i dagens sortiment i øjeblikket.</div>';
          }
        } catch (e) {
          console.warn("Uventet fejl ved hentning af dagens sortiment:", e);
          dailyAssortmentCollapsible.style.display = "none";
        }
      }

      // Hjælpefunktion til at escape HTML
      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      const balanceStatusLabel = document.getElementById("balance-status-label");
      const balanceDisplay = document.getElementById("balance-display");

      function collectAllergySettingsFromUI() {
        const map = new Map(); // allergen -> policy

        allergyButtons.forEach((btn) => {
          const allergen = btn.dataset.allergen;
          if (!allergen) return;

          if (btn.classList.contains("is-active-allow")) {
            map.set(allergen, "allow");
          } else if (btn.classList.contains("is-active-warn")) {
            map.set(allergen, "warn");
          } else if (btn.classList.contains("is-active-block")) {
            map.set(allergen, "block");
          }
        });

        return Array.from(map.entries()).map(([allergen, policy]) => ({
          allergen,
          policy,
        }));
      }

      function setAllergyPolicyInUI(allergenKey, policy) {
        // Først: fjern aktive klasser for alle tre knapper i denne allergi-gruppe
        allergyButtons.forEach((btn) => {
          if (btn.dataset.allergen !== allergenKey) return;
          btn.classList.remove("is-active-allow", "is-active-warn", "is-active-block");
        });

        // Derefter: find den knap der matcher policy og giv den en tydelig aktiv tilstand
        allergyButtons.forEach((btn) => {
          if (btn.dataset.allergen !== allergenKey) return;
          if (btn.dataset.policy !== policy) return;

          if (policy === "allow") {
            btn.classList.add("is-active-allow");
          } else if (policy === "warn") {
            btn.classList.add("is-active-warn");
          } else if (policy === "block") {
            btn.classList.add("is-active-block");
          }
        });
      }

      function applyAllergySettingsFromData(allergySettings) {
        if (!allergySettings || !Array.isArray(allergySettings)) {
          // Default: mark all as "Tillad" i UI
          const uniqueAllergens = new Set();
          allergyButtons.forEach((btn) => {
            uniqueAllergens.add(btn.dataset.allergen);
          });
          uniqueAllergens.forEach((key) => {
            setAllergyPolicyInUI(key, "allow");
          });
          return;
        }

        // allergySettings forventes at være en liste af { allergen: string, policy: 'allow'|'warn'|'block' }
        const seen = new Set();
        allergySettings.forEach((entry) => {
          if (!entry || !entry.allergen || !entry.policy) return;
          seen.add(entry.allergen);
          setAllergyPolicyInUI(entry.allergen, entry.policy);
        });

        // Alt hvad vi ikke har data for → "allow" i UI
        allergyButtons.forEach((btn) => {
          const key = btn.dataset.allergen;
          if (!seen.has(key)) {
            setAllergyPolicyInUI(key, "allow");
          }
        });
      }

     async function loadAllergySettingsForChild(childId) {
  if (!childId) return;
  try {
    const res = await fetch(
      `${GET_ALLERGY_URL}?child_id=${encodeURIComponent(childId)}`,
      {
        method: "GET",
        headers: {
          apikey: SUPABASE_ANON_KEY,
          Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
        },
      }
    );

    if (!res.ok) {
      console.warn("Kunne ikke hente allergi-indstillinger (HTTP):", res.status);
      return;
    }

    const data = await res.json().catch(() => ({}));
    if (!data || data.success === false) {
      console.warn("Kunne ikke hente allergi-indstillinger:", data && data.error);
      return;
    }

    if (data.settings && Array.isArray(data.settings)) {
      applyAllergySettingsFromData(data.settings);
    }
  } catch (err) {
    console.error("Netværksfejl ved hentning af allergier:", err);
  }
}

      allergyButtons.forEach((btn) => {
        btn.addEventListener("click", () => {
          const allergenKey = btn.dataset.allergen;
          const policy = btn.dataset.policy;
          setAllergyPolicyInUI(allergenKey, policy);
          // Her kan du senere tilføje kald til Supabase Edge Function for at gemme valget.
        });
      });

      // Quick-valg til daglig beløbsgrænse (20, 30, 40, 50 kr.)
      if (dailyLimitChips && dailyLimitChips.length) {
        dailyLimitChips.forEach((chip) => {
          chip.addEventListener("click", () => {
            const amount = chip.dataset.amount;
            if (dailyLimitInput) {
              dailyLimitInput.value = amount || "";
              dailyLimitInput.focus();
            }

            dailyLimitChips.forEach((c) => c.classList.remove("is-active"));
            chip.classList.add("is-active");

            if (dailyLimitFeedback) {
              dailyLimitFeedback.textContent = "";
            }
          });
        });
      }

      if (saveAllergyBtn) {
        saveAllergyBtn.addEventListener("click", async () => {
          if (!currentChildId) {
            allergyFeedback.textContent = "Fejl: Log ind først.";
            allergyFeedback.style.color = "#dc3545";
            return;
          }

          const settings = collectAllergySettingsFromUI();

          saveAllergyBtn.disabled = true;
          const originalText = saveAllergyBtn.textContent;
          saveAllergyBtn.textContent = "Gemmer...";
          allergyFeedback.textContent = "";

          try {
            const res = await fetch(SAVE_ALLERGY_URL, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                apikey: SUPABASE_ANON_KEY,
                Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
              },
              body: JSON.stringify({
                child_id: currentChildId,
                allergy_settings: settings,
              }),
            });

            const data = await res.json().catch(() => ({}));

            if (!res.ok || data.success === false) {
              allergyFeedback.textContent =
                data.error || "Fejl: Kunne ikke gemme allergier.";
              allergyFeedback.style.color = "#dc3545";
              return;
            }

            allergyFeedback.textContent = "Allergi-indstillinger er gemt.";
            allergyFeedback.style.color = "#16a34a";
          } catch (err) {
            console.error("Fejl ved gemning af allergier:", err);
            allergyFeedback.textContent =
              "Fejl: Kunne ikke gemme. Prøv igen.";
            allergyFeedback.style.color = "#dc3545";
          } finally {
            saveAllergyBtn.disabled = false;
            saveAllergyBtn.textContent = originalText;
          }
        });
      }

      if (saveDailyLimitBtn) {
        saveDailyLimitBtn.addEventListener("click", async () => {
          if (!currentChildId) {
            if (dailyLimitFeedback) {
              dailyLimitFeedback.textContent = "Fejl: Log ind først.";
              dailyLimitFeedback.style.color = "#dc3545";
            }
            return;
          }

          if (!dailyLimitInput) return;

          const raw = (dailyLimitInput.value || "").trim();
          if (!raw) {
            if (dailyLimitFeedback) {
              dailyLimitFeedback.textContent = "Skriv et beløb i kroner.";
              dailyLimitFeedback.style.color = "#dc3545";
            }
            return;
          }

          const parsed = Number(raw.replace(",", "."));
          if (!Number.isFinite(parsed) || parsed < 0) {
            if (dailyLimitFeedback) {
              dailyLimitFeedback.textContent = "Beløbet skal være et tal på mindst 0 kr.";
              dailyLimitFeedback.style.color = "#dc3545";
            }
            return;
          }

          const limit = Math.round(parsed);

          saveDailyLimitBtn.disabled = true;
          const originalText = saveDailyLimitBtn.textContent;
          saveDailyLimitBtn.textContent = "Gemmer...";
          if (dailyLimitFeedback) dailyLimitFeedback.textContent = "";

          try {
            const res = await fetch(SAVE_DAILY_LIMIT_URL, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                apikey: SUPABASE_ANON_KEY,
                Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
              },
              body: JSON.stringify({
                child_id: currentChildId,
                daily_spend_limit: limit, // forventes at være i kroner pr. dag
              }),
            });

            const data = await res.json().catch(() => ({}));

            if (!res.ok || data.success === false) {
              if (dailyLimitFeedback) {
                dailyLimitFeedback.textContent =
                  data.error || "Fejl: Kunne ikke gemme beløbsgrænsen.";
                dailyLimitFeedback.style.color = "#dc3545";
              }
              return;
            }

            if (dailyLimitFeedback) {
              dailyLimitFeedback.textContent = "Beløbsgrænsen er gemt.";
              dailyLimitFeedback.style.color = "#16a34a";
            }
          } catch (err) {
            console.error("Fejl ved gemning af daglig beløbsgrænse:", err);
            if (dailyLimitFeedback) {
              dailyLimitFeedback.textContent =
                "Fejl: Kunne ikke gemme beløbsgrænsen. Prøv igen.";
              dailyLimitFeedback.style.color = "#dc3545";
            }
          } finally {
            saveDailyLimitBtn.disabled = false;
            saveDailyLimitBtn.textContent = originalText;
          }
        });
      }

      loadInstitutions();

      async function loadInstitutions() {
        try {
          const { data, error } = await supabase
            .from("institutions")
            .select("id, name")
            .order("name", { ascending: true });
      
          if (error) {
            console.error("Fejl ved hentning af institutioner", error);
            return;
          }
      
          // Ingen institutioner
          if (!data || data.length === 0) {
            institutionSelect.innerHTML =
              '<option value="">Ingen institutioner tilgængelige</option>';
            if (institutionRow) institutionRow.style.display = "block";
            if (institutionInfo) {
              institutionInfo.style.display = "none";
              if (institutionNameLabel) institutionNameLabel.textContent = "";
            }
            return;
          }
      
          // KUN én institution (fx Stampen) → auto-vælg + skjul dropdown
          if (data.length === 1) {
            const inst = data[0];
      
            // Sæt select til kun denne institution
            institutionSelect.innerHTML = `<option value="${inst.id}">${inst.name}</option>`;
            institutionSelect.value = inst.id;
            institutionSelect.disabled = false; // Sørg for at dropdownen er aktiv

            // Vis dropdown-rækken og skift label-teksten til det, du ønsker
            if (institutionRow) institutionRow.style.display = "block";
            if (institutionLabel) institutionLabel.textContent = "Institutioner i nærheden af dig:";

            // Skjul den alternative info-tekst
            if (institutionInfo) institutionInfo.style.display = "none";

            return;
          }
      
          // FLERE institutioner → almindelig dropdown
          const options =
            '<option value="">Vælg klub/SFO…</option>' +
            data
              .map(
                (inst) =>
                  `<option value="${inst.id}">${inst.name}</option>`
              )
              .join("");
      
          institutionSelect.innerHTML = options;
          institutionSelect.disabled = false; // Sørg for at den er aktiv
      
          // Sørg for at dropdown vises, og info-teksten skjules
          if (institutionRow) institutionRow.style.display = "block";
          if (institutionLabel) institutionLabel.textContent = "Vælg klub/SFO";
          if (institutionInfo) institutionInfo.style.display = "none";
        } catch (e) {
          console.error("Uventet fejl ved hentning af institutioner", e);
        }
      }
      loginForm.addEventListener("submit", async (event) => {
        event.preventDefault();
        loginError.style.display = "none";

        const institutionId = institutionSelect.value;
        currentInstitutionId = institutionId;
        const nameInput = document
          .getElementById("child-name-input")
          .value.trim();
        const parentPin = document
          .getElementById("parent-pin-input")
          .value.trim();

        if (!institutionId) {
          loginError.textContent = "Vælg først klub/SFO.";
          loginError.style.display = "block";
          return;
        }

        if (!nameInput || !parentPin) {
          loginError.textContent = "Udfyld navn og kode.";
          loginError.style.display = "block";
          return;
        }

        loginBtn.disabled = true;
        loginBtn.textContent = "Logger ind...";

        try {
          const res = await fetch(FUNCTION_URL, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              apikey: SUPABASE_ANON_KEY,
              Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
            },
            body: JSON.stringify({
              institution_id: institutionId,
              name_input: nameInput,
              parent_pin: parentPin,
            }),
          });

          const data = await res.json().catch(() => ({}));

          if (!res.ok) {
            console.log("Fejl fra server:", data);

            if (data.error_code === "MULTIPLE_MATCHES") {
              loginError.textContent =
                "Der er flere børn med dette navn. Skriv barnets fulde navn.";
            } else if (data.error) {
              loginError.textContent = data.error;
            } else {
              loginError.textContent =
                "Forkert navn eller kode. Tjek navn + kode og prøv igen.";
            }

            loginError.style.display = "block";
            return;
          }

          displayResults(data);
          currentParentPin = parentPin; // Gem PIN til senere brug (produktgrænser)
          // Gem allowed_children fra response
          if (data.allowed_children && Array.isArray(data.allowed_children)) {
            allowedChildren = data.allowed_children;
            renderChildSwitcher(allowedChildren);
          }
          // Hent institutions-præferencer og render betalingsmuligheder + funktioner
          // Prøv først at bruge institutions data fra get-parent-view response
          if (data.institution) {
            currentInstitutionPrefs = data.institution;
            console.log('[parent-portal] Institutions data fra get-parent-view:', data.institution);
            console.log('[parent-portal] parent_portal_payment:', data.institution.parent_portal_payment);
          } else {
            console.warn('[parent-portal] Ingen institutions data i response, henter via fallback');
            // Fallback: hent via loadInstitutionPreferences
            currentInstitutionPrefs = await loadInstitutionPreferences(institutionId);
          }
          console.log('[parent-portal] Rendering payment section med prefs:', currentInstitutionPrefs);
          renderPaymentSection(currentInstitutionPrefs || {});
          renderFeatureSections(currentInstitutionPrefs || {});
          // Hent og vis klubbens begrænsninger
          await loadAndRenderClubLimitations(institutionId, currentInstitutionPrefs);
          // Hent og vis dagens sortiment
          await loadAndRenderDailyAssortment(institutionId);
          // Hent og vis kommende arrangementer
          loadAndRenderEvents(currentChildId, currentParentPin);
          // Setup collapsible functionality - kald efter en lille delay for at sikre DOM er klar
          setTimeout(() => setupCollapsibleSections(), 100);
        } catch (err) {
          console.error("Fetch-fejl:", err);
          loginError.textContent =
            "Der opstod en netværksfejl. Prøv igen eller kontakt SFO’en.";
          loginError.style.display = "block";
        } finally {
          loginBtn.disabled = false;
          loginBtn.textContent = "Se saldo og historik";
        }
      });

      // Email login handler
      if (emailLoginForm) {
        emailLoginForm.addEventListener("submit", async (event) => {
          event.preventDefault();
          emailLoginError.style.display = "none";
          emailLoginSuccess.style.display = "none";

          const email = document.getElementById("parent-email-login-input").value.trim();

          if (!email) {
            emailLoginError.textContent = "Indtast din e-mail.";
            emailLoginError.style.display = "block";
            return;
          }

          emailLoginBtn.disabled = true;
          emailLoginBtn.textContent = "Sender...";

          try {
            const { error } = await supabase.auth.signInWithOtp({
              email: email,
              options: {
                emailRedirectTo: window.location.origin + window.location.pathname,
              },
            });

            if (error) {
              emailLoginError.textContent = error.message || "Kunne ikke sende magic link.";
              emailLoginError.style.display = "block";
            } else {
              emailLoginSuccess.style.display = "block";
              emailLoginForm.reset();
            }
          } catch (err) {
            console.error("Email login fejl:", err);
            emailLoginError.textContent = "Der opstod en fejl. Prøv igen.";
            emailLoginError.style.display = "block";
          } finally {
            emailLoginBtn.disabled = false;
            emailLoginBtn.textContent = "Send magic link";
          }
        });
      }

      // Tjek om bruger er logget ind via email (magic link)
      supabase.auth.onAuthStateChange(async (event, session) => {
        if (event === "SIGNED_IN" && session?.user?.email) {
          // Find alle børn hvor denne email er registreret i parent_notifications
          try {
            const { data: notifications, error } = await supabase
              .from("parent_notifications")
              .select("user_id, email")
              .eq("email", session.user.email);

            if (error) {
              console.error("Fejl ved hentning af børn:", error);
              return;
            }

            if (!notifications || notifications.length === 0) {
              alert("Ingen børn fundet for denne e-mail. Kontakt klubben.");
              await supabase.auth.signOut();
              return;
            }

            // Hvis flere børn, vis picker
            if (notifications.length > 1) {
              // TODO: Implementér child picker for email login
              alert("Flere børn fundet. Vælg barn:");
              // For nu: brug første barn
              const firstChildId = notifications[0].user_id;
              await switchToChildViaEmail(firstChildId, session.user.email);
            } else {
              // Ét barn: log ind automatisk
              const childId = notifications[0].user_id;
              await switchToChildViaEmail(childId, session.user.email);
            }
          } catch (err) {
            console.error("Fejl ved email login flow:", err);
          }
        }
      });

      async function switchToChildViaEmail(childId, email) {
        // Hent child data og institution
        try {
          const { data: child, error: childError } = await supabase
            .from("users")
            .select("id, name, institution_id, balance, daily_spend_limit")
            .eq("id", childId)
            .maybeSingle();

          if (childError || !child) {
            alert("Kunne ikke finde barn.");
            return;
          }

          // Hent PIN fra parent_notifications (hvis gemt) eller prompt bruger
          // For nu: brug en placeholder - i produktion skal PIN hentes eller promptes
          // Dette er en begrænsning: email login kræver stadig PIN for at få adgang til allowed_children
          // Vi kan ikke bruge email login direkte til at få adgang uden PIN
          // Så vi logger brugeren ind på første barn, men de skal stadig indtaste PIN for at få fuld adgang
          alert("Email login er delvist implementeret. Brug kode-login for fuld adgang.");
        } catch (err) {
          console.error("Fejl ved switchToChildViaEmail:", err);
        }
      }

      // Link sibling handler
      if (linkSiblingBtn) {
        linkSiblingBtn.addEventListener("click", () => {
          openLinkSiblingModal();
        });
      }

      function openLinkSiblingModal() {
        const overlay = document.createElement("div");
        overlay.className = "modal-overlay";
        overlay.style.cssText = "position:fixed;inset:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999;padding:20px;box-sizing:border-box;";
        
        overlay.innerHTML = `
          <div class="event-payment-modal" style="background:var(--card-bg, #fff);border-radius:16px;padding:24px;max-width:480px;width:100%;box-shadow:0 18px 45px rgba(15,23,42,0.18);box-sizing:border-box;">
            <h3 style="margin:0 0 12px 0;">Tilknyt barn</h3>
            <p style="font-size:14px;color:#666;margin:0 0 16px 0;">
              Skriv den unikke kode til barnet, som du har modtaget på Aula – eller få den udleveret i klubbens café.
            </p>
            <input
              type="text"
              id="sibling-code-input"
              placeholder="Indtast kode"
              style="width:100%;padding:12px;border:1px solid #ddd;border-radius:8px;font-size:16px;margin-bottom:12px;text-transform:uppercase;"
              maxlength="8"
            />
            <p id="link-sibling-error" class="error-message" style="display:none;margin-bottom:12px;"></p>
            <div style="display:flex;gap:8px;justify-content:flex-end;">
              <button type="button" class="cancel-btn" id="link-sibling-cancel-btn">Annuller</button>
              <button type="button" class="confirm-btn" id="link-sibling-preview-btn">Fortsæt</button>
            </div>
          </div>
        `;

        document.body.appendChild(overlay);

        const codeInput = overlay.querySelector("#sibling-code-input");
        const errorEl = overlay.querySelector("#link-sibling-error");
        const cancelBtn = overlay.querySelector("#link-sibling-cancel-btn");
        const previewBtn = overlay.querySelector("#link-sibling-preview-btn");

        const close = () => overlay.remove();

        cancelBtn.addEventListener("click", close);
        overlay.addEventListener("click", (e) => {
          if (e.target === overlay) close();
        });

        previewBtn.addEventListener("click", async () => {
          const code = codeInput.value.trim().toUpperCase();
          if (!code) {
            errorEl.textContent = "Indtast en kode.";
            errorEl.style.display = "block";
            return;
          }

          previewBtn.disabled = true;
          previewBtn.textContent = "Tjekker...";
          errorEl.style.display = "none";

          try {
            const res = await fetch(LINK_SIBLING_URL, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                apikey: SUPABASE_ANON_KEY,
                Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
              },
              body: JSON.stringify({
                action: "preview",
                current_child_id: currentChildId,
                parent_pin: currentParentPin,
                sibling_code: code,
              }),
            });

            const preview = await res.json();

            if (!res.ok) {
              errorEl.textContent = preview.error || "Kunne ikke finde barn med denne kode.";
              errorEl.style.display = "block";
              previewBtn.disabled = false;
              previewBtn.textContent = "Fortsæt";
              return;
            }

            // Vis bekræftdialog
            const confirmed = await showLinkSiblingConfirmDialog(preview);
            if (!confirmed) {
              previewBtn.disabled = false;
              previewBtn.textContent = "Fortsæt";
              return;
            }

            // Bekræft linking
            const confirmRes = await fetch(LINK_SIBLING_URL, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                apikey: SUPABASE_ANON_KEY,
                Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
              },
              body: JSON.stringify({
                action: "confirm",
                current_child_id: currentChildId,
                parent_pin: currentParentPin,
                sibling_child_id: preview.child_id,
              }),
            });

            const confirmData = await confirmRes.json();

            if (!confirmRes.ok) {
              errorEl.textContent = confirmData.error || "Kunne ikke tilknytte barn.";
              errorEl.style.display = "block";
              previewBtn.disabled = false;
              previewBtn.textContent = "Fortsæt";
              return;
            }

            // Success - refresh view
            close();
            await refreshParentView();
            alert("Barn tilknyttet!");
          } catch (err) {
            console.error("Link sibling fejl:", err);
            errorEl.textContent = "Netværksfejl. Prøv igen.";
            errorEl.style.display = "block";
            previewBtn.disabled = false;
            previewBtn.textContent = "Fortsæt";
          }
        });

        // Enter key på input
        codeInput.addEventListener("keydown", (e) => {
          if (e.key === "Enter") {
            previewBtn.click();
          }
        });

        setTimeout(() => codeInput.focus(), 100);
      }

      function showLinkSiblingConfirmDialog(preview) {
        return new Promise((resolve) => {
          const overlay = document.createElement("div");
          overlay.className = "modal-overlay";
          overlay.style.cssText = "position:fixed;inset:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:10000;padding:20px;box-sizing:border-box;";

          const contactPhone = currentInstitutionPrefs?.parent_contact_phone_enabled
            ? currentInstitutionPrefs?.parent_contact_phone
            : null;

          const gradeYearText = preview.grade_year ? ` (Årgang ${preview.grade_year})` : "";
          const contactText = contactPhone
            ? ` Hvis ikke, kontakt klubben på ${contactPhone}.`
            : "";

          overlay.innerHTML = `
            <div class="event-payment-modal" style="background:var(--card-bg, #fff);border-radius:16px;padding:24px;max-width:480px;width:100%;box-shadow:0 18px 45px rgba(15,23,42,0.18);box-sizing:border-box;">
              <h3 style="margin:0 0 12px 0;">Bekræft tilknytning</h3>
              <p style="font-size:14px;color:#333;margin:0 0 16px 0;line-height:1.5;">
                Bekræft at <strong>${preview.child_name}${gradeYearText}</strong> er dit barn.${contactText}
              </p>
              <div style="display:flex;gap:8px;justify-content:flex-end;">
                <button type="button" class="cancel-btn" id="confirm-link-cancel-btn">Annuller</button>
                <button type="button" class="confirm-btn" id="confirm-link-ok-btn">Bekræft</button>
              </div>
            </div>
          `;

          document.body.appendChild(overlay);

          const cancelBtn = overlay.querySelector("#confirm-link-cancel-btn");
          const okBtn = overlay.querySelector("#confirm-link-ok-btn");

          const close = (value) => {
            overlay.remove();
            resolve(value);
          };

          cancelBtn.addEventListener("click", () => close(false));
          okBtn.addEventListener("click", () => close(true));
          overlay.addEventListener("click", (e) => {
            if (e.target === overlay) close(false);
          });
        });
      }

      // Child switcher functionality
      function renderChildSwitcher(children) {
        if (!childSwitcher || !Array.isArray(children) || children.length <= 1) {
          if (childSwitcher) childSwitcher.style.display = "none";
          return;
        }

        childSwitcher.style.display = "block";
        childSwitcherSelect.innerHTML = children
          .map(
            (child) => `
            <option value="${child.child_id}" ${child.child_id === currentChildId ? 'selected' : ''}>
              ${child.child_name}${child.child_id === currentChildId ? ' (aktiv)' : ''} - ${(child.balance || 0).toFixed(2)} kr
            </option>
          `
          )
          .join("");

        // Remove existing listener
        const newSelect = childSwitcherSelect.cloneNode(true);
        childSwitcherSelect.parentNode.replaceChild(newSelect, childSwitcherSelect);

        newSelect.addEventListener("change", async (e) => {
          const newChildId = e.target.value;
          if (newChildId !== currentChildId) {
            await switchToChild(newChildId);
          }
        });
      }

      async function switchToChild(childId) {
        if (!currentInstitutionId || !currentParentPin) {
          alert("Manglende login-information.");
          return;
        }

        try {
          const res = await fetch(FUNCTION_URL, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              apikey: SUPABASE_ANON_KEY,
              Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
            },
            body: JSON.stringify({
              institution_id: currentInstitutionId,
              child_id: childId, // Brug child_id i stedet for name_input
              parent_pin: currentParentPin,
            }),
          });

          const data = await res.json();

          if (!res.ok) {
            alert(data.error || "Kunne ikke skifte barn.");
            return;
          }

          displayResults(data);
          // Opdater allowed_children
          if (data.allowed_children && Array.isArray(data.allowed_children)) {
            allowedChildren = data.allowed_children;
            renderChildSwitcher(allowedChildren);
          }
          // Refresh events
          if (currentChildId && currentParentPin) {
            loadAndRenderEvents(currentChildId, currentParentPin);
          }
        } catch (err) {
          console.error("Switch child fejl:", err);
          alert("Netværksfejl ved skift af barn.");
        }
      }

      logoutBtn.addEventListener("click", () => {
        loginView.style.display = "block";
        resultsView.style.display = "none";
        loginForm.reset();
        loginError.style.display = "none";

        notifyFeedback.textContent = "";
        parentEmailInput.value = "";
        notifyZeroCheckbox.checked = false;
        notifyTenCheckbox.checked = false;

        // Nulstil allergi/limits UI
        if (allergyFeedback) allergyFeedback.textContent = "";
        if (dailyLimitFeedback) dailyLimitFeedback.textContent = "";
        if (dailyLimitInput) dailyLimitInput.value = "";
        if (dailyLimitChips && dailyLimitChips.length) {
          dailyLimitChips.forEach((chip) => chip.classList.remove("is-active"));
        }

        currentInstitutionId = null;
        currentInstitutionPrefs = null;
        currentChildName = null;
        selectedTopupAmount = null;
        if (paymentFeedback) paymentFeedback.textContent = "";
        if (paymentQrWrap) paymentQrWrap.style.display = "none";
        if (paymentGrid) paymentGrid.innerHTML = "";
        if (paymentCard) paymentCard.style.display = "none";
        // Nulstil events
        const eventsCollapsible = document.getElementById("events-collapsible");
        const eventsList = document.getElementById("events-list");
        const eventsFeedback = document.getElementById("events-feedback");
        if (eventsCollapsible) eventsCollapsible.style.display = "none";
        if (eventsList) eventsList.innerHTML = "";
        if (eventsFeedback) eventsFeedback.innerHTML = "";
        eventsChildBalance = 0;

        currentChildId = null;
        currentParentPin = null;
        allowedChildren = [];
        if (childSwitcher) childSwitcher.style.display = "none";
      });

      if (changePinForm) {
        changePinForm.addEventListener("submit", async (event) => {
          event.preventDefault();
          if (!changePinMessage) return;

          changePinMessage.style.display = "none";
          changePinMessage.textContent = "";
          changePinMessage.style.color = "";

          const newPin = newPinInput.value.trim();
          const confirmPin = confirmNewPinInput.value.trim();

          if (!currentChildId) {
            changePinMessage.textContent =
              "Der opstod en fejl. Prøv at logge ind igen og forsøg derefter at skifte kode.";
            changePinMessage.style.color = "var(--danger-color)";
            changePinMessage.style.display = "block";
            return;
          }

          if (!newPin || !confirmPin) {
            changePinMessage.textContent = "Udfyld begge felter.";
            changePinMessage.style.color = "var(--danger-color)";
            changePinMessage.style.display = "block";
            return;
          }

          if (newPin !== confirmPin) {
            changePinMessage.textContent =
              "De to nye koder er ikke ens. Prøv igen.";
            changePinMessage.style.color = "var(--danger-color)";
            changePinMessage.style.display = "block";
            return;
          }

          if (newPin.length < 4) {
            changePinMessage.textContent =
              "Koden skal mindst være på 4 tegn.";
            changePinMessage.style.color = "var(--danger-color)";
            changePinMessage.style.display = "block";
            return;
          }

          try {
            const res = await fetch(UPDATE_PIN_URL, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                apikey: SUPABASE_ANON_KEY,
                Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
              },
              body: JSON.stringify({
                child_id: currentChildId,
                new_pin: newPin,
                source: 'parent', // Mark this change as coming from a parent
              }),
            });

            const data = await res.json();

            if (!res.ok || !data.success) {
              console.error("Fejl ved skift af kode:", data);
              throw new Error(data.error || "Der opstod en fejl under skift af kode. Prøv igen.");
            }

            changePinMessage.textContent = "Din kode er nu opdateret.";
            changePinMessage.style.color = "var(--success-color)";
            changePinMessage.style.display = "block";
            newPinInput.value = "";
            confirmNewPinInput.value = "";
          } catch (e) {
            console.error("Uventet fejl ved skift af kode:", e);
            changePinMessage.textContent = "Uventet fejl. Prøv igen lidt senere.";
            changePinMessage.style.color = "var(--danger-color)";
            changePinMessage.style.display = "block";
          }
        });
      }

      saveNotifyBtn.addEventListener("click", async () => {
        if (!currentChildId) {
          notifyFeedback.textContent = "Fejl: Ingen barnedata indlæst.";
          notifyFeedback.style.color = "#dc3545";
          return;
        }

        const email = parentEmailInput.value.trim();
        const notifyAtZero = notifyZeroCheckbox.checked;
        const notifyAtTen = notifyTenCheckbox.checked;

        if (!email) {
          notifyFeedback.textContent = "Indtast venligst en e-mailadresse.";
          notifyFeedback.style.color = "#dc3545";
          return;
        }

        saveNotifyBtn.disabled = true;
        saveNotifyBtn.textContent = "Gemmer...";

        try {
          const res = await fetch(SAVE_NOTIFY_URL, {
  method: "POST",
  headers: {
    "Content-Type": "application/json",
    apikey: SUPABASE_ANON_KEY,
    // VIGTIGT: til Edge Functions med Verify JWT
    Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
  },
  body: JSON.stringify({
    child_id: currentChildId,
    email: email,
    notify_at_zero: notifyAtZero,
    notify_at_ten: notifyAtTen,
  }),
});

          const data = await res.json().catch(() => ({}));

          if (!res.ok || data.success === false) {
            notifyFeedback.textContent = data.error || "Fejl: Kunne ikke gemme.";
            notifyFeedback.style.color = "#dc3545";
            return;
          }

          notifyFeedback.textContent = "Dine indstillinger er gemt!";
          notifyFeedback.style.color = "#28a745";
        } catch (err) {
          console.error("Fejl ved gemning af notifikationer:", err);
          notifyFeedback.textContent = "Fejl: Kunne ikke gemme. Prøv igen.";
          notifyFeedback.style.color = "#dc3545";
        } finally {
          saveNotifyBtn.disabled = false;
          saveNotifyBtn.textContent = "Gem e-mail-beskeder";
        }
      });

      function updateBalanceStatus(balance) {
        const b = Number(balance) || 0;

        balanceDot.classList.remove("low", "negative");
        if (b <= 0) {
          balanceDot.classList.add("negative");
          balanceStatusLabel.textContent = "Saldo under 0 kr.";
        } else if (b <= 10) {
          balanceDot.classList.add("low");
          balanceStatusLabel.textContent = "Lav saldo";
        } else {
          balanceStatusLabel.textContent = "OK saldo";
        }
      }

      function displayResults(data) {
        currentChildId = data.child_id || null;
        currentChildName = data.child_name || null;
        // Gem allowed_children fra response
        if (data.allowed_children && Array.isArray(data.allowed_children)) {
          allowedChildren = data.allowed_children;
          renderChildSwitcher(allowedChildren);
        }
        // Gem sukkerpolitik fra response
        currentSugarPolicy = data.sugar_policy ?? null;
        // Hvis vi har institutions data fra get-parent-view response, brug det
        if (data.institution) {
          currentInstitutionPrefs = data.institution;
          console.log('[displayResults] Bruger institutions data fra get-parent-view response');
          renderPaymentSection(currentInstitutionPrefs);
          renderFeatureSections(currentInstitutionPrefs);
          // Hent og vis klubbens begrænsninger
          loadAndRenderClubLimitations(currentInstitutionId, currentInstitutionPrefs);
          // Hent og vis dagens sortiment
          loadAndRenderDailyAssortment(currentInstitutionId);
          // Setup collapsible functionality - kald efter en lille delay for at sikre DOM er klar
          setTimeout(() => setupCollapsibleSections(), 100);
        } else if (currentInstitutionPrefs) {
          // Hvis vi allerede har institutionspræferencer (fra tidligere kald), så brug dem
          console.log('[displayResults] Bruger eksisterende currentInstitutionPrefs');
          renderPaymentSection(currentInstitutionPrefs);
          renderFeatureSections(currentInstitutionPrefs);
          // Hent og vis klubbens begrænsninger
          loadAndRenderClubLimitations(currentInstitutionId, currentInstitutionPrefs);
          // Hent og vis dagens sortiment
          loadAndRenderDailyAssortment(currentInstitutionId);
          // Setup collapsible functionality - kald efter en lille delay for at sikre DOM er klar
          setTimeout(() => setupCollapsibleSections(), 100);
        } else if (currentInstitutionId) {
          // Fallback: hent via loadInstitutionPreferences (kan fejle pga RLS)
          console.warn('[displayResults] Ingen institutions data i response, prøver fallback');
          loadInstitutionPreferences(currentInstitutionId).then((prefs) => {
            if (prefs && Object.keys(prefs).length > 0) {
              currentInstitutionPrefs = prefs;
              renderPaymentSection(currentInstitutionPrefs);
              renderFeatureSections(currentInstitutionPrefs);
              // Hent og vis klubbens begrænsninger
              loadAndRenderClubLimitations(currentInstitutionId, currentInstitutionPrefs);
              // Hent og vis dagens sortiment
              loadAndRenderDailyAssortment(currentInstitutionId);
              // Setup collapsible functionality - kald efter en lille delay for at sikre DOM er klar
              setTimeout(() => setupCollapsibleSections(), 100);
            } else {
              console.warn('[displayResults] Fallback returnerede tomt objekt, ignorerer');
            }
          });
        }

        if (currentChildId && typeof loadAllergySettingsForChild === "function") {
          loadAllergySettingsForChild(currentChildId);
        }

        document.getElementById("child-name-display").textContent =
          data.child_name || "";
        const balance =
          typeof data.balance === "number"
            ? data.balance
            : Number(data.balance || 0);
        balanceDisplay.textContent = balance.toFixed(2) + " kr";
        updateBalanceStatus(balance);

        const historyList = document.getElementById("history-list");
        historyList.innerHTML = "";

        if (!data.history || data.history.length === 0) {
          const li = document.createElement("li");
          li.textContent = "Ingen historik fundet.";
          li.style.fontSize = "14px";
          li.style.color = "#6b7280";
          li.style.padding = "6px 2px";
          historyList.appendChild(li);
        } else {
          data.history.forEach((item) => {
            const li = document.createElement("li");
            li.className = "history-item";

            const date = new Date(item.date).toLocaleDateString("da-DK", {
              day: "2-digit",
              month: "short",
              year: "numeric",
            });

            const main = document.createElement("div");
            main.className = "history-main";

            const descRow = document.createElement("div");
            descRow.className = "history-row";

            const dateEl = document.createElement("div");
            dateEl.className = "history-date";
            dateEl.textContent = date;

            const typeEl = document.createElement("div");
            typeEl.className = "history-type";
            typeEl.textContent = item.type === "SALE" ? "Køb" : "Optankning";

            descRow.appendChild(dateEl);
            descRow.appendChild(typeEl);

            const desc = document.createElement("div");
            desc.className = "history-desc";
            desc.textContent = item.description || "";

            const meta = document.createElement("div");
            meta.className = "history-meta";
            meta.textContent = item.meta || "";

            main.appendChild(descRow);
            main.appendChild(desc);
            if (item.meta) main.appendChild(meta);

            const amountEl = document.createElement("div");
            amountEl.className = "history-amount";

            if (typeof item.amount === "number") {
              const amount = item.amount.toFixed(2) + " kr";
              amountEl.textContent = amount;

              if (item.type === "SALE") {
                amountEl.classList.add("sale");
              } else if (item.type === "DEPOSIT") {
                amountEl.classList.add("deposit");
              }
            } else {
              amountEl.textContent = "";
            }

            li.appendChild(main);
            li.appendChild(amountEl);
            historyList.appendChild(li);
          });
        }

        notifyFeedback.textContent = "";
        if (data.notification_settings) {
          const ns = data.notification_settings;
          parentEmailInput.value = ns.email || "";
          notifyZeroCheckbox.checked = !!ns.notify_at_zero;
          notifyTenCheckbox.checked = !!ns.notify_at_ten;
          if (ns.email) {
            notifyFeedback.textContent = "Tidligere indstillinger er indlæst.";
            notifyFeedback.style.color = "#28a745";
          }
        } else {
          parentEmailInput.value = "";
          notifyZeroCheckbox.checked = false;
          notifyTenCheckbox.checked = false;
        }

        // Daglig beløbsgrænse (valgfri) – forventer at backend evt. sender `daily_spend_limit` i kroner
        if (dailyLimitInput) {
          const limitRaw = data.daily_spend_limit;
          if (limitRaw !== undefined && limitRaw !== null && !isNaN(Number(limitRaw))) {
            const limit = Number(limitRaw);
            dailyLimitInput.value = limit.toString();

            if (dailyLimitChips && dailyLimitChips.length) {
              dailyLimitChips.forEach((chip) => {
                chip.classList.remove("is-active");
                if (Number(chip.dataset.amount) === limit) {
                  chip.classList.add("is-active");
                }
              });
            }

            if (dailyLimitFeedback) {
              dailyLimitFeedback.textContent = "";
            }
          } else {
            dailyLimitInput.value = "";
            if (dailyLimitChips && dailyLimitChips.length) {
              dailyLimitChips.forEach((chip) => chip.classList.remove("is-active"));
            }
            if (dailyLimitFeedback) {
              dailyLimitFeedback.textContent = "";
            }
          }
        }

        // Allergi-indstillinger (valgfrit felt fra backend)
        if (typeof applyAllergySettingsFromData === "function") {
          applyAllergySettingsFromData(data.allergy_settings || null);
        }

        loginView.style.display = "none";
        resultsView.style.display = "block";
      }
    });
  </script>
</body>
</html>
</html>
